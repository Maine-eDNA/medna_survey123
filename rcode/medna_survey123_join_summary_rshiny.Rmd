---
title: "Maine-eDNA Survey123 Summary"
author: "Melissa Kimble"
runtime: shiny
output: html_document
---

Prepared by: Melissa Kimble



This notebook:
1. Loads Survey123 data
2. Generates SiteID summaries

* add in all YSI sonde measurements
* eg par1, par2, turbidity, do, conductivity, water temp
* add map versions of each of these

* geom_sf
* bubble plots with siteid
* add map of regions

# LOAD LIBRARIES 
```{r, echo=FALSE, results="hide", messages=FALSE, warning=FALSE}
# Load and Install Libraries
source("medna_survey123.R")
## Check libraries & install
LibraryList<-c("data.table","dplyr","lubridate","stringr","ggplot2","scales", 
               "zoo", "tidyr", "gridExtra", "rgdal", "googlesheets4", "viridis", 
               "shiny", "leaflet", "spdplyr", "raster", "sf", "rgeos",
               "rmapshaper", "DT", "shinythemes", "shinyWidgets")
install_or_load_pack(LibraryList)

```

# LOAD PROJECT VARIABLES
```{r, echo=FALSE, results="hide", messages=FALSE, warning=FALSE}
overwrite = FALSE
inputFolder = "../data/02_Working/PyOutput/"
originalFolder = "../data/01_Original/"
outputFolder = "../data/02_Working/ROutput/"
outputPngFolder = "../figures/rcode/"
InputShpFolder = "G:/My Drive/Dissertation/01_Data/"

todaysDateFn = format(Sys.Date(), "%Y%m%d")

# Projection
WGS84_SRID = 4326
```


# LOAD SHAPFILES
```{r, echo=FALSE, results="hide", messages=FALSE, warning=FALSE}
# Watershed Boundary Dataset (WBD), National Hydrography Dataset (NHD), United States Geological Survey (USGS)
InputWbdShpFolder = paste0(InputShpFolder,"02_Working/Hydrography/USGS_NHD/20200615/WBDHU8_MENH_NEaq/")
WBDHU8SHP_simplified_filename = "WBDHU8_MENH_NEA_simplified"
WBDHU8SHP_simplified = paste0(InputWbdShpFolder,WBDHU8SHP_simplified_filename,".shp")
if (!file.exists(WBDHU8SHP_simplified) | overwrite) {
  WBDHU8SHP = paste0(InputShpFolder,"/02_Working/Hydrography/USGS_NHD/20200615/WBDHU8_MENH_NEaq/WBDHU8_MENH_NEA.shp")
  WBD_spdf<-rgdal::readOGR(WBDHU8SHP)
  #names(WBD_spdf)
  WBD_spdf_simplified <- rmapshaper::ms_simplify(WBD_spdf) 
  
  class(WBD_spdf_simplified)
  
  rm(WBD_spdf, WBDHU8SHP)
  # write to shapefile
  raster::shapefile(WBD_spdf_simplified, WBDHU8SHP_simplified)
} else {
  WBD_spdf_simplified<-rgdal::readOGR(WBDHU8SHP_simplified)
}
#rgdal::ogrListLayers(WBD_spdf_simplified)
centers_wbd <- data.frame(rgeos::gCentroid(WBD_spdf_simplified, byid = TRUE))
centers_wbd$region_cod <- WBD_spdf_simplified$region_cod

boundingbox_wbd<-raster::extent(WBD_spdf_simplified@bbox)
```

## Set map colors
```{r, echo=FALSE, results="hide", messages=FALSE}
regionPal <- colorFactor("Set3", as.factor(WBD_spdf_simplified$region_cod))
existsPal <- colorFactor(c("antiquewhite", "forestgreen"), as.factor(c("Yes","No")))
```

# Survey123 Simplified Schema
```{r, echo=FALSE}
knitr::include_graphics("../figures/survey123_v14_simplified_erd.png")
```

## LOAD GSHEETs
```{r, echo=FALSE, results="hide", messages=FALSE}
# pre-select and grab oath
googlesheets4::gs4_auth("melissa.kimble@maine.edu")
# load gsheet
s123_gsheet_url = "https://docs.google.com/spreadsheets/d/1IVn6Ui80VZZrFjjRCy6FaOwh_5fR9ZJj4OxNypYBduc/edit?usp=sharing"
site_ids_gsheet <- googlesheets4::read_sheet(s123_gsheet_url, "SiteIDs")
survey_sub<-googlesheets4::read_sheet(s123_gsheet_url, "eDNA_Sampling_v14_sub")
survey_crew_join<-googlesheets4::read_sheet(s123_gsheet_url, "survey_crew_join")
survey_envmeas_join<-googlesheets4::read_sheet(s123_gsheet_url, "survey_envmeas_join")
survey_collection_join<-googlesheets4::read_sheet(s123_gsheet_url, "survey_collection_join")
clean_filter_join<-googlesheets4::read_sheet(s123_gsheet_url, "clean_filter_join")
clean_subcore_join<-googlesheets4::read_sheet(s123_gsheet_url, "clean_subcore_join")
```

## Column names and number of rows
```{r, echo=FALSE, results="hide", messages=FALSE}
# displays column names & number of rows - 6589
nrow(site_ids_gsheet);names(site_ids_gsheet)
nrow(survey_sub);names(survey_sub)
nrow(survey_envmeas_join);names(survey_envmeas_join)
nrow(survey_collection_join);names(survey_collection_join)
nrow(clean_filter_join);names(clean_filter_join)
nrow(clean_subcore_join);names(clean_subcore_join)
# Head displays the first 6 rows of the data.table
#head(survey_sub);head(survey_envmeas_join);head(survey_collection_join);head(clean_filter_join);head(clean_filter_join)
```


## Column names and number of rows
```{r, echo=FALSE, results="hide", messages=FALSE}
site_ids_spdf <- site_ids_gsheet %>%
  dplyr::select(SiteID, `General Location Name`, `Intended Purpose`, `Latitude`, `Longitude`, `System Type`, `Region Code`, 
         `Survey123 Filter Count`, `Survey123 Core Count`) %>%
  sf::st_as_sf(.,coords=c('Longitude', 'Latitude'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>% # reseparate out lat, long
  dplyr::rename(site_id = SiteID) %>%
  dplyr::rename(general_location_name = `General Location Name`) %>%
  dplyr::rename(projects = `Intended Purpose`) %>%
  dplyr::rename(system_type = `System Type`) %>%
  dplyr::rename(region_code = `Region Code`) %>%
  dplyr::rename(s123_filter_count = `Survey123 Filter Count`) %>%
  dplyr::rename(s123_core_count = `Survey123 Core Count`) %>%
  sf::as_Spatial()
# displays column names & number of rows - 65

site_id_prjs <- site_ids_gsheet %>%
  dplyr::select(SiteID, `Intended Purpose`)  %>%
  dplyr::rename(site_id = SiteID) %>%
  dplyr::rename(sid_prjs = `Intended Purpose`) %>%
  dplyr::add_row(site_id="Other", sid_prjs="Other")

boundingbox_sids<-raster::extent(site_ids_spdf@bbox)
rm(site_ids_gsheet)
```

## Add seasons to survey data
```{r}
# add seasons to survey_sub
survey_sub<-add_seasons_df(survey_sub)
# add seasons to survey_collection_join
survey_collection_join<-add_seasons_df(survey_collection_join)
# add seasons to survey_envmeas_join
survey_envmeas_join<-add_seasons_df(survey_envmeas_join)
# add seasons to clean_filter_join
clean_filter_join<-add_seasons_df(clean_filter_join)
# add seasons to clean_subcore_join
clean_subcore_join<-add_seasons_df(clean_subcore_join)
```

# SURVEY SUMMARY 
* Jun, Jul, Aug (Summer)
* Sep, Oct, Nov (Fall)
* Dec, Jan, Feb (Winter)
* Mar, Apr, May (Spring)
* records per season, records per year, records per month
* (count of survey records, count of filters, count of cores, count of environmental measurements), barcharts grouped or stacked by year per site

## Count of empty or NA site_ids
```{r}


# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank or NA Site IDs

nrow(survey_sub[survey_sub$site_id == "" | is.na(survey_sub$site_id),])

```

## Map and table of unique Site IDs with survey records
```{r, out.width = "100%", echo=FALSE}
shinyApp(
  ui = tagList(
    #shinythemes::themeSelector(), # interactive theme selector
    navbarPage(
      theme = shinytheme("flatly"),
      "Maine-eDNA Survey123 Summary",
      tabPanel("Navbar 1",
               bootstrapPage(
                 box(width="100%",leafletOutput("survey_sids_map")),
                 hr(style = "border-top: 1px solid #000000;width: 100%"),
                 box(width="100%",DT::dataTableOutput('survey_sids_table'))
                 ),
               ),
      tabPanel("Navbar 2", 
               bootstrapPage(tags$head(tags$style(HTML(".multicol {height: 175px;-webkit-column-count: 2;
                                                       -moz-column-count: 2;column-count: 2;
                                                       -moz-column-fill: auto;-column-fill: auto;}"))),
                 box(width="100%",plotOutput("survey_summary_plot")),
                 fluidRow(
                   column(3, selectInput("survey_summary_selectedplot", 
                                         label="Plot", 
                                         choices=c(
                                           "Barplot Records per Season" = "barSRSeason",
                                           "Barplot Records per Season and Year" = "barSRSeasonYear",
                                           "Barplot Records per Month and Year" = "barSRMonthYear",
                                           "Barplot Records per Site and Year" = "barSRSiteYear"), 
                                         selected="barSRSeason")),
                   column(9, tags$div(align = 'left', class = 'multicol',
                                      checkboxGroupInput("survey_summary_sids_selectedplot",
                                                         label="Projects",
                                                         inline = FALSE, 
                                                         choices=c(
                                                           "Larval Black Box (T1)" = "Larval Black Box (T1)",
                                                           "Alewife (T1)" = "Alewife (T1)",
                                                           "Fisheries eDNA (T1)" = "Fisheries eDNA (T1)",
                                                           "Harmful algal blooms (T2)" = "Harmful algal blooms (T2)",
                                                           "Species on the move (T2)" = "Species on the move (T2)",
                                                           "Index Sites (T3)" = "Index Sites (T3)",
                                                           "Macrosystem Integration (T3)" = "Macrosystem Integration (T3)",
                                                           "Microbial biosensors (T3)" = "Microbial biosensors (T3)",
                                                           "Community Science (T3)" = "Community Science (T3)",
                                                           "Other" = "Other"),
                                                         selected="Index Sites (T3)"))),
                   ),
                 hr(style = "border-top: 1px solid #000000;width: 100%"),
                 box(width="100%",DT::dataTableOutput('table'))
                 )),
      tabPanel("Navbar 3", "This panel is intentionally left blank")
      )
    ),
  server = function(input, output) {
    output$survey_sids_map <- renderLeaflet({
      leaflet() %>%
        addTiles() %>%
        setView(lng=-68.5, lat=44.0, zoom=7)
      })
    observe({
      selectPlot<-input$survey_summary_selectedplot
      selectedProjects<-input$survey_summary_sids_selectedplot
      
      # Subset df based on selected projects in plot view
      survey_sub_prj <- survey_sub %>%
        dplyr::mutate(projects=na_if(projects,"")) %>%
        dplyr::mutate(projects = replace_na(projects, "Maine eDNA")) %>%
        dplyr::left_join(site_id_prjs) %>%
        dplyr::filter(sid_prjs %in% selectedProjects) 

      ## SURVEY SUMMARY MAP SETUP
      rcdext_sids_all <- survey_sub %>%
        filter(!if_any(c(site_id), is.na)) %>%
        dplyr::select(site_id) %>%
        dplyr::filter(site_id!="other") %>%
        dplyr::distinct() %>%
        dplyr::left_join(as.data.frame(site_ids_spdf)) %>%
        dplyr::mutate(RecordsExist="Yes") %>%
        dplyr::select(site_id, RecordsExist) %>%
        dplyr::full_join(as.data.frame(site_ids_spdf)) %>%
        dplyr::mutate(RecordsExist = ifelse(is.na(RecordsExist), "No", RecordsExist)) %>%
        dplyr::select(site_id, general_location_name, RecordsExist, 
                      projects, system_type, region_code, s123_filter_count, 
                      s123_core_count, lon, lat) %>%
        dplyr::arrange(site_id) 
      
      rcdext_sids_other <- survey_sub %>%
        filter(!if_any(c(site_id), is.na)) %>%
        dplyr::filter(site_id=="other") %>%
        dplyr::filter(lat_manual>0 | long_manual>0) %>%
        dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
        dplyr::distinct() %>%
        dplyr::rename(lat=lat_manual) %>%
        dplyr::rename(lon=long_manual) %>%
        dplyr::mutate(RecordsExist="Yes") %>%
        dplyr::mutate(region_code="other") %>%
        dplyr::mutate(system_type="other") %>%
        dplyr::arrange(general_location_name)
      
      rcdext_sids_all_spdf <- rcdext_sids_all %>%
        sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
        dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
        tidyr::separate(geom, into=c("lon","lat"),sep=",") %>% # reseparate out lat, long
        sf::as_Spatial()
      
      if (nrow(rcdext_sids_other)>0) {
        rcdext_sids_other_spdf<-rcdext_sids_other %>% 
          sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
          dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
          tidyr::separate(geom, into=c("lon","lat"),sep=",") %>% # reseparate out lat, long
          sf::as_Spatial()
      }
        
      # SURVEY SUMMARY MAP TABLE
      output$survey_sids_table <- DT::renderDataTable({
        if (nrow(rcdext_sids_other)>0) {
          DT::datatable(rbind(data.table(rcdext_sids_all), data.table(rcdext_sids_other), fill=TRUE), options = list(scrollX = TRUE))
          } else {
            DT::datatable(as.data.frame(rcdext_sids_all), options = list(scrollX = TRUE))
            }
        })
      
      # SURVEY SUMMARY MAP
      sidsPopup <- sprintf(
        "<strong>%s: %s</strong><br/>Has environmental measurements: %s<br/>%s",
        rcdext_sids_all_spdf$site_id, rcdext_sids_all_spdf$general_location_name,
        rcdext_sids_all_spdf$RecordsExist, rcdext_sids_all_spdf$projects) %>% 
        lapply(htmltools::HTML)
      
      proxy <- leafletProxy("survey_sids_map")
      proxy %>%
        clearMarkers() %>%
        clearShapes() %>%
        clearPopups() %>%
        clearControls() %>%
        addPolygons(data=WBD_spdf_simplified, layerId=~region_cod,
                    fillColor="grey", fillOpacity=0.5, 
                    color="#444444", opacity=1,
                    weight=1,  dashArray="3",
                    group="Watersheds") %>%
            addLabelOnlyMarkers(data=centers_wbd, lng=~x, lat=~y, label=~region_cod,
                                labelOptions = labelOptions(noHide = TRUE, direction = 'middle', textOnly = TRUE),
                                group="Watersheds") %>%
            addCircleMarkers(data=rcdext_sids_all_spdf, layerId=~unique(site_id), 
                             fillColor=~existsPal(RecordsExist), fillOpacity=0.8, 
                             color="#444444", opacity=1, 
                             weight=1, radius=5, stroke=TRUE,
                             popup = sidsPopup,
                             group="Site IDs") %>%
        hideGroup("Watersheds") %>%
        addLegend(data=rcdext_sids_all_spdf, pal=existsPal, values=~RecordsExist, opacity = 1)
      if (nrow(rcdext_sids_other)>0) {
        oSidsPopup <- sprintf(
          "<strong>%s: %s</strong><br/>Has environmental measurements: %s<br/>%s",
          rcdext_sids_other_spdf$site_id, rcdext_sids_other_spdf$general_location_name,
          rcdext_sids_other_spdf$RecordsExist, rcdext_sids_other_spdf$projects) %>% 
          lapply(htmltools::HTML)
        proxy %>% addCircleMarkers(data=rcdext_sids_other_spdf, 
                             fillColor=~existsPal(RecordsExist), fillOpacity=0.8, 
                             color="#444444", opacity=1, 
                             weight=1, radius=5, stroke=TRUE,
                             popup = oSidsPopup,
                             group="Other Sites") %>%
          addLayersControl(
              overlayGroups = c("Watersheds", "Site IDs", "Other Sites"),
              options = layersControlOptions(collapsed = FALSE))
      } else {
        proxy %>%
          addLayersControl(
              overlayGroups = c("Watersheds", "Site IDs"),
              options = layersControlOptions(collapsed = FALSE))
      }
      
      # SURVEY SUMMARY TABLE
      output$table <- DT::renderDataTable({
        if (selectPlot == "barSRSeason") {
          DT::datatable(survey_sub_prj %>%
            filter(!if_any(c(survey_GlobalID, season), is.na)) %>%
            dplyr::select(survey_GlobalID, season) %>% 
            dplyr::group_by(season) %>%
            dplyr::count(season) %>%
            dplyr::mutate(perc=round((n/nrow(survey_sub_prj))*100, 2)), options = list(scrollX = TRUE))
        } else if (selectPlot == "barSRSeasonYear") {
          DT::datatable(survey_sub_prj %>%
            filter(!if_any(c(survey_GlobalID, season_year), is.na)) %>%
            dplyr::select(survey_GlobalID, season_year) %>% 
            dplyr::group_by(season_year) %>%
            dplyr::count(season_year) %>%
            dplyr::mutate(perc=round((n/nrow(survey_sub_prj))*100, 2)) %>%
            tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
            dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))) %>%
            dplyr::arrange(season, year), options = list(scrollX = TRUE))
        } else if (selectPlot == "barSRMonthYear") {
          DT::datatable(survey_sub_prj %>%
            filter(!if_any(c(survey_GlobalID, survey_date), is.na)) %>%
            dplyr::select(survey_GlobalID, survey_date) %>% 
            dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
            dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
            dplyr::group_by(survey_yrmo) %>%
            dplyr::count(survey_yrmo) %>%
            dplyr::mutate(perc=round((n/nrow(survey_sub_prj))*100, 2)) %>%
            tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
            dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", 
                                                        "Apr", "May", "Jun", 
                                                        "Jul", "Aug", "Sep", 
                                                        "Oct", "Nov", "Dec"))) %>%
            dplyr::arrange(month, year), options = list(scrollX = TRUE))
        } else if (selectPlot == "barSRSiteYear") {
          DT::datatable(survey_sub_prj %>%
                     filter(!if_any(c(survey_GlobalID, survey_date), is.na)) %>%
                     dplyr::select(survey_GlobalID, site_id, survey_year) %>% 
                     dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
                     dplyr::group_by(sid_year) %>%
                     dplyr::count(sid_year) %>%
                     dplyr::mutate(perc=round((n/nrow(survey_sub_prj))*100, 2)) %>%
                     tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
                     dplyr::left_join(as.data.frame(site_ids_spdf)) %>%
                     dplyr::select(site_id, general_location_name, year, n, perc) %>%
                     dplyr::arrange(site_id, year), options = list(scrollX = TRUE))
        } else return(NULL)
      })
      
      # SURVEY SUMMARY PLOTS
      output$survey_summary_plot <- renderPlot({
        if (selectPlot == "barSRSeason") {
          #outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_season_count_barplot.png")) 
          plotTitle = "Count of Survey Records by Season"
          ggplot(survey_sub_prj %>%
                   filter(!if_any(c(survey_GlobalID, season), is.na)) %>%
                   dplyr::select(survey_GlobalID, season) %>% 
                   dplyr::group_by(season) %>%
                   dplyr::count(season) %>%
                   dplyr::mutate(perc=round((n/nrow(survey_sub_prj))*100, 2)) %>%
                   dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))),
                 aes(season, n, fill=season)) +
            geom_bar(stat="identity") +
            xlab("Season") +
            ylab("Count") +
            ggtitle(plotTitle) +
            viridis::scale_fill_viridis(discrete = T) +
            theme(plot.title = element_text(hjust = 0.5)) +
            theme(axis.text.x = element_text(angle=50, hjust=1)) +
            theme(legend.position = "none") 
          } else if (selectPlot == "barSRSeasonYear") {
            #outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_season_year_count_barplot.png"))
            plotTitle = "Count of Survey Records by Season and Year"
            ggplot(survey_sub_prj %>%
                     filter(!if_any(c(survey_GlobalID, season_year), is.na)) %>%
                     dplyr::select(survey_GlobalID, season_year) %>% 
                     dplyr::group_by(season_year) %>%
                     dplyr::count(season_year) %>%
                     dplyr::mutate(perc=round((n/nrow(survey_sub_prj))*100, 2)) %>%
                     tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
                     dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))),
                   aes(season, n)) +
              geom_bar(aes(fill=year), position="stack", stat="identity") +
              viridis::scale_fill_viridis(discrete = T) +
              xlab("Season") +
              ylab("Count") +
              ggtitle(plotTitle) +
              theme(plot.title = element_text(hjust = 0.5)) +
              theme(axis.text.x = element_text(angle=50, hjust=1)) 
          } else if (selectPlot == "barSRMonthYear") {
            #outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_month_year_count_barplot.png"))
            plotTitle = "Count of Survey Records by Month and Year"
            ggplot(survey_sub_prj %>%
                     filter(!if_any(c(survey_GlobalID, survey_date), is.na)) %>%
                     dplyr::select(survey_GlobalID, survey_date) %>% 
                     dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
                     dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
                     dplyr::group_by(survey_yrmo) %>%
                     dplyr::count(survey_yrmo) %>%
                     dplyr::mutate(perc=round((n/nrow(survey_sub_prj))*100, 2)) %>%
                     tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
                     dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", 
                                                                 "Apr", "May", "Jun", 
                                                                 "Jul", "Aug", "Sep", 
                                                                 "Oct", "Nov", "Dec"))),
                   aes(month, n)) +
              geom_bar(aes(fill=year), position="stack", stat="identity") +
              viridis::scale_fill_viridis(discrete = T) +
              xlab("Month") +
              ylab("Count") +
              ggtitle(plotTitle) +
              theme(plot.title = element_text(hjust = 0.5)) +
              theme(axis.text.x = element_text(angle=50, hjust=1)) 
          } else if (selectPlot == "barSRSiteYear") {
            #outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_sids_year_count_barplot.png"))
            plotTitle = "Count of Survey Records by Site and Year"
            ggplot(survey_sub_prj %>%
                     filter(!if_any(c(survey_GlobalID, survey_date), is.na)) %>%
                     dplyr::select(survey_GlobalID, site_id, survey_year) %>% 
                     dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
                     dplyr::group_by(sid_year) %>%
                     dplyr::count(sid_year) %>%
                     dplyr::mutate(perc=round((n/nrow(survey_sub_prj))*100, 2)) %>%
                     tidyr::separate(sid_year, into=c("site_id","year"),sep=" "),
                   aes(site_id, n)) +
              geom_bar(aes(fill=year), position="stack", stat="identity") +
              viridis::scale_fill_viridis(discrete = T) +
              xlab("Site ID") +
              ylab("Count") +
              ggtitle(plotTitle) +
              theme(plot.title = element_text(hjust = 0.5)) +
              theme(axis.text.x = element_text(angle=50, hjust=1))
          } else return(NULL)
    }) 
    }) 
},
options = list(height = 1000)
)
#outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_table.png"))
#outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_map.png"))
```


# CREW SUMMARY

## Percentage of survey records with associated crew information
```{r}
nrow(survey_sub)

unique_survey_gids <- unique(survey_sub$survey_GlobalID)
unique_envmeas_survey_gids <- unique(survey_crew_join$survey_GlobalID) 

perc_gids<-(length(unique_envmeas_survey_gids)/length(unique_survey_gids))*100
print(paste0("Percentage of survey records with crew information: ",round(perc_gids,2),"%"))

```

# ENVIRONMENTAL MEASUREMENTS SUMMARY

* Jun, Jul, Aug (Summer)
* Sep, Oct, Nov (Fall)
* Dec, Jan, Feb (Winter)
* Mar, Apr, May (Spring)
* measurements per season, measurements per year, measurements per month
* (count of survey records, count of filters, count of cores, count of environmental measurements), barcharts grouped or stacked by year per site

## Count of empty or NA env_measurements
```{r}
# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank or NA env_measurements

nrow(survey_envmeas_join[survey_envmeas_join$env_measurements == "" | is.na(survey_envmeas_join$env_measurements),])

```

## Percentage of survey records with environmental measurements
```{r}
nrow(survey_sub)

unique_survey_gids <- unique(survey_sub$survey_GlobalID)
unique_envmeas_survey_gids <- unique(survey_envmeas_join$survey_GlobalID) 

perc_gids<-(length(unique_envmeas_survey_gids)/length(unique_survey_gids))*100
print(paste0("Percentage of survey records with environmental measurements: ",round(perc_gids,2),"%"))

unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)

perc_sids<-(length(unique_envmeas_sids)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with environmental measurements: ",round(perc_sids,2),"%"))
```

## Map and table of unique Site IDs with environmental measurements
```{r, echo=FALSE}
shinyApp(
  ui = fluidPage(
    leafletOutput("map"),
    DT::dataTableOutput('table')
  ),
  server = function(input, output) {
    output$map <- renderLeaflet({
      leaflet() %>%
        addTiles() %>%
        setView(lng=-68.5, lat=44.0, zoom=7)
      })
    observe({
      rcdext_sids_all <- survey_envmeas_join %>%
        filter(!if_any(c(site_id), is.na)) %>%
        dplyr::select(site_id) %>%
        dplyr::filter(site_id!="other") %>%
        dplyr::distinct() %>%
        dplyr::left_join(as.data.frame(site_ids_spdf)) %>%
        dplyr::mutate(RecordsExist="Yes") %>%
        dplyr::select(site_id, RecordsExist) %>%
        dplyr::full_join(as.data.frame(site_ids_spdf)) %>%
        dplyr::mutate(RecordsExist = ifelse(is.na(RecordsExist), "No", RecordsExist)) %>%
        dplyr::select(site_id, general_location_name, RecordsExist, 
                      projects, system_type, region_code, s123_filter_count, 
                      s123_core_count, lon, lat) %>%
        dplyr::arrange(site_id) 
      
      rcdext_sids_other <- survey_envmeas_join %>%
        filter(!if_any(c(site_id), is.na)) %>%
        dplyr::filter(site_id=="other") %>%
        dplyr::filter(lat_manual>0 | long_manual>0) %>%
        dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
        dplyr::distinct() %>%
        dplyr::rename(lat=lat_manual) %>%
        dplyr::rename(lon=long_manual) %>%
        dplyr::mutate(RecordsExist="Yes") %>%
        dplyr::mutate(region_code="other") %>%
        dplyr::mutate(system_type="other") %>%
        dplyr::arrange(general_location_name)
      
      rcdext_sids_all_spdf <- rcdext_sids_all %>%
        sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
        dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
        tidyr::separate(geom, into=c("lon","lat"),sep=",") %>% # reseparate out lat, long
        sf::as_Spatial()
      
      if (nrow(rcdext_sids_other)>0) {
        rcdext_sids_other_spdf<-rcdext_sids_other %>% 
          sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
          dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
          tidyr::separate(geom, into=c("lon","lat"),sep=",") %>% # reseparate out lat, long
          sf::as_Spatial()
      }
        
      output$table <- DT::renderDataTable({
        if (nrow(rcdext_sids_other)>0) {
          DT::datatable(rbind(data.table(rcdext_sids_all), data.table(rcdext_sids_other), fill=TRUE), options = list(scrollX = TRUE))
          } else {
            DT::datatable(as.data.frame(rcdext_sids_all), options = list(scrollX = TRUE))
            }
        })
      
      sidsPopup <- sprintf(
        "<strong>%s: %s</strong><br/>Has environmental measurements: %s<br/>%s",
        rcdext_sids_all_spdf$site_id, rcdext_sids_all_spdf$general_location_name,
        rcdext_sids_all_spdf$RecordsExist, rcdext_sids_all_spdf$projects) %>% 
        lapply(htmltools::HTML)
      
      proxy <- leafletProxy("map")
      proxy %>%
        clearMarkers() %>%
        clearShapes() %>%
        clearPopups() %>%
        clearControls() %>%
        addPolygons(data=WBD_spdf_simplified, layerId=~region_cod,
                    fillColor="grey", fillOpacity=0.5, 
                    color="#444444", opacity=1,
                    weight=1,  dashArray="3",
                    group="Watersheds") %>%
            addLabelOnlyMarkers(data=centers_wbd, lng=~x, lat=~y, label=~region_cod,
                                labelOptions = labelOptions(noHide = TRUE, direction = 'middle', textOnly = TRUE),
                                group="Watersheds") %>%
            addCircleMarkers(data=rcdext_sids_all_spdf, layerId=~unique(site_id), 
                             fillColor=~existsPal(RecordsExist), fillOpacity=0.8, 
                             color="#444444", opacity=1, 
                             weight=1, radius=5, stroke=TRUE,
                             popup = sidsPopup,
                             group="Site IDs") %>%
        hideGroup("Watersheds") %>%
        addLegend(data=rcdext_sids_all_spdf, pal=existsPal, values=~RecordsExist, opacity = 1)
      if (nrow(rcdext_sids_other)>0) {
        oSidsPopup <- sprintf(
          "<strong>%s: %s</strong><br/>Has environmental measurements: %s<br/>%s",
          rcdext_sids_all_spdf$site_id, rcdext_sids_all_spdf$general_location_name,
          rcdext_sids_all_spdf$RecordsExist, rcdext_sids_all_spdf$projects) %>% 
        lapply(htmltools::HTML)
        proxy %>% addCircleMarkers(data=rcdext_sids_other_spdf, 
                             fillColor=~existsPal(RecordsExist), fillOpacity=0.8, 
                             color="#444444", opacity=1, 
                             weight=1, radius=5, stroke=TRUE,
                             popup = oSidsPopup,
                             group="Other Sites") %>%
          addLayersControl(
              overlayGroups = c("Watersheds", "Site IDs", "Other Sites"),
              options = layersControlOptions(collapsed = FALSE))
      } else {
        proxy %>%
          addLayersControl(
              overlayGroups = c("Watersheds", "Site IDs"),
              options = layersControlOptions(collapsed = FALSE))
      }

            
    }) 
},
options = list(height = 1000)
)
#outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_table.png"))
#outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_map.png"))
```


## Summary of environmental measurements per year, month, and season
```{r, echo=FALSE}
shinyApp(
  ui = fluidPage(
    selectInput("selectedplot", 
                label="Plot", 
                choices=c(
                  "Barplot Records per Season" = "barSRSeason",
                  "Barplot Records per Season and Year" = "barSRSeasonYear",
                  "Barplot Records per Month and Year" = "barSRMonthYear",
                  "Barplot Records per Site and Year" = "barSRSiteYear",
                  "Barplot Records per Site" = "barSRSite"), 
      selected="barSRSeason"),
    plotOutput("plot"),
    DT::dataTableOutput('table')
  ),
  server = function(input, output) {
    observe({
      selectPlot<-input$selectedplot
      output$table <- DT::renderDataTable({
        if (selectPlot == "barSRSeason") {
          DT::datatable(survey_envmeas_join %>%
                          filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, season), is.na)) %>%
                          dplyr::select(envmeas_GlobalID, season) %>% 
                          dplyr::group_by(season) %>%
                          dplyr::count(season) %>%
                          dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)), options = list(scrollX = TRUE))
        } else if (selectPlot == "barSRSeasonYear") {
          DT::datatable(survey_envmeas_join %>%
                          filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, season_year), is.na)) %>%
                  dplyr::select(envmeas_GlobalID, season_year) %>% 
                  dplyr::group_by(season_year) %>%
                  dplyr::count(season_year) %>%
                  dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
                  tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
                  dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))) %>%
                  dplyr::arrange(season, year), options = list(scrollX = TRUE))
        } else if (selectPlot == "barSRMonthYear") {
          DT::datatable(survey_envmeas_join %>%
                          filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, survey_date), is.na)) %>%
                          dplyr::select(envmeas_GlobalID, survey_date) %>% 
                          dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
                          dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
                          dplyr::group_by(survey_yrmo) %>%
                          dplyr::count(survey_yrmo) %>%
                          dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
                          tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
                          dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", 
                                                                      "Apr", "May", "Jun", 
                                                                      "Jul", "Aug", "Sep", 
                                                                      "Oct", "Nov", "Dec"))) %>%
                          dplyr::arrange(month, year))
        } else if (selectPlot == "barSRSiteYear") {
          DT::datatable(survey_envmeas_join %>%
                          filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, survey_date), is.na)) %>%
                          dplyr::select(envmeas_GlobalID, site_id, survey_year) %>% 
                          dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
                          dplyr::group_by(sid_year) %>%
                          dplyr::count(sid_year) %>%
                          dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
                          tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
                          dplyr::arrange(site_id, year), options = list(scrollX = TRUE))
        } else if (selectPlot == "barSRSite") {
          DT::datatable(survey_envmeas_join %>%
                          filter(!if_any(c(envmeas_GlobalID, site_id), is.na)) %>%
                          dplyr::select(envmeas_GlobalID, site_id) %>% 
                          dplyr::group_by(site_id) %>%
                          dplyr::count(site_id) %>%
                          dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)), options = list(scrollX = TRUE))
        } else return(NULL)
      })
      output$plot <- renderPlot({
        if (selectPlot == "barSRSeason") {
          #outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_season_count_barplot.png"))
          plotTitle = "Count of Environmental Measurements by Season"
          ggplot(survey_envmeas_join %>%
                   filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, season), is.na)) %>%
                   dplyr::select(envmeas_GlobalID, season) %>% 
                   dplyr::group_by(season) %>%
                   dplyr::count(season) %>%
                   dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
                   dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))),
                 aes(season, n, fill=season)) +
            geom_bar(stat="identity") +
            xlab("Season") +
            ylab("Count") +
            ggtitle(plotTitle) +
            viridis::scale_fill_viridis(discrete = T) +
            theme(plot.title = element_text(hjust = 0.5)) +
            theme(axis.text.x = element_text(angle=50, hjust=1)) +
            theme(legend.position = "none") 
          } else if (selectPlot == "barSRSeasonYear") {
            plotTitle = "Count of Environmental Measurements by Season and Year"
            #outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_season_year_count_barplot.png"))
            ggplot(survey_envmeas_join %>%
                     filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, season_year), is.na)) %>%
                     dplyr::select(envmeas_GlobalID, season_year) %>% 
                     dplyr::group_by(season_year) %>%
                     dplyr::count(season_year) %>%
                     dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
                     tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
                     dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))),
                   aes(season, n)) +
              geom_bar(aes(fill=year), position="stack", stat="identity") +
              viridis::scale_fill_viridis(discrete = T) +
              xlab("Season") +
              ylab("Count") +
              ggtitle(plotTitle) +
              theme(plot.title = element_text(hjust = 0.5)) +
              theme(axis.text.x = element_text(angle=50, hjust=1)) 
          } else if (selectPlot == "barSRMonthYear") {
            #outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_month_year_count_barplot.png"))
            plotTitle = "Count of Environmental Measurements by Month and Year"
            ggplot(survey_envmeas_join %>%
                     filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, survey_date), is.na)) %>%
                     dplyr::select(envmeas_GlobalID, survey_date) %>% 
                     dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
                     dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
                     dplyr::group_by(survey_yrmo) %>%
                     dplyr::count(survey_yrmo) %>%
                     dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
                     tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
                     dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", 
                                                                 "Apr", "May", "Jun", 
                                                                 "Jul", "Aug", "Sep", 
                                                                 "Oct", "Nov", "Dec"))),
                   aes(month, n)) +
              geom_bar(aes(fill=year), position="stack", stat="identity") +
              viridis::scale_fill_viridis(discrete = T) +
              xlab("Month") +
              ylab("Count") +
              ggtitle(plotTitle) +
              theme(plot.title = element_text(hjust = 0.5)) +
              theme(axis.text.x = element_text(angle=50, hjust=1)) 

          } else if (selectPlot == "barSRSiteYear") {
            #outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_year_count_barplot.png"))
            plotTitle = "Count of Environmental Measurements by Site and Year"
            ggplot(survey_envmeas_join %>%
                     filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, survey_date), is.na)) %>%
                     dplyr::select(envmeas_GlobalID, site_id, survey_year) %>% 
                     dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
                     dplyr::group_by(sid_year) %>%
                     dplyr::count(sid_year) %>%
                     dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
                     tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
                     dplyr::arrange(site_id, year),
                   aes(site_id, n)) +
              geom_bar(aes(fill=year), position="stack", stat="identity") +
              viridis::scale_fill_viridis(discrete = T) +
              xlab("Site ID") +
              ylab("Count") +
              ggtitle(plotTitle) +
              theme(plot.title = element_text(hjust = 0.5)) +
              theme(axis.text.x = element_text(angle=50, hjust=1))
          } else if (selectPlot == "barSRSite") {
            #outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_count_barplot.png"))
            plotTitle = "Count of Environmental Measurements by Site"
            ggplot(survey_envmeas_join %>%
                     filter(!if_any(c(envmeas_GlobalID, site_id), is.na)) %>%
                     dplyr::select(envmeas_GlobalID, site_id) %>% 
                     dplyr::group_by(site_id) %>%
                     dplyr::count(site_id) %>%
                     dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)),
                   aes(site_id, n, fill=site_id)) +
              geom_bar(stat="identity") +
              viridis::scale_fill_viridis(discrete = T) +
              xlab("Site ID") +
              ylab("Count") +
              ggtitle(plotTitle) +
              theme(plot.title = element_text(hjust = 0.5)) +
              theme(axis.text.x = element_text(angle=50, hjust=1)) +
              theme(legend.position = "none") 
          } else return(NULL)
        }) 
    }) 
},
options = list(height = 1000)
)
```



# ENVIRONMENTAL MEASUREMENTS: MEASUREMENT DEPTH
Measurement depth is recorded in meters (M).
## Percentage of Site IDs with environmental depth measurements
```{r}

```


## Map of unique Site IDs with environmental measurements (depth, water temp, salinity, turbidity, conductivity, do, par1, par2)
```{r, echo=FALSE}
shinyApp(
  ui = fluidPage(
    selectInput("selectedvar", 
                label="Variable", 
                choices=c(
                  "Measurement Depth" = "envmeas_depth",
                  "Water Temperature" = "water_temp",
                  "Salinity" = "salinity",
                  "Turbidity" = "turbidity",
                  "Conductivity" = "conductivity",
                  "Dissolved Oxygen" = "do",
                  "PAR1" = "par1",
                  "PAR2" = "par2"),
      selected="envmeas_depth"),
    leafletOutput("map"),
    DT::dataTableOutput('table')
  ),
  server = function(input, output) {
    output$map <- renderLeaflet({
      leaflet() %>%
        addTiles() %>%
        setView(lng=-68.5, lat=44.0, zoom=7)
      })
    observe({
      selectVar<-input$selectedvar
      
      rcdext_sids_all <- survey_envmeas_join %>%
        filter(!if_any(c(selectVar, site_id), is.na)) %>%
        dplyr::select(site_id) %>%
        dplyr::filter(site_id!="other") %>%
        dplyr::distinct() %>%
        dplyr::left_join(as.data.frame(site_ids_spdf)) %>%
        dplyr::mutate(RecordsExist="Yes") %>%
        dplyr::select(site_id, RecordsExist) %>%
        dplyr::full_join(as.data.frame(site_ids_spdf)) %>%
        dplyr::mutate(RecordsExist = ifelse(is.na(RecordsExist), "No", RecordsExist)) %>%
        dplyr::select(site_id, general_location_name, RecordsExist, 
                      projects, system_type, region_code, s123_filter_count, 
                      s123_core_count, lon, lat) %>%
        dplyr::arrange(site_id) 
      
      rcdext_sids_other <- survey_envmeas_join %>%
        filter(!if_any(c(selectVar, site_id), is.na)) %>%
        dplyr::filter(site_id=="other") %>%
        dplyr::filter(lat_manual>0 | long_manual>0) %>%
        dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
        dplyr::distinct() %>%
        dplyr::rename(lat=lat_manual) %>%
        dplyr::rename(lon=long_manual) %>%
        dplyr::mutate(RecordsExist="Yes") %>%
        dplyr::mutate(region_code="other") %>%
        dplyr::mutate(system_type="other") %>%
        dplyr::arrange(general_location_name)
      
      rcdext_sids_all_spdf <- rcdext_sids_all %>%
        sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
        dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
        tidyr::separate(geom, into=c("lon","lat"),sep=",") %>% # reseparate out lat, long
        sf::as_Spatial()
      
      if (nrow(rcdext_sids_other)>0) {
        rcdext_sids_other_spdf<-rcdext_sids_other %>% 
          sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
          dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
          tidyr::separate(geom, into=c("lon","lat"),sep=",") %>% # reseparate out lat, long
          sf::as_Spatial()
      }
        

      output$table <- DT::renderDataTable({
        if (nrow(rcdext_sids_other)>0) {
          DT::datatable(rbind(data.table(rcdext_sids_all), data.table(rcdext_sids_other), fill=TRUE), options = list(scrollX = TRUE))
         
          } else {
             DT::datatable(as.data.frame(rcdext_sids_all), options = list(scrollX = TRUE))
          
            }
        })
      
      sidsPopup <- sprintf(
        "<strong>%s: %s</strong><br/>Has environmental %s measurements: %s<br/>%s",
        rcdext_sids_all_spdf$site_id, rcdext_sids_all_spdf$general_location_name, selectVar,
        rcdext_sids_all_spdf$RecordsExist, rcdext_sids_all_spdf$projects) %>% 
        lapply(htmltools::HTML)
      
      oSidsPopup <- sprintf(
        "<strong>%s: %s</strong><br/>Has environmental %s measurements: %s<br/>%s",
        rcdext_sids_all_spdf$site_id, rcdext_sids_all_spdf$general_location_name, selectVar,
        rcdext_sids_all_spdf$RecordsExist, rcdext_sids_all_spdf$projects) %>% 
        lapply(htmltools::HTML)
      
      proxy <- leafletProxy("map")
      proxy %>%
        clearMarkers() %>%
        clearShapes() %>%
        clearPopups() %>%
        clearControls() %>%
        addPolygons(data=WBD_spdf_simplified, layerId=~region_cod,
                    fillColor="grey", fillOpacity=0.5, 
                    color="#444444", opacity=1,
                    weight=1,  dashArray="3",
                    group="Watersheds") %>%
            addLabelOnlyMarkers(data=centers_wbd, lng=~x, lat=~y, label=~region_cod,
                                labelOptions = labelOptions(noHide = TRUE, direction = 'middle', textOnly = TRUE),
                                group="Watersheds") %>%
            addCircleMarkers(data=rcdext_sids_all_spdf, layerId=~unique(site_id), 
                             fillColor=~existsPal(RecordsExist), fillOpacity=0.8, 
                             color="#444444", opacity=1, 
                             weight=1, radius=5, stroke=TRUE,
                             popup = sidsPopup,
                             group="Site IDs") %>%
        hideGroup("Watersheds") %>%
        addLegend(data=rcdext_sids_all_spdf, pal=existsPal, values=~RecordsExist, opacity = 1)
      if (nrow(rcdext_sids_other)>0) {
        proxy %>% addCircleMarkers(data=rcdext_sids_other_spdf, 
                             fillColor=~existsPal(RecordsExist), fillOpacity=0.8, 
                             color="#444444", opacity=1, 
                             weight=1, radius=5, stroke=TRUE,
                             popup = oSidsPopup,
                             group="Other Sites") %>%
          addLayersControl(
              overlayGroups = c("Watersheds", "Site IDs", "Other Sites"),
              options = layersControlOptions(collapsed = FALSE))
      } else {
        proxy %>%
          addLayersControl(
              overlayGroups = c("Watersheds", "Site IDs"),
              options = layersControlOptions(collapsed = FALSE))
      }

            
    }) 
},
options = list(height = 1000)
)
```


# Environmental Measurements Summary
```{r, echo=FALSE}
shinyApp(
  ui = fluidPage(
      sidebarLayout(
        sidebarPanel(
          selectInput("selectedvar", 
                      label="Variable", 
                      choices=c(
                        "Measurement Depth" = "envmeas_depth",
                        "Water Temperature" = "water_temp",
                        "Salinity" = "salinity",
                        "Turbidity" = "turbidity",
                        "Conductivity" = "conductivity",
                        "Dissolved Oxygen" = "do",
                        "PAR1" = "par1",
                        "PAR2" = "par2"),
                      selected="envmeas_depth"),
          selectInput("selectedplot", 
                    label="Plot", 
                    choices=c(
                      "Histogram" = "histEnvMeas",
                      "Boxplot by Site and Month" = "boxSiteMonth",
                      "Boxplot by System" = "boxSystem",
                      "Boxplot by Site" = "boxSite",
                      "Scatterplot by Depth, Month, and System"= "splotDepthMoSys"), 
                    selected="histEnvMeas"),
          #sliderInput("rangeSlider", label = "Variable Range", min = 0, max = 100000, 
          #            value = c(0, 100), sep=""),
          numericInput("rangeStart","Variable Start", value = 0),
          numericInput("rangeEnd", "Variable End", value = 100),
          htmlOutput("text")
          ),
        mainPanel(
          plotOutput("plot"),
          DT::dataTableOutput('table')
      )
    )
  ),
  server = function(input, output) {
    
      envMeasInRange <- reactive({
      selectVar<-input$selectedvar
      #varRange<-input$rangeSlider
      survey_envmeas_join %>%
        dplyr::filter(!if_any(c(selectVar, site_id), is.na)) %>%
        #dplyr::filter(!!as.symbol(selectVar)>=varRange[1] & !!as.symbol(selectVar)<=varRange[2])
        dplyr::filter(!!as.symbol(selectVar)>=input$rangeStart & !!as.symbol(selectVar)<=input$rangeEnd)
      })
  
    observe({
      selectVar<-input$selectedvar
      selectPlot<-input$selectedplot
    
      unique_survey_sids <- unique(survey_sub$site_id)
      unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
      unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
        filter(!if_any(c(selectVar, site_id), is.na)) %>%
        dplyr::select(site_id) %>%
        dplyr::distinct()

      perc_sids<-round((nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100,2)
    
      perc_sids_envmeas<-round((nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100,2)
      
      quant_str<-quantile(survey_envmeas_join[[selectVar]], na.rm=TRUE)
      min_str<-min(survey_envmeas_join[[selectVar]], na.rm=TRUE)
      max_str<-max(survey_envmeas_join[[selectVar]], na.rm=TRUE)
      
      quant_str[2]

      output$text<-renderUI({
        str1 <-sprintf("Percentage of site ids with %s measurements: %g %%", selectVar, perc_sids)
        str2 <- sprintf("Percentage of site ids with environmental measurements that also have %s: %g %%", selectVar, perc_sids_envmeas)
        str3 <- sprintf("Min (%s): %g", selectVar, min_str)
        str4 <- sprintf("Max (%s): %g", selectVar, max_str)
        str5 <- sprintf("Quantiles (%s): 0%% %s, 25%% %s, 50%% %s, 75%% %s, 100%% %s", selectVar, quant_str[1], quant_str[2], quant_str[3], quant_str[4], quant_str[5])
        
        HTML(paste(str1, str2, str3, str4, str5,  sep = '<br/>'))
      })

      
      output$plot <- renderPlot({
        if (selectPlot == "histEnvMeas") {
          plotTitle="Environmental Measurements Distribution"
          # check distribution
          ggplot(envMeasInRange(),
                 aes_string(x=selectVar)) + 
            ylab("Density") +
            xlab(selectVar) +
            ggtitle(plotTitle) +
            geom_histogram(aes(y=..density..), colour="black", fill="white")+
            geom_density(alpha=.2, fill="#FF6666") 
        } else if (selectPlot == "boxSiteMonth") {
          plotTitle="Environmental Measurements by Site and Month"
          ggplot(envMeasInRange() %>%
                   filter(!if_any(c(selectVar, site_id), is.na)), 
                 aes_string(x="site_id", y=selectVar, fill="site_id")) + 
            geom_boxplot() +
            xlab(selectVar) +
            xlab("Site ID") +
            facet_grid(survey_month ~ .) +
            ggtitle(plotTitle) +
            theme(plot.title = element_text(hjust = 0.5)) +
            theme(axis.text.x = element_text(angle=50, hjust=1)) +
            theme(legend.position = "none") 
        } else if (selectPlot == "boxSystem") {
          plotTitle="Environmental Measurements by System"
          ggplot(envMeasInRange() %>%
                   dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
                 aes_string(x="system_type", y=selectVar, fill="system_type")) + 
                 geom_boxplot() +
                 ylab(selectVar) +
                 xlab("System") +
                 ggtitle(plotTitle) +
                 theme(plot.title = element_text(hjust = 0.5)) +
                 theme(legend.position = "none") 
        } else if (selectPlot == "boxSite") {
          plotTitle="Environmental Measurements by Site"
          ggplot(envMeasInRange(), 
                 aes_string(x="site_id", y=selectVar, fill="site_id")) + 
            geom_boxplot() +
            ylab(selectVar) +
            xlab("Site ID") +
            ggtitle(plotTitle) +
            theme(plot.title = element_text(hjust = 0.5)) +
            theme(axis.text.x = element_text(angle=50, hjust=1)) +
            theme(legend.position = "none") 
        } else if (selectPlot == "splotDepthMoSys") {
          #fileName="s123_envmeas_wtemp_system_month_depth_splot"
          plotTitle = "Water Temperature by System, Depth, and Month"
          ggplot(envMeasInRange() %>%
                   dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
                 aes_string(x="survey_month", y="envmeas_depth", color=selectVar)) +
            geom_point(size=2) +
            geom_jitter(width = 0.25, height = 2) +
            scale_x_discrete(name ="Month", limits=factor(seq(1, 12, by=1))) +
            scale_y_continuous(name =selectVar) +
            labs(color='Water Temp (C)') +
            ggtitle(plotTitle) +
            facet_grid(system_type ~ .)
          
        } else return(NULL)
      })
        
      output$table <- DT::renderDataTable({
        DT::datatable(envMeasInRange(), options = list(scrollX = TRUE))
        })
    }) 
},
options = list(height = 1000)
)
```


# ENVIRONMENTAL MEASUREMENTS: WATER TEMPERATURE
Water temperature is typically recorded with a YSI instrument. Water temperature is recorded in °C and has a range of -5°C to 50°C.

## Percentage of Site IDs with environmental water temperature measurements
* add percentage of index site ids with environmental measurements that also have water_temp

## Environmental measurement of Temperature quantiles

## Environmental measurement where water temperature is greater than 50

## Environmental measurement of Temperature distribution

## Scatter plot of water temperature by depth, month, and system type


## Environmental measurement of Water Temperature by Site and Month plot

## Environmental measurement of Water Temperature by System plot


## Environmental measurement of Water Temperature by Site ID plot
* change fill to system rather than site_id (but keep in x)

# ENVIRONMENTAL MEASUREMENTS: SALINITY
Salinity is recorded in PSU (Practical Salinity Unit).
For Maine ~30 PSU

## Percentage of Site IDs with environmental measurements of Salinity

* add percentage of index site ids with environmental measurements that also have salinity


## Environmental measurement of Salinity quantiles


## Environmental measurements where salinity is greater than 40


## Environmental measurement of Salinity distribution


## Scatter plot of salinity by depth, month, and system type
* add note about depth and sampling year/month

## Environmental measurement of Salinity by Site ID and Month

## Environmental measurement of Salinity by System

## Environmental measurement of Salinity by Site ID

# ENVIRONMENTAL MEASUREMENTS: TURBIDITY
Turbidity is typically collected with a YSI instrument. Turbidity is recorded in FNU (Formazin Nephelometric Unit) and has a range of 0 to 4000 FNU. 
* add turbidity ranges (what is high turbidity?), range for Maine?

## Percentage of Site IDs with environmental measurements of Turbidity
* add percentage of index site ids with environmental measurements that also have turbidity

## Environmental measurements of Turbidity quantile

## Environmental measurements where turbidity is greater than 40


## Environmental measurements of turbidity distribution


## Scatter plot of turbidity by depth and month

## Environmental measurements of Turbidity by Site ID and Month
* add note about depth and sampling year/month


## Environmental measurements of Turbidity by System


## Environmental measurements of Turbidity by Site ID


# ENVIRONMENTAL MEASUREMENTS: CONDUCTIVITY
Conductivity is typically collected with a YSI instrument. Conductivity is recorded in μS/cm and has a range of 0 to 100,000 μS/cm. 

## Percentage of Site IDs with environmental measurements of Conductivity
* add percentage of index site ids with environmental measurements that also have conductivity


## Environmental measurements of Conductivity quantile

## Environmental measurements where conductivity is less than 100

## Environmental measurements of conductivity distribution


## Scatter plot of conductivity by depth, month, and system type


## Environmental measurements of Conductivity by Site ID and Month
* add note about depth and sampling year/month



## Environmental measurements of Conductivity by System


## Environmental measurements of Conductivity by Site ID

# ENVIRONMENTAL MEASUREMENTS: DISSOLVED OXYGEN
Dissolved Oxygen is typically collected with a YSI instrument. Dissolved Oxygen is recorded in mg/L and has a range of 0 to 50 mg/L. 

## Percentage of Site IDs with environmental measurements of Dissolved Oxygen
* add percentage of index site ids with environmental measurements that also have dissolved oxygen



## Environmental measurements of Dissolved Oxygen quantile


## Environmental measurements where dissolved oxygen is greater than 50

## Environmental measurements of dissolved oxygen distribution

## Scatter plot of dissolved oxygen by depth, month, and system type


## Environmental measurements of Dissolved Oxygen by Site ID and Month
* add note about depth and sampling year/month


## Environmental measurements of Dissolved Oxygen by System


## Environmental measurements of Dissolved Oxygen by Site ID



# ENVIRONMENTAL MEASUREMENTS: PAR1
Photosynthetically Active Radiation (Channel 1: Up looking), or PAR1, is typically collected with a YSI instrument. PAR1 is recorded in μmoles/sec/m². 

## Percentage of Site IDs with environmental measurements of PAR1
* add percentage of index site ids with environmental measurements that also have PAR1



## Environmental measurements of par1 quantile



## Environmental measurements where par1 is greater than 1000


## Environmental measurements of par1 distribution


## Scatter plot of par1 by depth, month, and system type


## Environmental measurements of par1 by Site ID and Month
* add note about depth and sampling year/month


## Environmental measurements of par1 by System


## Environmental measurements of par1 by Site ID


# ENVIRONMENTAL MEASUREMENTS: PAR2
Photosynthetically Active Radiation (Channel 2: Down looking), or PAR2, is typically collected with a YSI instrument. PAR2 is recorded in μmoles/sec/m². 

## Percentage of Site IDs with environmental measurements of PAR2
* add percentage of index site ids with environmental measurements that also have PAR2



## Environmental measurements of par2 quantile



## Environmental measurements where par2 is greater than 40


## Environmental measurements of par2 distribution


## Scatter plot of par2 by depth, month, and system type


## Environmental measurements of par2 by Site ID and Month
* add note about depth and sampling year/month

## Environmental measurements of par2 by System


## Environmental measurements of par2 by Site ID
