---
title: "eDNA Survey123 Clean"
output: html_notebook
---

# STEP 1 - Read in CSVs from Survey123

This notebook:
1. Loads Survey123 data
2. Joins tables based on primary and foreign keys
3. Generates "long" tables by melting repeats


```{r, echo=FALSE, results="hide", messages=FALSE}
# Load and Install Libraries
source("medna_survey123.R")
## Check libraries & install
LibraryList<-c("data.table","dplyr","ggplot2")
install_or_load_pack(LibraryList)
overwrite = TRUE
inputFolder = "data/01_Original/"
outputFolder = "data/02_Working/ROutput/"
```

# load in data
```{r}
#load data
survey_data <- data.table::fread(paste0(inputFolder,'eDNA_Sampling_v14_0.csv'))
rep_crew <- data.table::fread(paste0(inputFolder,'rep_crew_1.csv'))
rep_envmeas <- data.table::fread(paste0(inputFolder,'rep_envmeas_2.csv'))
rep_collection <- data.table::fread(paste0(inputFolder,'rep_collection_3.csv'))
rep_filter <- data.table::fread(paste0(inputFolder,'rep_filter_4.csv'))
```
# review data
```{r}
# displays column names & number of rows - 6589
#names(survey_data);nrow(survey_data)
#names(rep_crew);nrow(rep_crew)
#names(rep_envmeas);nrow(rep_envmeas)
#names(rep_collection);nrow(rep_collection)
#names(rep_prefilter);nrow(rep_prefilter)
#names(rep_filter);nrow(rep_filter)
# Head displays the first 6 rows of the data.table
#head(survey_data);head(rep_crew);head(rep_envmeas);head(rep_collection);head(rep_prefilter);head(rep_filter)
```

# check empty site_ids
```{r}
# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank/NA Site IDs
survey_empty<-survey_data[survey_data$`Site ID` == "" | is.na(survey_data$`Site ID`),]
nrow(survey_empty)
rm(survey_empty)
```


# join cleaned dataset with labels
```{r}
# join tables
# inner_join because not all surveys had samples taken, therefore we only want records where a sample exists
#names(survey_data)
survey_sub <- survey_data %>%
  select(GlobalID, `Survey Date`, `Recorder First Name`, `Recorder Last Name`, `Site ID`, `Other Site ID`, `General Location Name`) %>%
  mutate(`Survey Date` = as.Date(`Survey Date`, format = '%m/%d/%Y')) %>%
  rename(survey_date = `Survey Date`) %>%
  rename(recorder_first_name = `Recorder First Name`) %>%
  rename(recorder_last_name = `Recorder Last Name`) %>%
  rename(general_location_name = `General Location Name`) %>%
  rename(survey_GlobalID = GlobalID) %>%
  rename(site_id = `Site ID`) %>%
  rename(other_site_id = `Other Site ID`)


#names(rep_collection)
rep_collection_sub <- rep_collection %>%
  select(GlobalID, ParentGlobalID, `Water Vessel Label`, `Water Collection Notes`) %>%
  rename(water_vessel_label = `Water Vessel Label`) %>%
  rename(water_collection_notes = `Water Collection Notes`) %>%
  rename(collection_GlobalID = GlobalID) %>%
  rename(collection_ParentGlobalID = ParentGlobalID)

survey_sample_join <- survey_sub %>% 
  full_join(rep_collection_sub, by = c("survey_GlobalID" = "collection_ParentGlobalID"))
#names(rep_prefilter)
rep_prefilter_sub <- rep_prefilter %>%
  select(GlobalID, ParentGlobalID, `Pre-Filter Sample Label`, `Pre-Filter Barcode Scan`, `Pre-Filter Date`, `Pre-Filter Type`, `Pre-Filter Notes`) %>%
  mutate(`Pre-Filter Date` = as.Date(`Pre-Filter Date`, format = '%m/%d/%Y')) %>%
  rename(prefilter_label = `Pre-Filter Sample Label`) %>%
  rename(prefilter_barcode = `Pre-Filter Barcode Scan`) %>%
  rename(prefilter_date = `Pre-Filter Date`) %>%
  rename(prefilter_type = `Pre-Filter Type`) %>%
  rename(prefilter_notes = `Pre-Filter Notes`) %>%
  rename(prefilter_GlobalID = GlobalID) %>%
  rename(prefilter_ParentGlobalID = ParentGlobalID)

## prefilter + sample + survey
ss_prefilter_join <- survey_sample_join %>% 
  full_join(rep_prefilter_sub, by = c("collection_GlobalID" = "prefilter_ParentGlobalID"))

#names(rep_filter)
rep_filter_sub <- rep_filter %>%
  select(GlobalID, ParentGlobalID, `Filter Sample Label`, `Filter Barcode Scan`, `Filter Date`, `Filter Type`, `Filter Notes`) %>%
  mutate(`Filter Date` = as.Date(`Filter Date`, format = '%m/%d/%Y')) %>%
  rename(filter_label = `Filter Sample Label`) %>%
  rename(filter_barcode = `Filter Barcode Scan`) %>%
  rename(filter_date = `Filter Date`) %>%
  rename(filter_type = `Filter Type`) %>%
  rename(filter_notes = `Filter Notes`) %>%
  rename(filter_GlobalID = GlobalID) %>%
  rename(filter_ParentGlobalID = ParentGlobalID)

## filter + sample + survey
ss_filter_join <- survey_sample_join %>% 
  full_join(rep_filter_sub, by = c("collection_GlobalID" = "filter_ParentGlobalID"))


## prefilter + filter + sample + survey
ss_prefilter_filter_join <- ss_prefilter_join %>% 
  full_join(rep_filter_sub, by = c("collection_GlobalID" = "filter_ParentGlobalID"))

#names(ss_prefilter_filter_join)

## rearrange column headers
preclean_prefilter_filter_join<-ss_prefilter_filter_join %>%
  relocate(survey_GlobalID,collection_GlobalID,prefilter_GlobalID,filter_GlobalID)


nrow(preclean_prefilter_filter_join);head(preclean_prefilter_filter_join)

join_prefilter_empty<-preclean_prefilter_filter_join[preclean_prefilter_filter_join$prefilter_type == "" | is.na(preclean_prefilter_filter_join$prefilter_type),]
nrow(join_prefilter_empty)
rm(join_prefilter_empty)
join_filter_empty<-preclean_prefilter_filter_join[preclean_prefilter_filter_join$filter_type == "" | is.na(preclean_prefilter_filter_join$filter_type),]
nrow(join_filter_empty)
rm(join_filter_empty)

# write full join (no clean) to file
outputFileName = "preclean_prefilter_filter_join"
outputFile = paste0(outputFolder,outputFileName,".csv")

if (!file.exists(outputFile) | overwrite) {
  write.csv(preclean_prefilter_filter_join, outputFile, row.names=FALSE)
}
```


# Save to edna_survey123clean.csv if it doesn't already exist or overwrite = TRUE
# pre-filter records
```{r}
# remove records without a specified prefilter
nrow(ss_prefilter_join)

clean_prefilter_join <- ss_prefilter_join[!(ss_prefilter_join$prefilter_type == ""), ]

nrow(clean_prefilter_join)

# reorder columns
#names(clean_prefilter_join)
clean_prefilter_join<-clean_prefilter_join %>%
  relocate(survey_GlobalID, survey_date,recorder_first_name, recorder_last_name, 
           site_id, other_site_id, general_location_name, water_vessel_label, 
           water_collection_notes, prefilter_date, prefilter_type, prefilter_label,prefilter_barcode, prefilter_notes, 
           collection_GlobalID, prefilter_GlobalID) %>%
  arrange(survey_date, survey_GlobalID,recorder_first_name, recorder_last_name)

# write labeled corpus to CSV
outputFileName = "clean_prefilter_join"
outputFile = paste0(outputFolder,outputFileName,".csv")

if (!file.exists(outputFile) | overwrite) {
  write.csv(clean_prefilter_join, outputFile, row.names=FALSE)
}

```

# filter records
```{r}
# remove records without a specified filter
nrow(ss_filter_join)
clean_filter_join<-ss_filter_join %>%
  filter(filter_type != "")

clean_filter_join <- ss_filter_join[!(ss_filter_join$filter_type == ""), ]

nrow(clean_filter_join)

names(clean_filter_join)
# reorder columns
clean_filter_join<-clean_filter_join %>%
  relocate(survey_GlobalID,survey_date,recorder_first_name, recorder_last_name, 
           site_id, other_site_id, general_location_name, water_vessel_label, 
           water_collection_notes, filter_date, filter_type, filter_label,filter_barcode, filter_notes, 
           collection_GlobalID, filter_GlobalID) %>%
  arrange(survey_date, survey_GlobalID,recorder_first_name, recorder_last_name)
# write labeled corpus to CSV
outputFileName = "clean_filter_join"
outputFile = paste0(outputFolder,outputFileName,".csv")

if (!file.exists(outputFile) | overwrite) {
  write.csv(clean_filter_join, outputFile, row.names=FALSE)
}
```

# prefilter + filter records
```{r}
# remove records without prefilter_type or filter_type
nrow(ss_prefilter_filter_join)

clean_prefilter_filter_join <- ss_prefilter_filter_join[!(ss_prefilter_filter_join$prefilter_type == "" & ss_prefilter_filter_join$filter_type == ""), ]

nrow(clean_prefilter_filter_join)

# reorder columns
names(clean_prefilter_filter_join)
clean_prefilter_filter_join<-clean_prefilter_filter_join  %>%
  relocate(survey_GlobalID, survey_date, recorder_first_name, recorder_last_name, 
            site_id, other_site_id, general_location_name, water_vessel_label,
           water_collection_notes, prefilter_date, prefilter_type, prefilter_label,prefilter_barcode, prefilter_notes, 
           filter_date, filter_type, filter_label,filter_barcode, filter_notes, collection_GlobalID, prefilter_GlobalID, filter_GlobalID) %>%
  arrange(survey_date, survey_GlobalID,recorder_first_name, recorder_last_name)

# Save cleaned survey data to new file 
outputFileNameClean <- "clean_prefilter_filter_join"
outputFileClean = paste0(outputFolder,outputFileNameClean,".csv")

if (!file.exists(outputFileClean) | overwrite) {
  write.csv(clean_prefilter_filter_join, outputFileClean, row.names=FALSE)
}

```