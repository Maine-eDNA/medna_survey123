---
title: "Maine-eDNA Survey123 Summary"
output:
  html_notebook: default
  pdf_document: default
---

Prepared by: Melissa Kimble



This notebook:
1. Loads Survey123 data
2. Generates SiteID summaries

* add in all YSI sonde measurements
* eg par1, par2, turbidity, do, conductivity, water temp
* add map versions of each of these

* geom_sf
* bubble plots with siteid
* add map of regions

# LOAD PROJECT VARIABLES
```{r, echo=FALSE, results="hide", messages=FALSE}
# Load and Install Libraries
source("medna_survey123.R")
## Check libraries & install
LibraryList<-c("data.table","dplyr","lubridate","stringr","ggplot2","scales", "zoo", "tidyr", "gridExtra", "sf", "googlesheets4", "viridis")
install_or_load_pack(LibraryList) 

todaysDateFn = format(Sys.Date(), "%Y%m%d")

overwrite = TRUE
inputFolder = "../data/02_Working/PyOutput/"
originalFolder = "../data/01_Original/"
# outputFolder = "../data/02_Working/ROutput/"

outputPngFolder = paste0("../figures/rcode/",todaysDateFn,"/")

WGS84_SRID = 4326

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

selected_projects <- c("Larval Black Box (T1)",
                     "Alewife (T1)",
                     "Fisheries eDNA (T1)",
                     "Harmful algal blooms (T2)",
                     "Species on the move (T2)",
                     "Index Sites (T3)",
                     "Macrosystem Integration (T3)",
                     "Microbial biosensors (T3)",
                     "Community Science (T3)",
                     "Other")
theme_set(theme_bw())

var_fmt=data.table(var=c("env_measurements", "envmeas_depth", "water_temp",
                         "salinity", "turbidity",
                         "conductivity", "do",
                         "par1", "par2",
                         "water_depth", "depth_core_collected"),
                   var_fmt=c("Environmental Measurements", "Measurement Depth (M)", "Water Temperature (°C)",
                         "Salinity (Practical Salinity Unit)", "Turbidity (Formazin Nephelometric Unit)",
                         "Conductivity (μS/cm)", "Dissolved Oxygen (mg/L)",
                         "PAR1 (μmoles/sec/m²)", "PAR2 (μmoles/sec/m²)",
                         "Water Collection Depth (M)", "Core Collection Depth (M)"))
```

# LOAD SHAPFILES
```{r, echo=FALSE, results="hide", messages=FALSE}
InputShpFolder = "G:/My Drive/Dissertation/01_Data"

# Watershed Boundary Dataset (WBD), National Hydrography Dataset (NHD), United States Geological Survey (USGS)
WBDHU8SHP = paste0(InputShpFolder,"/02_Working/Hydrography/USGS_NHD/20200615/WBDHU8_MENH_NEaq/WBDHU8_MENH_NEA_simplified.shp")
WBD_sfdf<-sf::st_read(WBDHU8SHP)
#names(WBD_sfdf)

# United States Census state admin boundaries 2021
UScensusSHP = paste0(InputShpFolder,"/01_Original/Census/2021/tl_2021_us_state/tl_2021_us_state.shp")
US_census_sfdf<-sf::st_read(UScensusSHP)
#names(US_coast_sfdf)

# NaturalEarth 10m North American lakes
lakesSHP = paste0(InputShpFolder,"/01_Original/NaturalEarth/ne_10m_lakes_north_america/ne_10m_lakes_north_america.shp")
lakes_sfdf<-sf::st_read(lakesSHP)
#names(lakes_sfdf)

# NaturalEarth 10m North American rivers
riversSHP = paste0(InputShpFolder,"/01_Original/NaturalEarth/ne_10m_rivers_north_america/ne_10m_rivers_north_america.shp")
rivers_sfdf<-sf::st_read(riversSHP)
#names(lakes_sfdf)

# NaturalEarth 10m admin countries boundary
countriesSHP = paste0(InputShpFolder,"/01_Original/NaturalEarth/ne_10m_admin_0_countries/ne_10m_admin_0_countries.shp")
countries_sfdf<-sf::st_read(countriesSHP)
#names(countries_sfdf)

# place all data in same coordinate system
US_census_sfdf=st_transform(US_census_sfdf, crs=st_crs(WBD_sfdf))

#US_census_sfdf$NAME

boundingbox<-st_bbox(US_census_sfdf %>%
          filter(NAME == "Maine" | NAME == "New Hampshire" | NAME == "Massachusetts"))
```

# LOAD GSHEETs
```{r, echo=FALSE, results="hide", messages=FALSE}
googlesheets4::gs4_auth("melissa.kimble@maine.edu")
sid_gsheet_url = "https://docs.google.com/spreadsheets/d/1TzlvUuaedzW0Q8JgPepYvmos0M4y1f-M_TMvLy6ZaJI/edit?usp=sharing"
#s123_gsheet_url = "https://docs.google.com/spreadsheets/d/1IVn6Ui80VZZrFjjRCy6FaOwh_5fR9ZJj4OxNypYBduc/edit?usp=sharing"
site_ids_gsheet <- googlesheets4::read_sheet(sid_gsheet_url, "lyr_view_fieldapp")
```
## Column names and number of rows
```{r}
site_ids_sfdf <- site_ids_gsheet %>%
  dplyr::select(SiteID, `General Location Name`, `Intended Purpose`, `Latitude`, `Longitude`, 
                `System Type`, `Watershed Code`, `Region Name`,
                `Survey123 Filter Count`, `Survey123 Core Count`) %>%
  sf::st_as_sf(.,coords=c('Longitude', 'Latitude'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>% # reseparate out lat, long
  dplyr::rename(site_id = SiteID) %>%
  dplyr::rename(general_location_name = `General Location Name`) %>%
  dplyr::rename(project_ids = `Intended Purpose`) %>%
  dplyr::rename(system_type = `System Type`) %>%
  dplyr::rename(watershed_code = `Watershed Code`) %>%
  dplyr::rename(region_name = `Region Name`) %>%
  dplyr::rename(s123_filter_count = `Survey123 Filter Count`) %>%
  dplyr::rename(s123_core_count = `Survey123 Core Count`)
# displays column names & number of rows - 65
nrow(site_ids_sfdf);names(site_ids_sfdf)

site_id_prjs <- site_ids_gsheet %>%
  dplyr::select(SiteID, `Intended Purpose`)  %>%
  dplyr::rename(site_id = SiteID) %>%
  dplyr::rename(sid_prjs = `Intended Purpose`) %>%
  dplyr::add_row(site_id="other", sid_prjs="Other")

boundingbox_sids<-st_bbox(site_ids_sfdf)
rm(site_ids_gsheet)
```

# Survey123 Simplified Schema
```{r, echo=FALSE}
#knitr::include_graphics("../figures/survey123_v14_simplified_erd.png")
```

# LOAD SURVEY123 CSVs
```{r}
#load data
survey_sub <- data.table::fread(paste0(inputFolder,'eDNA_Sampling_v14_sub.csv'))
survey_crew_join <- data.table::fread(paste0(inputFolder,'survey_crew_join.csv'))
survey_envmeas_join <- data.table::fread(paste0(inputFolder,'survey_envmeas_join.csv'))
survey_collection_join <- data.table::fread(paste0(inputFolder,'survey_collection_join.csv'))
clean_filter_join <- data.table::fread(paste0(inputFolder,'clean_filter_join.csv'))
clean_subcore_join <- data.table::fread(paste0(inputFolder,'clean_subcore_join.csv'))
```

```{r}
length(na.omit(survey_envmeas_join$ph))

survey_envmeas_join %>%
  dplyr::mutate(ph=na_if(ph, "")) %>%
      dplyr::filter(!if_any(c(ph, site_id), is.na))
```


## Column names and number of rows
```{r}
# displays column names & number of rows - 6589
nrow(survey_sub);names(survey_sub)
nrow(survey_envmeas_join);names(survey_envmeas_join)
nrow(survey_collection_join);names(survey_collection_join)
nrow(clean_filter_join);names(clean_filter_join)
nrow(clean_subcore_join);names(clean_subcore_join)
# Head displays the first 6 rows of the data.table
#head(survey_sub);head(survey_envmeas_join);head(survey_collection_join);head(clean_filter_join);head(clean_filter_join)
```

```{r}
survey_sub <- add_seasons_df(survey_sub)
survey_sub$system_type <- plyr::mapvalues(survey_sub$system_type, from=c("P", "C", "E", "S", "L", "A", "other"), to=c("Pelagic", "Coast", "Estuary", "Stream", "Lake", "Aquarium", "other"))
survey_sub <- survey_sub %>% dplyr::rename(gid = survey_global_id)

# add seasons to survey_crew_join
survey_crew_join <- add_seasons_df(survey_crew_join)
survey_crew_join$system_type <- plyr::mapvalues(survey_crew_join$system_type, from=c("P", "C", "E", "S", "L", "A", "other"), to=c("Pelagic", "Coast", "Estuary", "Stream", "Lake", "Aquarium", "other"))
survey_crew_join <- survey_crew_join %>% dplyr::rename(gid = crew_global_id)

# add seasons to survey_collection_join
survey_collection_join <- add_seasons_df(survey_collection_join)
survey_collection_join$system_type <- plyr::mapvalues(survey_collection_join$system_type, from=c("P", "C", "E", "S", "L", "A", "other"), to=c("Pelagic", "Coast", "Estuary", "Stream", "Lake", "Aquarium", "other"))
survey_collection_join <- survey_collection_join %>% dplyr::rename(gid = collection_global_id)

# add seasons to survey_envmeas_join
survey_envmeas_join <- add_seasons_df(survey_envmeas_join)
survey_envmeas_join$system_type <- plyr::mapvalues(survey_envmeas_join$system_type, from=c("P", "C", "E", "S", "L", "A", "other"), to=c("Pelagic", "Coast", "Estuary", "Stream", "Lake", "Aquarium", "other"))
survey_envmeas_join <- survey_envmeas_join %>% dplyr::rename(gid = envmeas_global_id)

# add seasons to clean_filter_join
clean_filter_join <- add_seasons_df(clean_filter_join)
clean_filter_join$system_type <- plyr::mapvalues(clean_filter_join$system_type, from=c("P", "C", "E", "S", "L", "A", "other"), to=c("Pelagic", "Coast", "Estuary", "Stream", "Lake", "Aquarium", "other"))
clean_filter_join <- clean_filter_join %>% dplyr::rename(gid = filter_global_id)
# remove any filter_labels with "delete"
clean_filter_join <- clean_filter_join %>% 
  dplyr::mutate(filter_label_lower=tolower(filter_label)) %>%
  dplyr::filter(!grepl("delete", filter_label_lower)) %>%
  dplyr::select(-filter_label_lower)

# add seasons to clean_subcore_join
clean_subcore_join <- add_seasons_df(clean_subcore_join)
clean_subcore_join$system_type <- plyr::mapvalues(clean_subcore_join$system_type, from=c("P", "C", "E", "S", "L", "A", "other"), to=c("Pelagic", "Coast", "Estuary", "Stream", "Lake", "Aquarium", "other"))
clean_subcore_join <- clean_subcore_join %>% dplyr::rename(gid = sample_global_id)
```

## Map of Watersheds
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Watersheds"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_all_watersheds_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill = region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox$xmin[[1]], boundingbox$xmax[[1]]*0.98), 
           ylim = c(boundingbox$ymin[[1]], boundingbox$ymax[[1]]*1.02), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()

#knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Map of SiteIDs
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_all_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.05) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, aes(fill=watershed_code), pch=21, color="black") +
#  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
#            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox$xmin[[1]], boundingbox$xmax[[1]]*0.98), 
           ylim = c(boundingbox$ymin[[1]], boundingbox$ymax[[1]]*1.02), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Map of SiteIDs (zoomed in)
```{r}
plotTitle = "Maine-eDNA Sites"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_all_sids_zoom_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, aes(fill=watershed_code),pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=site_ids_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
#knitr::include_graphics(outputPngFileName)
#rm(WBD_sfdf,ME_coast_sfdf)

#site_ids_sfdf$project_ids
```

## Map of Index Sites (zoomed in)
```{r}
project_list=c("Index Sites (T3)")
project_list = gsub("[()]", "", project_list)

plotTitle = "Maine-eDNA Index Sites"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_index_sids_zoom_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf %>%
            dplyr::mutate(prj_sub = gsub(",", " ", project_ids)) %>%
            dplyr::mutate(prj_sub = gsub("[()]", "",prj_sub)) %>%
            dplyr::filter(grepl(paste(project_list, collapse="|"), prj_sub)), 
          aes(fill=watershed_code),pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=site_ids_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
#knitr::include_graphics(outputPngFileName)
#rm(WBD_sfdf,ME_coast_sfdf)
```
## Map of Index Sites + others (zoomed in)
```{r}
project_list=c("Index Sites (T3)")
project_list = gsub("[()]", "", project_list)

plotTitle = "Maine-eDNA Index Sites"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_index_sids_other_zoom_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, aes(fill="white"),pch=21, color="black", alpha=0.7, size=2) +
  geom_sf(data=site_ids_sfdf %>%
            dplyr::mutate(prj_sub = gsub(",", " ", project_ids)) %>%
            dplyr::mutate(prj_sub = gsub("[()]", "",prj_sub)) %>%
            dplyr::filter(grepl(paste(project_list, collapse="|"), prj_sub)), 
          aes(fill="green"), pch=21, color="black", alpha=0.7, size=2) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=3, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none",
        text=element_text(size=18))

dev.off()
#knitr::include_graphics(outputPngFileName)
#rm(WBD_sfdf,ME_coast_sfdf)
```

# SURVEY SUMMARY 
* Jun, Jul, Aug (Summer)
* Sep, Oct, Nov (Fall)
* Dec, Jan, Feb (Winter)
* Mar, Apr, May (Spring)
* records per season, records per year, records per month
* (count of survey records, count of filters, count of cores, count of environmental measurements), barcharts grouped or stacked by year per site


## Count of empty or NA site_ids
```{r}
# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank or NA Site IDs

nrow(survey_sub[survey_sub$site_id == "" | is.na(survey_sub$site_id),])

```


## Table of unique Site IDs with survey records
```{r}
rcdext_df <- create_table_sids(survey_sub, site_ids_sfdf)

rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_sids_table.png"))
png(outputPngFileName, height=25*nrow(rcdext_fmt_df), width=350*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```

## Map of unique Site IDs with survey records
* separate out "other" into different boxplots/maps
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Environmental Measurements"
title_var = "Survey Records"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf, 
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Summary of survey records per year, month, and season
```{r}
dfname <- "Survey"
df_sub_prj<-subset_prj_df(survey_sub, site_id_prjs, selected_projects)
```

## Table of survey records per season
```{r}

create_table_count_site(df_sub_prj, site_ids_sfdf)
```
## Barplot of survey records per season
```{r}
plotTitle = "Count of survey records by season"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_season_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_season(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Table of survey records per system
```{r}
create_table_count_system(df_sub_prj)
```
## Barplot of survey records per system
```{r}
plotTitle = "Count of survey records by season"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_system_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_system(df_sub_prj, dfname)
dev.off()
#knitr::include_graphics(outputPngFileName)
```
## Table of survey records per system and year
```{r}
create_table_count_system_year(df_sub_prj)
```
## Barplot of survey records per system and year
```{r}
plotTitle = "Count of survey records by season"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_system_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_system_year(df_sub_prj, dfname)
dev.off()
#knitr::include_graphics(outputPngFileName)
```



## Table of survey records per season and year
```{r}
create_table_count_season_year(survey_sub)
```

## Barplot of survey records per season and year
```{r}
plotTitle = "Count of survey records by season and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_season_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_season_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of survey records per month and year
```{r}
create_table_count_month_year(survey_sub)
```

## Barplot of survey records per month and year - barSRMonthYear
```{r}
plotTitle = "Count of survey records by month and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_month_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_month_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```
## table of survey records per site and year
```{r}
create_table_count_site_year(survey_sub, site_ids_sfdf)
```
## Barplot of survey records per site and year
```{r}
plotTitle = "Count of survey records by site and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_sids_year_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)
create_barplot_count_site_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

# CREW SUMMARY

## Percentage of survey records with associated crew information
```{r}
nrow(survey_sub)

unique_survey_gids <- unique(survey_sub$gid)
unique_envmeas_survey_gids <- unique(survey_crew_join$survey_global_id) 

perc_gids<-(length(unique_envmeas_survey_gids)/length(unique_survey_gids))*100
print(paste0("Percentage of survey records with crew information: ",round(perc_gids,2),"%"))

```

# ENVIRONMENTAL MEASUREMENTS SUMMARY
* Jun, Jul, Aug (Summer)
* Sep, Oct, Nov (Fall)
* Dec, Jan, Feb (Winter)
* Mar, Apr, May (Spring)
* measurements per season, measurements per year, measurements per month
* (count of survey records, count of filters, count of cores, count of environmental measurements), barcharts grouped or stacked by year per site

## Count of empty or NA env_measurements
```{r}
# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank or NA env_measurements

nrow(survey_envmeas_join[survey_envmeas_join$env_measurements == "" | is.na(survey_envmeas_join$env_measurements),])

```

## Percentage of survey records with environmental measurements
```{r}
nrow(survey_sub)

unique_survey_gids <- unique(survey_sub$survey_global_id)
unique_envmeas_survey_gids <- unique(survey_envmeas_join$survey_global_id) 

perc_gids<-(length(unique_envmeas_survey_gids)/length(unique_survey_gids))*100
print(paste0("Percentage of survey records with environmental measurements: ",round(perc_gids,2),"%"))

unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)

perc_sids<-(length(unique_envmeas_sids)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with environmental measurements: ",round(perc_sids,2),"%"))
```
## Table of unique Site IDs with environmental measurements
```{r}
rcdext_df <- create_table_sids(survey_envmeas_join  %>%
                                   dplyr::mutate(env_measurements=na_if(env_measurements, "")) %>%
                                   dplyr::filter(!if_any(c(site_id, env_measurements), is.na)), site_ids_sfdf)

rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_table.png"))
png(outputPngFileName, height=30*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```

## Map of unique Site IDs with environmental measurements
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Environmental Measurements"
title_var = "Environmental Measurements"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Summary of environmental measurements per year, month, and season
```{r}
dfname <- "Environmental Measurements"
df_sub_prj<-subset_prj_df(survey_envmeas_join  %>%
          dplyr::mutate(env_measurements=na_if(env_measurements, "")) %>%
          dplyr::filter(!if_any(c(site_id, env_measurements), is.na)), 
          site_id_prjs, selected_projects)
```

## Table of environmental measurements per season
```{r}
create_table_count_season(df_sub_prj)
```
## Barplot of environmental measurements per season
```{r}
plotTitle = "Count of environmental measurements by season"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_season_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_season(df_sub_prj, dfname)
dev.off()
#knitr::include_graphics(outputPngFileName)
```
## table of environmental measurements per season and year
```{r}
create_table_count_season_year(df_sub_prj)
```

## Barplot of environmental measurements per season and year
```{r}
plotTitle = "Count of environmental measurements by season and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_season_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_season_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of environmental measurements per month and year
```{r}
create_table_count_month_year(df_sub_prj)
```
## Barplot of environmental measurements per month and year
```{r}
plotTitle = "Count of environmental measurements by month and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_month_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_month_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of environmental measurements per site and year
```{r}
create_table_count_site_year(df_sub_prj, site_ids_sfdf)
```

## Barplot of environmental measurements per site and year
```{r}
plotTitle = "Count of environmental measurements by site and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_year_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)
create_barplot_count_site_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```



## Table of count of environmental measurements by Site ID
```{r}
create_table_count_site(df_sub_prj, site_ids_sfdf)
```

## Count of environmental measurements by Site ID plot
```{r}
plotTitle = "Count of environmental measurements by site"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_site(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

# ENVIRONMENTAL MEASUREMENTS: MEASUREMENT DEPTH
Measurement depth is recorded in meters (M).

```{r}
selected_var_plots <- "envmeas_depth"
depth_var <- "envmeas_depth"
df_inrange<-create_summary_envmeas_table(survey_envmeas_join, selected_var_plots, 0, 60)
```

## Percentage of Site IDs with environmental depth measurements
```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  filter(!if_any(c(envmeas_depth, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with envmeas_depth measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have envmeas_depth: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental depth measurements
```{r}
select_var_maps <- "envmeas_depth"
rcdext_df <- create_table_envmeas_sids(survey_envmeas_join, select_var_maps)

rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_depth_sids_table.png"))
png(outputPngFileName, height=30*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```
## Map of unique Site IDs with Env Measurement depths
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Env Measurement Depths"
title_var = "Env Measurement Depths"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_depth_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements where Measurement Depth is greater than 50
```{r}

survey_envmeas_join %>%
  dplyr::filter(!if_any(c(envmeas_depth, site_id), is.na) & envmeas_depth > 50)
```

## Environmental measurements where System Type is Stream
```{r}
survey_envmeas_join %>%
  dplyr::filter(!if_any(c(envmeas_depth, site_id), is.na) & system_type=="S")
```

## Environmental measurement Depth quantiles
```{r}
quantile(survey_envmeas_join$envmeas_depth, na.rm=TRUE)
min(survey_envmeas_join$envmeas_depth, na.rm=TRUE)
max(survey_envmeas_join$envmeas_depth, na.rm=TRUE)
```

## Environmental measurement Depth distribution
```{r}
create_plot_histogram(df_inrange, selected_var_plots)
```

## Environmental measurement Depth by Site ID and Month
```{r, echo=FALSE, results="hide", messages=FALSE}

#plotTitle = "Depth by Site and Month"
#fileName="s123_envmeas_depth_site_month"

#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Depth, M
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(envmeas_depth, site_id), is.na)), aes(x=survey_year, y=envmeas_depth, fill=survey_year)) + 
#  geom_boxplot() +
#  xlab("Depth ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurement Depth by Site ID and Month
```{r}
plotTitle = "Depth by Site and Month"
fileName="s123_envmeas_depth_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
create_plot_boxplot_site_month(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()

#knitr::include_graphics(outputPngFileName)
```

## Environmental measurement Depth by System
```{r}

plotTitle = "Depth by System"
fileName="s123_envmeas_depth_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Depth, M
create_plot_boxplot_system(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()

#knitr::include_graphics(outputPngFileName)
```

## Environmental measurement Depth by Site ID
```{r}
plotTitle = "Depth by Site"
fileName="s123_envmeas_depth_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Depth, M
create_plot_boxplot_site(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

# ENVIRONMENTAL MEASUREMENTS: WATER TEMPERATURE
Water temperature is typically recorded with a YSI instrument. Water temperature is recorded in °C and has a range of -5°C to 50°C.
```{r}
selected_var_plots <- "water_temp"
depth_var <- "envmeas_depth"
df_inrange<-create_summary_envmeas_table(survey_envmeas_join, selected_var_plots, 0, 60)
```

## Percentage of Site IDs with environmental water temperature measurements
* add percentage of index site ids with environmental measurements that also have water_temp
```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!is.na(water_temp)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with water_temp measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have water_temp: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental water temperature measurements
```{r}
select_var_maps <- "water_temp"
rcdext_df <- create_table_envmeas_sids(survey_envmeas_join, select_var_maps)

rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_wtemp_sids_table.png"))
png(outputPngFileName, height=30*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```
## Map of unique Site IDs with environmental water temperature measurements
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Water Temperature Measurements"
title_var = "Water Temperature Measurements"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_wtemp_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Temperature quantiles
```{r}
quantile(survey_envmeas_join$water_temp, na.rm=TRUE)
min(survey_envmeas_join$water_temp, na.rm=TRUE)
max(survey_envmeas_join$water_temp, na.rm=TRUE)

```
## Environmental measurement where water temperature is greater than 50
```{r}
survey_envmeas_join %>%
    dplyr::select(survey_date, site_id, general_location_name, water_temp, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
  dplyr::filter(!if_any(c(water_temp, site_id), is.na) & water_temp>50)
```

## Environmental measurement of Temperature distribution
```{r}
plotTitle = "Distribution of Water Temperature"
# check distribution
p1<-ggplot(survey_envmeas_join %>%
         filter(!if_any(c(water_temp, site_id), is.na)),aes(x=as.numeric(water_temp))) + 
  ggtitle(plotTitle) +
  ylab("Density") +
  xlab("Water Temperature (C)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme(plot.title = element_text(hjust = 0.5))

plotTitle = "Distribution of Water Temperature (truncated)"
# check distribution
p2<-ggplot(survey_envmeas_join %>%
         filter(!if_any(c(water_temp, site_id), is.na) & water_temp<50),aes(x=as.numeric(water_temp))) + 
  ggtitle(plotTitle) +
  ylab("Density") +
  xlab("Water Temperature (C)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme(plot.title = element_text(hjust = 0.5))


grid.arrange(p1, p2, nrow=2)
rm(p1,p2)
```


## Heatmap of water temperature by depth and month 
```{r}
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(water_temp, site_id, envmeas_depth), is.na)) %>%
#         mutate(depth_group = cut(envmeas_depth, breaks = seq(floor(min(na.omit(survey_envmeas_join$envmeas_depth))), #ceiling(max(na.omit(survey_envmeas_join$envmeas_depth))), by = 5),
#                         labels = seq(floor(min(na.omit(survey_envmeas_join$envmeas_depth))) + 5, #ceiling(max(na.omit(survey_envmeas_join$envmeas_depth))), by = 5)),
#         month_group = cut(survey_month, breaks = seq(floor(min(na.omit(survey_envmeas_join$survey_month))), #ceiling(max(na.omit(survey_envmeas_join$survey_month))), by = 1),
#                         labels = seq(floor(min(na.omit(survey_envmeas_join$survey_month))) + 1, #ceiling(max(na.omit(survey_envmeas_join$survey_month))), by = 1))) %>%
#         group_by(depth_group, month_group) %>%
#    summarise(value = mean(water_temp), .groups = "drop") %>%
#    mutate(across(where(is.factor), ~as.numeric(as.character(.x)))), aes(month_group, depth_group, fill= as.numeric(value))) +
#  scale_y_discrete(name ="Depth (M)", limits=seq(floor(min(na.omit(survey_envmeas_join$envmeas_depth))), #ceiling(max(na.omit(survey_envmeas_join$envmeas_depth))), by = 5)) +
#  scale_x_discrete(name ="Month", 
#                    limits=seq(1, 12, by=1)) +
#  geom_tile()
```

## Scatter plot of water temperature by depth, month, and system type
```{r}
plotTitle = "Water Temperature by System, Depth, and Month"
fileName="s123_envmeas_wtemp_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)
#  Depth, M Water Temp (C)
create_plot_splot_system_depth_month(df_inrange, depth_var, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Water Temperature by site and month plot
* add grouping by system_type
```{r}


#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Temperature, C
#ggplot(survey_envmeas_join %>%
#         filter(water_temp<50), aes(x=survey_year, y=water_temp, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Temperature (C)") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurement of Water Temperature by Site and Month plot
```{r}
plotTitle = "Temperature by Site and Month"
fileName="s123_envmeas_wtemp_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
create_plot_boxplot_site_month(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Water Temperature by System plot
```{r}
plotTitle = "Temperature by System"
fileName="s123_envmeas_wtemp_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Temperature, C
create_plot_boxplot_system(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

## Environmental measurement of Water Temperature by Site ID plot
* change fill to system rather than site_id (but keep in x)
```{r}
plotTitle = "Temperature by Site"
fileName="s123_envmeas_wtemp_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Temperature, C
create_plot_boxplot_site(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```


# ENVIRONMENTAL MEASUREMENTS: SALINITY
Salinity is recorded in PSU (Practical Salinity Unit).
For Maine ~30 PSU
```{r}
selected_var_plots <- "salinity"
depth_var <- "envmeas_depth"
df_inrange<-create_summary_envmeas_table(survey_envmeas_join, selected_var_plots, 0, 60)
```

## Percentage of Site IDs with environmental measurements of Salinity

* add percentage of index site ids with environmental measurements that also have salinity
```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(salinity, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with salinity measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have salinity: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental salinity measurements
```{r}
select_var_maps <- "salinity"
rcdext_df <- create_table_envmeas_sids(survey_envmeas_join, select_var_maps)

rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_salinity_sids_table.png"))
png(outputPngFileName, height=30*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```
## Map of unique Site IDs with environmental salinity measurements
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Salinity Measurements"
title_var = "Salinity Measurements"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_salinity_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Salinity quantiles
```{r}
quantile(survey_envmeas_join$salinity, na.rm=TRUE)
min(survey_envmeas_join$salinity, na.rm=TRUE)
max(survey_envmeas_join$salinity, na.rm=TRUE)
```

## Environmental measurements where turbidity is greater than 40
```{r}
survey_envmeas_join %>%
    dplyr::select(survey_date, site_id, general_location_name, salinity, conductivity, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
         dplyr::filter(!if_any(c(salinity, site_id), is.na) & salinity>40)
```

## Environmental measurement of Salinity distribution
```{r}
plotTitle = "Distribution of Salinity"
# check distribution
p1<-ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(salinity, site_id), is.na)),
         aes(x=as.numeric(salinity))) + 
  ggtitle(plotTitle) +
  ylab("Density") +
  xlab("Practical Salinity Unit (PSU)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme(plot.title = element_text(hjust = 0.5))

plotTitle = "Distribution of Salinity (truncated)"
# check distribution
p2<-ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(salinity, site_id), is.na) & salinity<50),
         aes(x=as.numeric(salinity))) + 
  ggtitle(plotTitle) +
  ylab("Density") +
  xlab("Practical Salinity Unit (PSU)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme(plot.title = element_text(hjust = 0.5))


grid.arrange(p1, p2, nrow=2)
rm(p1,p2)
```


## Scatter plot of salinity by depth, month, and system type
```{r}
plotTitle = "Salinity by System, Depth, and Month"
fileName="s123_envmeas_salinity_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)
#  Depth (M), Practical Salinity Unit (PSU)
create_plot_splot_system_depth_month(df_inrange, depth_var, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Salinity by Site ID and Month
* add note about depth and sampling year/month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Salinity, ppm
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(salinity, site_id), is.na) & salinity<40), 
#       aes(x=survey_year, y=salinity, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Salinity ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurement of Salinity by Site ID and Month
```{r}
plotTitle = "Salinity by Site and Month"
fileName="s123_envmeas_salinity_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
create_plot_boxplot_site_month(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Salinity by System
```{r}
plotTitle = "Salinity by System"
fileName="s123_envmeas_salinity_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Salinity, Practical Salinity Unit (PSU)
create_plot_boxplot_system(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Salinity by Site ID
```{r}
plotTitle = "Salinity by Site"
fileName="s123_envmeas_salinity_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Practical Salinity Unit (PSU)
create_plot_boxplot_site(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

# ENVIRONMENTAL MEASUREMENTS: TURBIDITY
Turbidity is typically collected with a YSI instrument. Turbidity is recorded in FNU (Formazin Nephelometric Unit) and has a range of 0 to 4000 FNU. 
* add turbidity ranges (what is high turbidity?), range for Maine?
```{r}
selected_var_plots <- "turbidity"
depth_var <- "envmeas_depth"
df_inrange<-create_summary_envmeas_table(survey_envmeas_join, selected_var_plots, 0, 50)
```

## Percentage of Site IDs with environmental measurements of Turbidity
* add percentage of index site ids with environmental measurements that also have turbidity
```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(turbidity, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with turbidity measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have turbidity: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental turbidity measurements
```{r}
select_var_maps <- "turbidity"
rcdext_df <- create_table_envmeas_sids(survey_envmeas_join, select_var_maps)

rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_turbidity_sids_table.png"))
png(outputPngFileName, height=30*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```
## Map of unique Site IDs with environmental turbidity measurements
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Turbidity Measurements"
title_var = "Turbidity Measurements"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_turbidity_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```


## Environmental measurements of Turbidity quantile
```{r}
quantile(survey_envmeas_join$turbidity, na.rm=TRUE)
min(survey_envmeas_join$turbidity, na.rm=TRUE)
max(survey_envmeas_join$turbidity, na.rm=TRUE)
```


## Environmental measurements where turbidity is greater than 40
```{r}
survey_envmeas_join %>%
    dplyr::select(survey_date, site_id, general_location_name, turbidity, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
         dplyr::filter(!if_any(c(turbidity, site_id), is.na) & turbidity>40)
```

## Environmental measurements of turbidity distribution
```{r}
plotTitle = "Distribution of Turbidity"
# check distribution
p1<-ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(turbidity, site_id), is.na)),
         aes(x=as.numeric(turbidity))) + 
  ggtitle(plotTitle) +
  ylab("Density") +
  xlab("Turbidity (Formazin Nephelometric Unit)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme(plot.title = element_text(hjust = 0.5))

plotTitle = "Distribution of Turbidity (truncated)"
# check distribution
p2<-ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(turbidity, site_id), is.na) & turbidity<40),
         aes(x=as.numeric(turbidity))) + 
  ggtitle(plotTitle) +
  ylab("Density") +
  xlab("Turbidity (Formazin Nephelometric Unit)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme(plot.title = element_text(hjust = 0.5))


grid.arrange(p1, p2, nrow=2)
rm(p1,p2)

```

## Scatter plot of turbidity by depth and month
```{r}
plotTitle = "Turbidity by System, Depth, and Month"
plotCaption = "Formazin Nephelometric Unit (FNU)"
fileName="s123_envmeas_turbidity_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)
#  Depth (M), Turbidity (FNU)
create_plot_splot_system_depth_month(df_inrange, depth_var, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Turbidity by Site ID and Month
* add note about depth and sampling year/month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Salinity, ppm
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(turbidity, site_id), is.na) & salinity<40), aes(x=survey_year, y=salinity, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Salinity ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurements of Turbidity by Site ID and Month
```{r}

plotTitle = "Turbidity by Site and Month"
fileName="s123_envmeas_turbidity_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
create_plot_boxplot_site_month(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Turbidity by System
```{r}
plotTitle = "Turbidity by System"
fileName="s123_envmeas_turbidity_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  turbidity, Formazin Nephelometric Unit
create_plot_boxplot_system(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

## Environmental measurements of Turbidity by Site ID
```{r}
plotTitle = "Turbidity by Site"
fileName="s123_envmeas_turbidity_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  turbidity, Formazin Nephelometric Unit
create_plot_boxplot_site(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

# ENVIRONMENTAL MEASUREMENTS: CONDUCTIVITY
Conductivity is typically collected with a YSI instrument. Conductivity is recorded in μS/cm and has a range of 0 to 100,000 μS/cm. 
```{r}
selected_var_plots <- "conductivity"
depth_var <- "envmeas_depth"
df_inrange<-create_summary_envmeas_table(survey_envmeas_join, selected_var_plots, 0, 60000)
```

## Percentage of Site IDs with environmental measurements of Conductivity
* add percentage of index site ids with environmental measurements that also have conductivity

```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(conductivity, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with conductivity measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have conductivity: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental conductivity measurements
```{r}
select_var_maps <- "conductivity"
rcdext_df <- create_table_envmeas_sids(survey_envmeas_join, select_var_maps)

rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_conductivity_sids_table.png"))
png(outputPngFileName, height=30*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```
## Map of unique Site IDs with environmental conductivity measurements
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Conductivity Measurements"
title_var = "Conductivity Measurements"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_conductivity_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Conductivity quantile
```{r}
quantile(survey_envmeas_join$conductivity, na.rm=TRUE)
min(survey_envmeas_join$conductivity, na.rm=TRUE)
max(survey_envmeas_join$conductivity, na.rm=TRUE)
```


## Environmental measurements where conductivity is less than 100
```{r}
survey_envmeas_join %>%
  dplyr::select(survey_date, site_id, general_location_name, conductivity, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
  dplyr::filter(!if_any(c(conductivity, site_id), is.na) & conductivity<100)
```

## Environmental measurements of conductivity distribution
```{r}
plotTitle = "Distribution of Conductivity"
# check distribution
p1<- ggplot(survey_envmeas_join %>%
         filter(!if_any(c(conductivity, site_id), is.na)),
       aes(x=as.numeric(conductivity))) + 
  ylab("Density") +
  xlab("Conductivity (μS/cm)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

plotTitle = "Distribution of Conductivity (truncated)"
# check distribution
p2<- ggplot(survey_envmeas_join %>%
         filter(!if_any(c(conductivity, site_id), is.na) & conductivity<100),
       aes(x=as.numeric(conductivity))) + 
  ylab("Density") +
  xlab("Conductivity (μS/cm)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

grid.arrange(p1, p2, nrow=2)
rm(p1,p2)

```

## Scatter plot of conductivity by depth, month, and system type
```{r}
plotTitle = "Conductivity by System, Depth, and Month"
fileName="s123_envmeas_conductivity_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)
#  Depth (M), Conductivity (μS/cm)
create_plot_splot_system_depth_month(df_inrange, depth_var, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Conductivity by Site ID and Month
* add note about depth and sampling year/month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Salinity, ppm
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(conductivity, site_id), is.na) & salinity<40), aes(x=survey_year, y=salinity, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Salinity ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurements of Conductivity by Site ID and Month
```{r}
plotTitle = "Conductivity by Site and Month"
fileName="s123_envmeas_conductivity_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
create_plot_boxplot_site_month(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Conductivity by System
```{r}
plotTitle = "Conductivity by System"
fileName="s123_envmeas_conductivity_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  conductivity, μS/cm
create_plot_boxplot_system(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

## Environmental measurements of Conductivity by Site ID
```{r}
plotTitle = "Conductivity by Site"
fileName="s123_envmeas_conductivity_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  conductivity, μS/cm
create_plot_boxplot_site(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

# ENVIRONMENTAL MEASUREMENTS: DISSOLVED OXYGEN
Dissolved Oxygen is typically collected with a YSI instrument. Dissolved Oxygen is recorded in mg/L and has a range of 0 to 50 mg/L. 
```{r}
selected_var_plots <- "do"
depth_var <- "envmeas_depth"
df_inrange<-create_summary_envmeas_table(survey_envmeas_join, selected_var_plots, 0, 50)
```

## Percentage of Site IDs with environmental measurements of Dissolved Oxygen
* add percentage of index site ids with environmental measurements that also have dissolved oxygen

```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(do, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with dissolved oxygen measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have dissolved oxygen: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental dissolved oxygen measurements
```{r}
select_var_maps <- "do"
rcdext_df <- create_table_envmeas_sids(survey_envmeas_join, select_var_maps)

rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_do_sids_table.png"))
png(outputPngFileName, height=30*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```
## Map of unique Site IDs with environmental dissolved oxygen measurements
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Dissolved Oxygen Measurements"
title_var = "Dissolved Oxygen Measurements"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_do_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Dissolved Oxygen quantile
```{r}
quantile(survey_envmeas_join$do, na.rm=TRUE)
min(survey_envmeas_join$do, na.rm=TRUE)
max(survey_envmeas_join$do, na.rm=TRUE)
```


## Environmental measurements where dissolved oxygen is greater than 50
```{r}
survey_envmeas_join %>%
    dplyr::select(survey_date, site_id, general_location_name, do, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
         filter(!if_any(c(do, site_id), is.na) & do>50)
```

## Environmental measurements of dissolved oxygen distribution
```{r}
plotTitle = "Distribution of Dissolved Oxygen"
# check distribution
p1<- ggplot(survey_envmeas_join %>%
         filter(!if_any(c(do, site_id), is.na)),
       aes(x=as.numeric(do))) + 
  ylab("Density") +
  xlab("Dissolved Oxygen (mg/L)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

plotTitle = "Distribution of Dissolved Oxygen (truncated)"
# check distribution
p2<- ggplot(survey_envmeas_join %>%
         filter(!if_any(c(do, site_id), is.na) & do<50),
       aes(x=as.numeric(do))) + 
  ylab("Density") +
  xlab("Dissolved Oxygen (mg/L)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

grid.arrange(p1, p2, nrow=2)
rm(p1,p2)

```

## Scatter plot of dissolved oxygen by depth, month, and system type
```{r}
plotTitle = "Dissolved Oxygen by System, Depth, and Month"
fileName="s123_envmeas_do_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)
#  Depth (M), Dissolved Oxygen (mg/L)
create_plot_splot_system_depth_month(df_inrange, depth_var, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Dissolved Oxygen by Site ID and Month
* add note about depth and sampling year/month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_envmeas_do_year"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Dissolved Oxygen, mg/L
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(do, site_id), is.na) & do<50), aes(x=survey_year, y=salinity, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Dissolved Oxygen (mg/L)") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurements of Dissolved Oxygen by Site ID and Month
```{r}
plotTitle = "Dissolved Oxygen by Site and Month"
fileName="s123_envmeas_do_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
#  Dissolved Oxygen (mg/L)
create_plot_boxplot_site_month(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Dissolved Oxygen by System
```{r}
plotTitle = "Dissolved Oxygen by System"
fileName="s123_envmeas_do_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Dissolved Oxygen (mg/L)
create_plot_boxplot_system(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

## Environmental measurements of Dissolved Oxygen by Site ID
```{r}
plotTitle = "Dissolved Oxygen by Site"
fileName="s123_envmeas_do_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  do, μS/cm
create_plot_boxplot_site(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```


# ENVIRONMENTAL MEASUREMENTS: PAR1
Photosynthetically Active Radiation (Channel 1: Up looking), or PAR1, is typically collected with a YSI instrument. PAR1 is recorded in μmoles/sec/m². 
```{r}
selected_var_plots <- "par1"
depth_var <- "envmeas_depth"
df_inrange<-create_summary_envmeas_table(survey_envmeas_join, selected_var_plots, 0, 1500)
```

## Percentage of Site IDs with environmental measurements of PAR1
* add percentage of index site ids with environmental measurements that also have PAR1

```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(par1, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with par1 measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have par1: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental par1 measurements
```{r}
select_var_maps <- "par1"
rcdext_df <- create_table_envmeas_sids(survey_envmeas_join, select_var_maps)

rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_par1_sids_table.png"))
png(outputPngFileName, height=30*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```
## Map of unique Site IDs with environmental par1 measurements
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with PAR1 Measurements"
title_var = "PAR1 Measurements"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_par1_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of par1 quantile
```{r}
quantile(survey_envmeas_join$par1, na.rm=TRUE)
min(survey_envmeas_join$par1, na.rm=TRUE)
max(survey_envmeas_join$par1, na.rm=TRUE)
```


## Environmental measurements where par1 is greater than 1000
```{r}
survey_envmeas_join %>%
    dplyr::select(survey_date, site_id, general_location_name, par1, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
         dplyr::filter(!if_any(c(par1, site_id), is.na) & par1>1000)
```

## Environmental measurements of par1 distribution
```{r}
# check distribution
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(par1, site_id), is.na)),
       aes(x=as.numeric(par1))) + 
  ylab("Density") +
  xlab("PAR1 (μmoles/sec/m²)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

```

## Scatter plot of par1 by depth, month, and system type
```{r}
plotTitle = "PAR1 by System, Depth, and Month"
fileName="s123_envmeas_par1_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)
#  Depth (M), PAR1 (μmoles/sec/m²)
create_plot_splot_system_depth_month(df_inrange, depth_var, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of par1 by Site ID and Month
* add note about depth and sampling year/month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Salinity, ppm
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(par1, site_id), is.na) & salinity<40), aes(x=survey_year, y=salinity, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Salinity ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurements of par1 by Site ID and Month
```{r}
plotTitle = "PAR1 by Site and Month"
fileName="s123_envmeas_par1_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
#  par1, μS/cm
create_plot_boxplot_site_month(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of par1 by System
```{r}
plotTitle = "PAR1 by System"
fileName="s123_envmeas_par1_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  par1, μmoles/sec/m²
create_plot_boxplot_system(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

## Environmental measurements of par1 by Site ID
```{r}
plotTitle = "PAR1 by Site"
fileName="s123_envmeas_par1_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  par1, μmoles/sec/m²
create_plot_boxplot_site(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

# ENVIRONMENTAL MEASUREMENTS: PAR2
Photosynthetically Active Radiation (Channel 2: Down looking), or PAR2, is typically collected with a YSI instrument. PAR2 is recorded in μmoles/sec/m². 
```{r}
selected_var_plots <- "par2"
depth_var <- "envmeas_depth"
df_inrange<-create_summary_envmeas_table(survey_envmeas_join, selected_var_plots, 0, 60)
```

## Percentage of Site IDs with environmental measurements of PAR2
* add percentage of index site ids with environmental measurements that also have PAR2

```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(par2, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with par2 measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have par2: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental par2 measurements
```{r}
select_var_maps <- "par2"
rcdext_df <- create_table_envmeas_sids(survey_envmeas_join, select_var_maps)

rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_par2_sids_table.png"))
png(outputPngFileName, height=30*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```

## Map of unique Site IDs with environmental PAR2 measurements
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with PAR2 Measurements"
title_var = "PAR2 Measurements"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_par2_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of par2 quantile
```{r}
quantile(survey_envmeas_join$par2, na.rm=TRUE)
min(survey_envmeas_join$par2, na.rm=TRUE)
max(survey_envmeas_join$par2, na.rm=TRUE)
```


## Environmental measurements where par2 is greater than 40
```{r}
survey_envmeas_join %>%
    dplyr::select(survey_date, site_id, general_location_name, par2, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
         filter(!if_any(c(par2, site_id), is.na) & par2>40)
```

## Environmental measurements of par2 distribution
```{r}
# check distribution
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(par2, site_id), is.na)),
       aes(x=as.numeric(par2))) + 
  ylab("Density") +
  xlab("PAR2 (μmoles/sec/m²)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

```

## Scatter plot of par2 by depth, month, and system type
```{r}
plotTitle = "PAR2 by System, Depth, and Month"
fileName="s123_envmeas_par2_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)
#  Depth (M), PAR2 (μmoles/sec/m²)
create_plot_splot_system_depth_month(df_inrange, depth_var, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of par2 by Site ID and Month
* add note about depth and sampling year/month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Salinity, ppm
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(par2, site_id), is.na) & salinity<40), aes(x=survey_year, y=salinity, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Salinity ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurements of par2 by Site ID and Month
```{r}
plotTitle = "PAR2 by Site and Month"
fileName="s123_envmeas_par2_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
#  par2, μS/cm
create_plot_boxplot_site_month(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of par2 by System
```{r}
plotTitle = "PAR2 by System"
fileName="s123_envmeas_par2_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  par2, μmoles/sec/m²
create_plot_boxplot_system(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

## Environmental measurements of par2 by Site ID
```{r}
plotTitle = "PAR2 by Site"
fileName="s123_envmeas_par2_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  par2, μmoles/sec/m²
create_plot_boxplot_site(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

# COLLECTION SUMMARY

## Count of empty or NA collection_types
```{r}
# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank or NA Site IDs

nrow(survey_collection_join[survey_collection_join$collection_type == "" | is.na(survey_collection_join$collection_type),])

```

## Summary of collections per year, month, and season
```{r}
df_sub_prj<-subset_prj_df(survey_collection_join %>%
            dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
            dplyr::filter(!if_any(c(collection_type, site_id), is.na)), 
            site_id_prjs, selected_projects)
```

## Percentage of Site IDs with collections
```{r}

names(survey_collection_join)

unique_survey_sids <- unique(survey_sub$site_id)
unique_collect_sids <- unique(survey_collection_join$site_id)
unique_collect_sids_water <- survey_collection_join %>%
  dplyr::filter(!if_any(c(collection_type, site_id), is.na) & collection_type=="water_sample") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_collect_sids_water)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with water collections: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_collect_sids_water)/length(unique_collect_sids))*100
print(paste0("Percentage of site ids with collections that are water: ",round(perc_sids,2),"%"))


unique_survey_sids <- unique(survey_sub$site_id)
unique_collect_sids <- unique(survey_collection_join$site_id)
unique_collect_sids_sed <- survey_collection_join %>%
  dplyr::filter(!if_any(c(collection_type, site_id), is.na) & collection_type=="sed_sample") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_collect_sids_sed)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with sediment collections: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_collect_sids_sed)/length(unique_collect_sids))*100
print(paste0("Percentage of site ids with collections that are sediment: ",round(perc_sids,2),"%"))
```

## Table of collection types where collection type is "sed_sample" or "water_sample"
```{r}
names(survey_collection_join)
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::filter(collection_type=="sed_sample") %>%
  dplyr::select(collection_type, survey_date, project_ids, site_id, other_site_id, general_location_name,
                supervisor, username, recorder_first_name, recorder_last_name, 
                core_datetime_start, core_datetime_end,core_label,core_control,
                core_method,depth_core_collected,core_length,core_diameter,
                core_notes,subcores_taken,purpose_other_cores) %>%
  dplyr::arrange(survey_date)

survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::filter(collection_type=="water_sample") %>%
  dplyr::select(collection_type, survey_date, project_ids, site_id, other_site_id, general_location_name,
                supervisor, username, recorder_first_name, recorder_last_name,
                water_collect_datetime, water_control, water_control_type, water_depth,
                water_vessel_material, water_vessel_color, water_vessel_label, 
                water_collect_notes, was_filtered) %>%
  dplyr::arrange(survey_date)

```

## Table of collection types per year
```{r}
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::select(gid, collection_type, survey_year) %>% 
  dplyr::mutate(ct_year=paste0(collection_type, " ", survey_year)) %>%
  dplyr::group_by(ct_year) %>%
  dplyr::count(ct_year) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_year, into=c("collection_type","year"),sep=" ") %>%
  dplyr::arrange(collection_type, year)
```

## Barplot of collection types per year
```{r}
plotTitle = "Count of collection types by year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_type_year_count_barplot.png"))
png(outputPngFileName,height=5,width=6, units='in', res=150)

ggplot(survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::select(gid, collection_type, survey_year) %>% 
  dplyr::mutate(ct_year=paste0(collection_type, " ", survey_year)) %>%
  dplyr::group_by(ct_year) %>%
  dplyr::count(ct_year) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_year, into=c("collection_type","year"),sep=" ") %>%
  dplyr::arrange(collection_type, year),
       aes(collection_type, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Collection Type") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

print(paste("Plot saved as:",outputPngFileName))
dev.off()

#knitr::include_graphics(outputPngFileName)
```


## table of collection types per system
```{r}
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::select(gid, collection_type, system_type) %>% 
  dplyr::mutate(ct_system=paste0(collection_type, " ", system_type)) %>%
  dplyr::group_by(ct_system) %>%
  dplyr::count(ct_system) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_system, into=c("collection_type","system_type"),sep=" ") %>%
  dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))) %>%
  dplyr::arrange(collection_type, system_type)
```

## Barplot of collections types per system
```{r}
plotTitle = "Count of collection types by system"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_type_system_year_count_barplot.png"))
png(outputPngFileName,height=6,width=12, units='in', res=150)

ggplot(survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::select(gid, collection_type, system_type) %>% 
  dplyr::mutate(ct_system=paste0(collection_type, " ", system_type)) %>%
  dplyr::group_by(ct_system) %>%
  dplyr::count(ct_system) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_system, into=c("collection_type","system_type"),sep=" ") %>%
  dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))) %>%
  dplyr::arrange(collection_type, system_type),
       aes(system_type, n)) +
  geom_bar(aes(fill=collection_type), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("System Type") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill="Collection Type")


print(paste("Plot saved as:",outputPngFileName))
dev.off()

#knitr::include_graphics(outputPngFileName)
```

## table of collection types per site
```{r}
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::select(gid, collection_type, site_id) %>% 
  dplyr::mutate(ct_sid=paste0(collection_type, " ", site_id)) %>%
  dplyr::group_by(ct_sid) %>%
  dplyr::count(ct_sid) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_sid, into=c("collection_type","site_id"),sep=" ") %>%
  dplyr::arrange(collection_type, site_id)
```

## Barplot of collection types per site
```{r}
plotTitle = "Count of collection types by site"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_type_sid_count_barplot.png"))
png(outputPngFileName,height=6,width=18, units='in', res=150)

ggplot(survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::select(gid, collection_type, site_id) %>% 
  dplyr::mutate(ct_sid=paste0(collection_type, " ", site_id)) %>%
  dplyr::group_by(ct_sid) %>%
  dplyr::count(ct_sid) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_sid, into=c("collection_type","site_id"),sep=" ") %>%
  dplyr::arrange(collection_type, site_id),
       aes(site_id, n)) +
  geom_bar(aes(fill=collection_type), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Site ID") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  labs(fill="Collection Type")


print(paste("Plot saved as:",outputPngFileName))
dev.off()

#knitr::include_graphics(outputPngFileName)
```

## table of collection per year and site
```{r}
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::select(gid, survey_year, site_id) %>% 
  dplyr::mutate(yr_sid=paste0(survey_year, " ", site_id)) %>%
  dplyr::group_by(yr_sid) %>%
  dplyr::count(yr_sid) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(yr_sid, into=c("survey_year","site_id"),sep=" ") %>%
  dplyr::arrange(survey_year, site_id)
```

## Barplot of collection per year and site
```{r}
plotTitle = "Count of collections by site and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_all_sids_year_count_barplot.png"))
png(outputPngFileName,height=6,width=18, units='in', res=150)
create_barplot_count_site_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of collection per year and system
```{r}
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::select(gid, survey_year, system_type) %>% 
  dplyr::mutate(yr_system=paste0(survey_year, " ", system_type)) %>%
  dplyr::group_by(yr_system) %>%
  dplyr::count(yr_system) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(yr_system, into=c("survey_year","system_type"),sep=" ") %>%
  dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))) %>%
  dplyr::arrange(survey_year, system_type)
```

## Barplot of collection per year and system
```{r}
plotTitle = "Count of collections by system and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_all_system_year_count_barplot.png"))
png(outputPngFileName,height=6,width=12, units='in', res=150)

ggplot(survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::select(gid, survey_year, system_type) %>% 
  dplyr::mutate(yr_system=paste0(survey_year, " ", system_type)) %>%
  dplyr::group_by(yr_system) %>%
  dplyr::count(yr_system) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(yr_system, into=c("survey_year","system_type"),sep=" ") %>%
  dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))) %>%
  dplyr::arrange(survey_year, system_type),
       aes(system_type, n)) +
  geom_bar(aes(fill=survey_year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("System Type") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill="Year")


print(paste("Plot saved as:",outputPngFileName))
dev.off()

#knitr::include_graphics(outputPngFileName)
```

## table of collection types per site and year
```{r}
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::select(gid, collection_type, site_id, survey_year) %>% 
  dplyr::mutate(ct_sid=paste0(collection_type, " ", site_id, " ", survey_year)) %>%
  dplyr::group_by(ct_sid) %>%
  dplyr::count(ct_sid) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_sid, into=c("collection_type","site_id","survey_year"),sep=" ") %>%
  dplyr::arrange(collection_type, site_id, survey_year)
```

## Barplot of collection types per site and year
```{r}
plotTitle = "Count of collection types by site and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_type_sid_count_barplot.png"))
png(outputPngFileName,height=6,width=90, units='in', res=300)

ggplot(survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, collection_type), is.na)) %>%
  dplyr::select(gid, collection_type, site_id, survey_year) %>% 
  dplyr::mutate(ct_sid=paste0(collection_type, " ", site_id, " ", survey_year)) %>%
  dplyr::group_by(ct_sid) %>%
  dplyr::count(ct_sid) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_sid, into=c("collection_type","site_id","survey_year"),sep=" ") %>%
  dplyr::arrange(collection_type, site_id, survey_year),
       aes(collection_type, n)) +
  geom_bar(aes(fill=survey_year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Site ID") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  labs(fill="Year") +
  facet_grid(~ site_id)


print(paste("Plot saved as:",outputPngFileName))
dev.off()

#knitr::include_graphics(outputPngFileName)
```

# COLLECTIONS: WATER
## Summary of water collections per year, month, and season
```{r}
dfname <- "Water Collections"
selected_coltype <- "water_sample"
df_sub_prj<-subset_prj_df(survey_collection_join %>%
            dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
            dplyr::filter(!if_any(c(collection_type, site_id), is.na) & collection_type==selected_coltype), 
          site_id_prjs, selected_projects)
```

## Table of unique Site IDs with water collections
```{r}
rcdext_df <- create_table_sids(survey_collection_join %>%
            dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
            dplyr::filter(!if_any(c(collection_type, site_id), is.na) & collection_type==selected_coltype), site_ids_sfdf)

rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_water_sids_table.png"))
png(outputPngFileName, height=50*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```

## Map of unique Site IDs with water collections
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Water Collections"
title_var = "Water Collections"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_water_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Table of water collections per season
```{r}
create_table_count_season(df_sub_prj)
```
## Barplot of water collections per season
```{r}
plotTitle = "Count of water collections by season"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_water_season_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_season(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of water collections per season and year
```{r}
create_table_count_season_year(df_sub_prj)
```

## Barplot of water collections per season and year
```{r}
plotTitle = "Count of water collections by season and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_water_season_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_season_year(df_sub_prj, dfname)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Table of water collections per system
```{r}
create_table_count_system(df_sub_prj)
```
## Barplot of water collections per system
```{r}
plotTitle = "Count of water collections by system"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_water_system_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_system(df_sub_prj, dfname)
dev.off()
#knitr::include_graphics(outputPngFileName)
```
## Table of water collections per system and year
```{r}
create_table_count_system_year(df_sub_prj)
```
## Barplot of water collections per system and year
```{r}
plotTitle = "Count of water collections by system and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_water_system_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_system_year(df_sub_prj, dfname)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of water collections per month and year
```{r}
create_table_count_month_year(df_sub_prj)
```
## Barplot of water collections per month and year
```{r}
plotTitle = "Count of water collections by month and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_water_month_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_month_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of water collections per site and year
```{r}
create_table_count_site_year(df_sub_prj, site_ids_sfdf)
```

## Barplot of water collections per site and year
```{r}
plotTitle = "Count of water collections by site and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_water_sids_year_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)
create_barplot_count_site_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Table of count of water collections by Site ID
```{r}
create_table_count_site(df_sub_prj, site_ids_sfdf)
```

## Count of water collections by Site ID plot
```{r}
plotTitle = "Count of water collections by site"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_water_sids_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_site(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

# COLLECTIONS: SEDIMENT
## Summary of water collections per year, month, and season
```{r}
dfname <- "Sediment Collections"
selected_coltype <- "sed_sample"
df_sub_prj<-subset_prj_df(survey_collection_join %>%
            dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
            dplyr::filter(!if_any(c(collection_type, site_id), is.na) & collection_type==selected_coltype), 
          site_id_prjs, selected_projects)
```
## Table of unique Site IDs with sediment collections
```{r}
rcdext_df <- create_table_sids(survey_collection_join %>%
            dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
            dplyr::filter(!if_any(c(collection_type, site_id), is.na) & collection_type==selected_coltype), site_ids_sfdf)

rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sediment_sids_table.png"))
png(outputPngFileName, height=50*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```

## Map of unique Site IDs with sediment collections
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Sediment Collections"
title_var = "Sediment Collections"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sediment_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Table of sediment collections per season
```{r}
create_table_count_season(df_sub_prj)
```
## Barplot of sediment collections per season
```{r}
plotTitle = "Count of sediment collections by season"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sediment_season_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_season(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```
## table of sediment collections per season and year
```{r}
create_table_count_season_year(df_sub_prj)
```

## Barplot of sediment collections per season and year
```{r}
plotTitle = "Count of sediment collections by season and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sediment_season_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_season_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```
## Table of sediment collections per system
```{r}
create_table_count_system(df_sub_prj)
```
## Barplot of sediment collections per system
```{r}
plotTitle = "Count of sediment collections by system"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sediment_system_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_system(df_sub_prj, dfname)
dev.off()
#knitr::include_graphics(outputPngFileName)
```
## Table of water sediment per system and year
```{r}
create_table_count_system_year(df_sub_prj)
```
## Barplot of water sediment per system and year
```{r}
plotTitle = "Count of water sediment by system and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sediment_system_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_system_year(df_sub_prj, dfname)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of sediment collections per month and year
```{r}
create_table_count_month_year(df_sub_prj)
```
## Barplot of sediment collections per month and year
```{r}
plotTitle = "Count of sediment collections by month and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sediment_month_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_month_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of sediment collections per site and year
```{r}
create_table_count_site_year(df_sub_prj, site_ids_sfdf)
```

## Barplot of sediment collections per site and year
```{r}
plotTitle = "Count of sediment collections by site and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sediment_sids_year_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)
create_barplot_count_site_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Table of count of sediment collections by Site ID
```{r}
create_table_count_site(df_sub_prj, site_ids_sfdf)
```

## Count of sediment collections by Site ID plot
```{r}
plotTitle = "Count of sediment collections by site"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sediment_sids_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_site(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

# COLLECTIONS: WATER COLLECTION DEPTH
```{r}
selected_var_plots<-depth_var <- "water_depth"
selected_plot_coltype <- "water_sample"
df_inrange<-create_summary_col_table(survey_collection_join, selected_plot_coltype, 0, 100)
```

## Percentage of Site IDs with water collection depths
```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_collect_sids <- unique(survey_collection_join$site_id)
unique_collect_sids_depth <- survey_collection_join %>%
  dplyr::filter(!if_any(c(water_depth, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_collect_sids_depth)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with water collections: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_collect_sids_depth)/length(unique_collect_sids))*100
print(paste0("Percentage of site ids with collection depths: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with water collection depths
```{r}
select_var_maps <- "water_depth"
rcdext_df <- create_table_colmeas_sids(survey_collection_join, select_var_maps)
rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_wdepth_sids_table.png"))
png(outputPngFileName, height=30*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```

## Map of unique Site IDs with water collection depths
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Water Collection Depths"
title_var = " Water Collection Depths"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_wdepth_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Water collection depth quantiles
```{r}
#names(survey_collection_join)
quantile(survey_collection_join$water_depth, na.rm=TRUE)
min(survey_collection_join$water_depth, na.rm=TRUE)
max(survey_collection_join$water_depth, na.rm=TRUE)
```

## Water collections where water_depth is greater than 200
```{r}
survey_collection_join %>%
    dplyr::select(survey_date, site_id, general_location_name, water_depth, system_type) %>%
           filter(!if_any(c(water_depth, site_id), is.na) & water_depth>200)
```

## Water collection depth distribution
```{r}
# check distribution
p1<-ggplot(survey_collection_join %>%
           filter(!if_any(c(water_depth, site_id), is.na)),aes(x=as.numeric(water_depth))) + 
  ylab("Density") +
  xlab("Water Collection Depth (M)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

# check distribution
p2<-ggplot(survey_collection_join %>%
           filter(!if_any(c(water_depth, site_id), is.na) & water_depth<200),aes(x=as.numeric(water_depth))) + 
  ylab("Density") +
  xlab("Water Collection Depth (M)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

grid.arrange(p1, p2, nrow=2)
rm(p1,p2)
```


## Water collection by site and month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"

#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Depth, M
#ggplot(survey_collection_join %>%
#         filter(!if_any(c(water_depth, site_id), is.na) & water_depth<200), aes(x=survey_year, y=water_depth, fill=survey_year)) + 
#  geom_boxplot() +
#  xlab("Depth ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()

#plotTitle = "Water collection depth by Site and Month"
#fileName="s123_water_collect_depth_site_month"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=16,width=6, units='in', res=300)
#  Depth, M
#ggplot(survey_collection_join %>%
#         filter(water_depth<200), aes(x=site_id, y=as.numeric(water_depth), fill=site_id)) + 
#  geom_boxplot() +
#  xlab("Depth ()") +
#  xlab("Site ID") +
#  facet_grid(survey_month ~ .) +
#  ggtitle(plotTitle) +
#  theme(plot.title = element_text(hjust = 0.5)) +
#  theme(axis.text.x = element_text(angle=50, hjust=1)) +
#  theme(legend.position = "none") 
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()

##knitr::include_graphics(outputPngFileName)
```

## Water Collection Depth by System
```{r}
plotTitle = "Water Collection Depth by System"
fileName="s123_collect_wdepth_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Depth (M)
create_plot_boxplot_system(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Water Collection Depth by Site ID
```{r}
plotTitle = "Water collection depth by Site"
fileName="s123_collect_wdepth_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Depth, M
create_plot_boxplot_site(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```


# COLLECTIONS: CORE COLLECTION DEPTH
```{r}
selected_var_plots<-depth_var <- "depth_core_collected"
selected_plot_coltype <- "sed_sample"
df_inrange<-create_summary_col_table(survey_collection_join, selected_plot_coltype, 0, 40)
```

## Percentage of Site IDs with core collection depths
* total cores collected overall, by site id, and by system
```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_collect_sids <- unique(survey_collection_join$site_id)
unique_collect_sids_depth <- survey_collection_join %>%
  dplyr::filter(!if_any(c(depth_core_collected, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_collect_sids_depth)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with core collections: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_collect_sids_depth)/length(unique_collect_sids))*100
print(paste0("Percentage of site ids with collection depths: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with core collection depths
```{r}
select_var_maps <- "depth_core_collected"
rcdext_df <- create_table_colmeas_sids(survey_collection_join, select_var_maps)
rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sdepth_sids_table.png"))
png(outputPngFileName, height=50*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```

## Map of unique Site IDs with core collection depths
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Sediment Collection Depths"
title_var = " Sediment Collection Depths"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sdepth_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```


## Core collection depth distribution
```{r}
#names(survey_collection_join)

quantile(survey_collection_join$depth_core_collected, na.rm=TRUE)
min(survey_collection_join$depth_core_collected, na.rm=TRUE)
max(survey_collection_join$depth_core_collected, na.rm=TRUE)

# check distribution
ggplot(survey_collection_join %>%
           filter(!if_any(c(depth_core_collected, site_id), is.na)),aes(x=as.numeric(depth_core_collected))) + 
  ylab("Density") +
  xlab("Core Collection Depth (M)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

```


## Core collection by site and month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"

#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Depth, M
#ggplot(survey_collection_join %>%
#         filter(!if_any(c(depth_core_collected, site_id), is.na)), aes(x=survey_year, y=depth_core_collected, fill=survey_year)) + 
#  geom_boxplot() +
#  xlab("Depth ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()

#plotTitle = "Sediment collection depth by Site and Month"
#fileName="s123_sediment_collect_depth_site_month"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=16,width=6, units='in', res=300)
#  Depth, M
#ggplot(survey_collection_join %>%
#         filter(!if_any(c(depth_core_collected, site_id), is.na)), aes(x=site_id, y=as.numeric(depth_core_collected), fill=site_id)) + 
#  geom_boxplot() +
#  xlab("Depth ()") +
#  xlab("Site ID") +
#  facet_grid(survey_month ~ .) +
#  ggtitle(plotTitle) +
#  theme(plot.title = element_text(hjust = 0.5)) +
#  theme(axis.text.x = element_text(angle=50, hjust=1)) +
#  theme(legend.position = "none") 
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()

##knitr::include_graphics(outputPngFileName)
```

## Sediment Collection Depth by System
```{r}
plotTitle = "Sediment Collection Depth by System"
fileName="s123_collect_sdepth_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Depth, M
create_plot_boxplot_system(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Sediment Collection Depth by Site ID
```{r}
plotTitle = "Sediment collection depth by Site"
fileName="s123_collect_sdepth_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Depth, M
create_plot_boxplot_site(df_inrange, selected_var_plots)
print(paste("Plot saved as:",outputPngFileName))
dev.off()
#knitr::include_graphics(outputPngFileName)

```

# FILTER SUMMARY

## unique site_ids with filters
* total filters per (siteid, system), average filters per (siteid, system) filter type by (siteid, system)
* total cores per (siteid, system), average cores per (siteid, system)
* total cores collected overall, by site id, and by system
* total counts of filter types
* percentage of filters that have been prefiltered

## Count of empty or NA filter_type or filter_labels
```{r}
# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank or NA Site IDs

nrow(clean_filter_join[clean_filter_join$filter_type == "" | is.na(clean_filter_join$filter_type),])
nrow(clean_filter_join[clean_filter_join$filter_label == "" | is.na(clean_filter_join$filter_label),])

```

## Summary of filters per year, month, and season
```{r}

dfname <- "Filters"
df_sub_prj<-subset_prj_df(clean_filter_join %>%
            dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
            filter(!if_any(c(collection_global_id, gid, filter_type, filter_label), is.na)),
          site_id_prjs, selected_projects)

```


## Percentage of filters that have been prefiltered
```{r}
# total collection_global_id with nitex
# total collection_global_id not nitex
# if they share a collection_global_id, then the collection was prefiltered
names(clean_filter_join)

cids <-clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(collection_global_id) %>%
  dplyr::distinct(collection_global_id)


cid_nitex<-clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(collection_global_id, filter_type) %>%
  dplyr::filter(filter_type=="nitex") %>%
  dplyr::distinct(collection_global_id) %>%
  dplyr::mutate(filter_type="nitex")

cid_other<-clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(collection_global_id, filter_type) %>%
  dplyr::filter(filter_type!="nitex") %>%
  #dplyr::mutate(filter_type=factor(filter_type, levels= c("nitex", "gff", "supor", "cn", "other"))) %>%
  #dplyr::arrange(filter_type) %>%
  dplyr::distinct(collection_global_id) %>%
  dplyr::mutate(filter_type="not_nitex")

nrow(cid_nitex) + nrow(cid_other)

## if there is a count of 2, then there was a prefilter and filter on the same water collection
perc_prefilter<-dplyr::full_join(cid_nitex,cid_other) %>%
  dplyr::group_by(collection_global_id) %>%
  dplyr::count(collection_global_id) %>%
  dplyr::group_by(n) %>%
  dplyr::count(n) %>%
  dplyr::mutate(perc_prefilter=(nn/nrow(cids))*100)

print(paste0("Percentage of water collections with prefilters & filters: ",round(perc_prefilter$perc_prefilter[perc_prefilter$n==2],2),"%"))
print(paste0("Percentage of water collections with only prefilters or filters (not both): ",round(perc_prefilter$perc_prefilter[perc_prefilter$n==1],2),"%"))


```

## Table of unique Site IDs with filters
```{r}
select_var_maps <- "filter_type"
rcdext_df <- create_table_filters_sids(clean_filter_join, select_var_maps)
rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_all_sids_table.png"))
png(outputPngFileName, height=30*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```

## Map of unique Site IDs with filters
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Filters"
title_var = "Filters"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_all_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Table of filters per season
```{r}
create_table_count_season(df_sub_prj)
```

## Barplot of filters per season
```{r}
plotTitle = "Count of filters by season"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_all_season_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_season(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of filters per season and year
```{r}
create_table_count_season_year(df_sub_prj)
```

## Barplot of filters per season and year
```{r}
plotTitle = "Count of filters by season and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_all_season_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_season_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of filters per month and year
```{r}
create_table_count_month_year(df_sub_prj)
```

## Barplot of filters per month and year
```{r}
plotTitle = "Count of filters by month and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_all_month_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_month_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of filters per site and year
```{r}
create_table_count_site_year(df_sub_prj, site_ids_sfdf)
```

## Barplot of filters per site and year
```{r}
plotTitle = "Count of filters by site and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_all_sids_year_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)
create_barplot_count_site_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of filter types per year
```{r}
create_table_count_filtertype_year(df_sub_prj)
```

## table of filter types where filter type is "other"
```{r}
clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_global_id, gid, season, filter_type, filter_label), is.na)) %>%
  dplyr::filter(filter_type=="other") %>%
  dplyr::select(filter_type, filter_type_other, survey_date, project_ids, site_id, other_site_id, general_location_name,
                supervisor, username, recorder_first_name, recorder_last_name) %>%
  dplyr::arrange(filter_type_other)

```

## Barplot of filter types per year
```{r}
plotTitle = "Count of filter types by year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_type_year_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)
create_barplot_count_filtertype_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)

```
## table of filter types per system
```{r}
create_table_count_filtertype_system(df_sub_prj)
```

## Barplot of filter types per system
```{r}
plotTitle = "Count of filter types by system"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_type_system_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)
create_barplot_count_filtertype_system(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

# SUBCORE SUMMARY

* total cores per (siteid, system), average cores per (siteid, system)
* total cores collected overall, by site id, and by system

## Count of empty or NA min_subcore_barcode or max_subcore_barcode
```{r}
names(clean_subcore_join)
# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank or NA Site IDs

nrow(clean_subcore_join[clean_subcore_join$min_subcore_barcode == "" | is.na(clean_subcore_join$min_subcore_barcode),])
nrow(clean_subcore_join[clean_subcore_join$max_subcore_barcode == "" | is.na(clean_subcore_join$max_subcore_barcode),])

```
## Table of unique Site IDs with subcores
```{r}
rcdext_df <- create_table_subcores_sids(clean_subcore_join)
rcdext_fmt_df <- fmt_sids_table(rcdext_df %>%
                                  dplyr::filter(RecordsExist=="Yes")) %>%
  dplyr::select(-RecordsExist)
outputPngFileName <- file.path(outputPngFolder,paste0("s123_subcores_all_sids_table.png"))
png(outputPngFileName, height=50*nrow(rcdext_fmt_df), width=300*ncol(rcdext_fmt_df))
grid.table(rcdext_fmt_df, theme=tt3)
dev.off()
##knitr::include_graphics(outputPngFileName)
rcdext_fmt_df
```

## Map of unique Site IDs with subcores
```{r}
#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Subcores"
title_var = "Subcores"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_subcores_all_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)
create_map_sids(boundingbox_sids, countries_sfdf, WBD_sfdf, lakes_sfdf, rivers_sfdf, site_ids_sfdf,
                rcdext_df %>%
                  dplyr::filter(RecordsExist=="Yes"), title_var)
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## Summary of subcores per year, month, and season
```{r}
dfname <- "Subcores"
df_sub_prj<-subset_prj_df(clean_subcore_join %>%
          dplyr::filter(!if_any(c(gid, survey_global_id, collection_global_id), is.na)),
          site_id_prjs, selected_projects)
```

## Table of subcores per season
```{r}
create_table_count_season(df_sub_prj)
```
## Barplot of subcores per season
```{r}
plotTitle = "Count of Subcores by season"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_subcores_all_season_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_season(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of filters per season and year
```{r}
create_table_count_season_year(df_sub_prj)
```

## Barplot of subcores per season and year
```{r}
plotTitle = "Count of subcores by season and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_subcores_all_season_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_season_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of subcores per month and year
```{r}
create_table_count_month_year(df_sub_prj)

```
## Barplot of subcores per month and year
```{r}
plotTitle = "Count of subcores by month and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_subcores_all_month_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)
create_barplot_count_month_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```

## table of subcores per site and year
```{r}
create_table_count_site_year(df_sub_prj, site_ids_sfdf)
```

## Barplot of subcores per site and year
```{r}
plotTitle = "Count of subcores by site and year"
# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_subcores_all_sids_year_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)
create_barplot_count_site_year(df_sub_prj, dfname) 
dev.off()
#knitr::include_graphics(outputPngFileName)
```
