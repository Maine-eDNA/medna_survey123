---
title: "Maine-eDNA Survey123 Summary"
output:
  html_notebook: default
  pdf_document: default
---

Prepared by: Melissa Kimble



This notebook:
1. Loads Survey123 data
2. Generates SiteID summaries

* add in all YSI sonde measurements
* eg par1, par2, turbidity, do, conductivity, water temp
* add map versions of each of these

* geom_sf
* bubble plots with siteid
* add map of regions

# LOAD PROJECT VARIABLES
```{r, echo=FALSE, results="hide", messages=FALSE}
# Load and Install Libraries
source("medna_survey123.R")
## Check libraries & install
LibraryList<-c("data.table","dplyr","lubridate","stringr","ggplot2","scales", "zoo", "tidyr", "gridExtra", "sf", "googlesheets4", "viridis")
install_or_load_pack(LibraryList)
overwrite = TRUE
inputFolder = "../data/02_Working/PyOutput/"
originalFolder = "../data/01_Original/"
outputFolder = "../data/02_Working/ROutput/"

outputPngFolder = "../figures/rcode/"

todaysDateFn = format(Sys.Date(), "%Y%m%d")

WGS84_SRID = 4326

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))
```

# LOAD SHAPFILES
```{r, echo=FALSE, results="hide", messages=FALSE}
InputShpFolder = "G:/My Drive/Dissertation/01_Data"

# Watershed Boundary Dataset (WBD), National Hydrography Dataset (NHD), United States Geological Survey (USGS)
WBDHU8SHP = paste0(InputShpFolder,"/02_Working/Hydrography/USGS_NHD/20200615/WBDHU8_MENH_NEaq/WBDHU8_MENH_NEA.shp")
WBD_sfdf<-sf::st_read(WBDHU8SHP)
#names(WBD_sfdf)

# United States Census state admin boundaries 2021
UScensusSHP = paste0(InputShpFolder,"/01_Original/Census/2021/tl_2021_us_state/tl_2021_us_state.shp")
US_census_sfdf<-sf::st_read(UScensusSHP)
#names(US_coast_sfdf)

# NaturalEarth 10m North American lakes
lakesSHP = paste0(InputShpFolder,"/01_Original/NaturalEarth/ne_10m_lakes_north_america/ne_10m_lakes_north_america.shp")
lakes_sfdf<-sf::st_read(lakesSHP)
#names(lakes_sfdf)

# NaturalEarth 10m North American rivers
riversSHP = paste0(InputShpFolder,"/01_Original/NaturalEarth/ne_10m_rivers_north_america/ne_10m_rivers_north_america.shp")
rivers_sfdf<-sf::st_read(riversSHP)
#names(lakes_sfdf)

# NaturalEarth 10m admin countries boundary
countriesSHP = paste0(InputShpFolder,"/01_Original/NaturalEarth/ne_10m_admin_0_countries/ne_10m_admin_0_countries.shp")
countries_sfdf<-sf::st_read(countriesSHP)
#names(countries_sfdf)

# place all data in same coordinate system
US_census_sfdf=st_transform(US_census_sfdf, crs=st_crs(WBD_sfdf))

#US_census_sfdf$NAME

boundingbox<-st_bbox(US_census_sfdf %>%
          filter(NAME == "Maine" | NAME == "New Hampshire" | NAME == "Massachusetts"))
```

## Map of Watersheds
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Watersheds"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_all_watersheds_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill = region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox$xmin[[1]], boundingbox$xmax[[1]]*0.98), 
           ylim = c(boundingbox$ymin[[1]], boundingbox$ymax[[1]]*1.02), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()

knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```


# LOAD GSHEETs
```{r, echo=FALSE, results="hide", messages=FALSE}
site_ids_gsheet <- read_sheet("https://docs.google.com/spreadsheets/d/1IVn6Ui80VZZrFjjRCy6FaOwh_5fR9ZJj4OxNypYBduc/edit?usp=sharing")
```
## Column names and number of rows
```{r}
site_ids_sfdf <- site_ids_gsheet %>%
  dplyr::select(SiteID, `General Location Name`, `Intended Purpose`, `Latitude`, `Longitude`, `System Type`, `Region Code`, 
         `Survey123 Filter Count`, `Survey123 Core Count`) %>%
  sf::st_as_sf(.,coords=c('Longitude', 'Latitude'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>% # reseparate out lat, long
  dplyr::rename(site_id = SiteID) %>%
  dplyr::rename(general_location_name = `General Location Name`) %>%
  dplyr::rename(projects = `Intended Purpose`) %>%
  dplyr::rename(system_type = `System Type`) %>%
  dplyr::rename(region_code = `Region Code`) %>%
  dplyr::rename(s123_filter_count = `Survey123 Filter Count`) %>%
  dplyr::rename(s123_core_count = `Survey123 Core Count`) 
# displays column names & number of rows - 65
nrow(site_ids_sfdf);names(site_ids_sfdf)

boundingbox_sids<-st_bbox(site_ids_sfdf)
```

## Map of SiteIDs
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_all_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.05) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, aes(fill=region_code), pch=21, color="black") +
#  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
#            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox$xmin[[1]], boundingbox$xmax[[1]]*0.98), 
           ylim = c(boundingbox$ymin[[1]], boundingbox$ymax[[1]]*1.02), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

plotTitle = "Maine-eDNA Sites"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_all_sids_zoom_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, aes(fill=region_code),pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=site_ids_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)
#rm(WBD_sfdf,ME_coast_sfdf)
```

# LOAD SURVEY123 CSVs
*include figure of how tables are related
```{r}
#load data
survey_sub <- data.table::fread(paste0(inputFolder,'eDNA_Sampling_v14_sub.csv'))
survey_crew <- data.table::fread(paste0(originalFolder,'rep_crew_1.csv'))
survey_envmeas_join <- data.table::fread(paste0(inputFolder,'survey_envmeas_join.csv'))
survey_collection_join <- data.table::fread(paste0(inputFolder,'survey_collection_join.csv'))
clean_filter_join <- data.table::fread(paste0(inputFolder,'clean_filter_join.csv'))
clean_subcore_join <- data.table::fread(paste0(inputFolder,'clean_subcore_join.csv'))
knitr::include_graphics(outputPngFileName)
```

## Column names and number of rows
```{r}
# displays column names & number of rows - 6589
nrow(survey_sub);names(survey_sub)
nrow(survey_envmeas_join);names(survey_envmeas_join)
nrow(survey_collection_join);names(survey_collection_join)
nrow(clean_filter_join);names(clean_filter_join)
nrow(clean_subcore_join);names(clean_subcore_join)
# Head displays the first 6 rows of the data.table
#head(survey_sub);head(survey_envmeas_join);head(survey_collection_join);head(clean_filter_join);head(clean_filter_join)
```

# SURVEY SUMMARY 
* Jun, Jul, Aug (Summer)
* Sep, Oct, Nov (Fall)
* Dec, Jan, Feb (Winter)
* Mar, Apr, May (Spring)
* records per season, records per year, records per month
* (count of survey records, count of filters, count of cores, count of environmental measurements), barcharts grouped or stacked by year per site


## Count of empty or NA site_ids
```{r}
# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank or NA Site IDs

nrow(survey_sub[survey_sub$site_id == "" | is.na(survey_sub$site_id),])

```


## Table of unique Site IDs with survey records
```{r}
# export table with site ids & names
survey_sub_sids <- survey_sub %>%
  dplyr::select(site_id) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- survey_sub %>% 
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
survey_sub_sids_all <- rbind(sid_other, survey_sub_sids, fill=TRUE)

survey_sub_sids_all <- survey_sub_sids_all %>%
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_sids_table.png"))
png(outputPngFileName, height=25*nrow(survey_sub_sids_all), width=500*ncol(survey_sub_sids_all))
grid.table(survey_sub_sids_all, theme=tt3)
dev.off()
#knitr::include_graphics(outputPngFileName)
survey_sub_sids_all
```

## Map of unique Site IDs with survey records
* separate out "other" into different boxplots/maps
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

survey_sub_sids_all_sfdf<-survey_sub_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Environmental Measurements"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=survey_sub_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=survey_sub_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Summary of survey records per year, month, and season
```{r}

# add seasons to survey_sub
survey_sub <- survey_sub %>% 
  mutate(season = case_when(survey_month==12 | survey_month==1 | survey_month==2 ~ "Winter", 
                            survey_month==3 | survey_month==4 | survey_month==5 ~ "Spring",
                            survey_month==6 | survey_month==7 | survey_month==8 ~ "Summer",
                            survey_month==9 | survey_month==10 | survey_month==11 ~ "Fall")) %>%
  mutate(season_year = paste0(season," ",survey_year))
  
nrow(survey_sub)

```

## Table of survey records per season
```{r}
survey_sub %>%
  filter(!if_any(c(survey_GlobalID, season), is.na)) %>%
  dplyr::select(survey_GlobalID, season) %>% 
  dplyr::group_by(season) %>%
  dplyr::count(season) %>%
  dplyr::mutate(perc=round((n/nrow(survey_sub))*100, 2))
```
## Barplot of survey records per season
```{r}
plotTitle = "Count of survey records by season"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_season_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(survey_sub %>%
  filter(!if_any(c(survey_GlobalID, season), is.na)) %>%
  dplyr::select(survey_GlobalID, season) %>% 
  dplyr::group_by(season) %>%
  dplyr::count(season) %>%
  dplyr::mutate(perc=round((n/nrow(survey_sub))*100, 2)) %>%
  dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))),
       aes(season, n, fill=season)) +
  geom_bar(stat="identity") +
  xlab("Season") +
  ylab("Count") +
  ggtitle(plotTitle) +
  viridis::scale_fill_viridis(discrete = T) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```
## Table of survey records per season and year
```{r}
survey_sub %>%
  filter(!if_any(c(survey_GlobalID, season_year), is.na)) %>%
  dplyr::select(survey_GlobalID, season_year) %>% 
  dplyr::group_by(season_year) %>%
  dplyr::count(season_year) %>%
  dplyr::mutate(perc=round((n/nrow(survey_sub))*100, 2)) %>%
  tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
  dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))) %>%
  dplyr::arrange(season, year)
```

## Barplot of survey records per season and year
```{r}
plotTitle = "Count of survey records by season and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_season_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(survey_sub %>%
  filter(!if_any(c(survey_GlobalID, season_year), is.na)) %>%
  dplyr::select(survey_GlobalID, season_year) %>% 
  dplyr::group_by(season_year) %>%
  dplyr::count(season_year) %>%
  dplyr::mutate(perc=round((n/nrow(survey_sub))*100, 2)) %>%
  tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
  dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))),
       aes(season, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Season") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## table of survey records per month and year
```{r}
survey_sub %>%
  filter(!if_any(c(survey_GlobalID, survey_date), is.na)) %>%
  dplyr::select(survey_GlobalID, survey_date) %>% 
  dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
  dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
  dplyr::group_by(survey_yrmo) %>%
  dplyr::count(survey_yrmo) %>%
  dplyr::mutate(perc=round((n/nrow(survey_sub))*100, 2)) %>%
  tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
  dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
  dplyr::arrange(month, year)

```

## Barplot of survey records per month and year
```{r}
plotTitle = "Count of survey records by month and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_month_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(survey_sub %>%
  filter(!if_any(c(survey_GlobalID, survey_date), is.na)) %>%
  dplyr::select(survey_GlobalID, survey_date) %>% 
  dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
  dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
  dplyr::group_by(survey_yrmo) %>%
  dplyr::count(survey_yrmo) %>%
  dplyr::mutate(perc=round((n/nrow(survey_sub))*100, 2)) %>%
  tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
  dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))),
       aes(month, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Month") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```
## table of survey records per site and year
```{r}
survey_sub %>%
  filter(!if_any(c(survey_GlobalID, survey_date), is.na)) %>%
  dplyr::select(survey_GlobalID, site_id, survey_year) %>% 
  dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
  dplyr::group_by(sid_year) %>%
  dplyr::count(sid_year) %>%
  dplyr::mutate(perc=round((n/nrow(survey_sub))*100, 2)) %>%
  tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
  dplyr::arrange(site_id, year)

```
## Barplot of survey records per site and year
```{r}
plotTitle = "Count of survey records by site and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_survey_all_sids_year_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)

ggplot(survey_sub %>%
  filter(!if_any(c(survey_GlobalID, survey_date), is.na)) %>%
  dplyr::select(survey_GlobalID, site_id, survey_year) %>% 
  dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
  dplyr::group_by(sid_year) %>%
  dplyr::count(sid_year) %>%
  dplyr::mutate(perc=round((n/nrow(survey_sub))*100, 2)) %>%
  tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
  dplyr::arrange(site_id, year),
       aes(site_id, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Site ID") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

# CREW SUMMARY

## Percentage of survey records with associated crew information
```{r}
nrow(survey_sub)

unique_survey_gids <- unique(survey_sub$survey_GlobalID)
unique_envmeas_survey_gids <- unique(survey_crew$ParentGlobalID) 

perc_gids<-(length(unique_envmeas_survey_gids)/length(unique_survey_gids))*100
print(paste0("Percentage of survey records with crew information: ",round(perc_gids,2),"%"))

```

# ENVIRONMENTAL MEASUREMENTS SUMMARY

"survey_GlobalID"       "survey_date"           "survey_month"         
"survey_year"           "projects"              "supervisor"            "username"             
"recorder_first_name"   "recorder_last_name"    "system_type"           "site_id"              
"other_site_id"         "general_location_name" "envmeas_date"          "envmeas_depth"        
"envmeas_instrument"    "ctd_filename"          "ctd_notes"             "ysi_filename"         
"ysi_model"             "ysi_serial_number"     "ysi_notes"             "secchi_depth"         
"secchi_notes"          "niskin_number"         "niskin_notes"          "other_instruments"    
"env_measurements"      "flow_rate"             "water_temp"            "salinity"             
"ph"                    "par1"                  "par2"                  "turbidity"            
"conductivity"          "do"                    "pheophytin"            "chla"                 
"no3no2"                "no2"                   "nh4"                   "phosphate"            
"bottom_substrate"      "lab_date"              "envmeas_notes"         "envmeas_GlobalID"     
"survey_edit_date"      "survey_create_date"    "envmeas_create_date" 

* Jun, Jul, Aug (Summer)
* Sep, Oct, Nov (Fall)
* Dec, Jan, Feb (Winter)
* Mar, Apr, May (Spring)
* measurements per season, measurements per year, measurements per month
* (count of survey records, count of filters, count of cores, count of environmental measurements), barcharts grouped or stacked by year per site

## Count of empty or NA env_measurements
```{r}
# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank or NA env_measurements

nrow(survey_envmeas_join[survey_envmeas_join$env_measurements == "" | is.na(survey_envmeas_join$env_measurements),])

```

## Percentage of survey records with environmental measurements
```{r}
nrow(survey_sub)

unique_survey_gids <- unique(survey_sub$survey_GlobalID)
unique_envmeas_survey_gids <- unique(survey_envmeas_join$survey_GlobalID) 

perc_gids<-(length(unique_envmeas_survey_gids)/length(unique_survey_gids))*100
print(paste0("Percentage of survey records with environmental measurements: ",round(perc_gids,2),"%"))

unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)

perc_sids<-(length(unique_envmeas_sids)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with environmental measurements: ",round(perc_sids,2),"%"))
```
## Table of unique Site IDs with environmental measurements
```{r}
# export table with site ids & names
survey_envmeas_join_sids <- survey_envmeas_join %>%
  dplyr::select(site_id) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- survey_envmeas_join %>% 
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
survey_envmeas_join_sids_all <- rbind(sid_other, survey_envmeas_join_sids, fill=TRUE)

survey_envmeas_join_sids_all <- survey_envmeas_join_sids_all %>%
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_table.png"))
png(outputPngFileName, height=25*nrow(survey_envmeas_join_sids_all), width=500*ncol(survey_envmeas_join_sids_all))
grid.table(survey_envmeas_join_sids_all, theme=tt3)
dev.off()
#knitr::include_graphics(outputPngFileName)
survey_envmeas_join_sids_all
```

## Map of unique Site IDs with environmental measurements
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

survey_envmeas_join_sids_all_sfdf<-survey_envmeas_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Environmental Measurements"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=survey_envmeas_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=survey_envmeas_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Summary of environmental measurements per year, month, and season
```{r}

# add seasons to survey_envmeas_join
survey_envmeas_join <- survey_envmeas_join %>% 
  mutate(season = case_when(survey_month==12 | survey_month==1 | survey_month==2 ~ "Winter", 
                            survey_month==3 | survey_month==4 | survey_month==5 ~ "Spring",
                            survey_month==6 | survey_month==7 | survey_month==8 ~ "Summer",
                            survey_month==9 | survey_month==10 | survey_month==11 ~ "Fall")) %>%
  mutate(season_year = paste0(season," ",survey_year))
  
nrow(survey_envmeas_join)

```

## Table of environmental measurements per season
```{r}
survey_envmeas_join %>%
  filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, season), is.na)) %>%
  dplyr::select(envmeas_GlobalID, season) %>% 
  dplyr::group_by(season) %>%
  dplyr::count(season) %>%
  dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2))
```
## Barplot of environmental measurements per season
```{r}
plotTitle = "Count of environmental measurements by season"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_season_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(survey_envmeas_join %>%
  filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, season), is.na)) %>%
  dplyr::select(envmeas_GlobalID, season) %>% 
  dplyr::group_by(season) %>%
  dplyr::count(season) %>%
  dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
  dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))),
       aes(season, n, fill=season)) +
  geom_bar(stat="identity") +
  xlab("Season") +
  ylab("Count") +
  ggtitle(plotTitle) +
  viridis::scale_fill_viridis(discrete = T) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```
## table of environmental measurements per season and year
```{r}
survey_envmeas_join %>%
  filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, season_year), is.na)) %>%
  dplyr::select(envmeas_GlobalID, season_year) %>% 
  dplyr::group_by(season_year) %>%
  dplyr::count(season_year) %>%
  dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
  tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
  dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))) %>%
  dplyr::arrange(season, year)
```

## Barplot of environmental measurements per season and year
```{r}
plotTitle = "Count of environmental measurements by season and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_season_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(survey_envmeas_join %>%
  filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, season_year), is.na)) %>%
  dplyr::select(envmeas_GlobalID, season_year) %>% 
  dplyr::group_by(season_year) %>%
  dplyr::count(season_year) %>%
  dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
  tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
  dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))),
       aes(season, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Season") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## table of environmental measurements per month and year
```{r}
survey_envmeas_join %>%
  filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, survey_date), is.na)) %>%
  dplyr::select(envmeas_GlobalID, survey_date) %>% 
  dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
  dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
  dplyr::group_by(survey_yrmo) %>%
  dplyr::count(survey_yrmo) %>%
  dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
  tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
  dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
  dplyr::arrange(month, year)

```
## Barplot of environmental measurements per month and year
```{r}
plotTitle = "Count of environmental measurements by month and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_month_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(survey_envmeas_join %>%
  filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, survey_date), is.na)) %>%
  dplyr::select(envmeas_GlobalID, survey_date) %>% 
  dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
  dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
  dplyr::group_by(survey_yrmo) %>%
  dplyr::count(survey_yrmo) %>%
  dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
  tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
  dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))),
       aes(month, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Month") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## table of environmental measurements per site and year
```{r}
survey_envmeas_join %>%
  filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, survey_date), is.na)) %>%
  dplyr::select(envmeas_GlobalID, site_id, survey_year) %>% 
  dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
  dplyr::group_by(sid_year) %>%
  dplyr::count(sid_year) %>%
  dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
  tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
  dplyr::arrange(site_id, year)

```

## Barplot of environmental measurements per site and year
```{r}
plotTitle = "Count of environmental measurements by site and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_year_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)

ggplot(survey_envmeas_join %>%
  filter(!if_any(c(survey_GlobalID, envmeas_GlobalID, survey_date), is.na)) %>%
  dplyr::select(envmeas_GlobalID, site_id, survey_year) %>% 
  dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
  dplyr::group_by(sid_year) %>%
  dplyr::count(sid_year) %>%
  dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)) %>%
  tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
  dplyr::arrange(site_id, year),
       aes(site_id, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Site ID") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```



## Table of count of environmental measurements by Site ID
```{r}

nrow(survey_envmeas_join)

survey_envmeas_join %>%
  filter(!if_any(c(envmeas_GlobalID, site_id), is.na)) %>%
  dplyr::select(envmeas_GlobalID, site_id) %>% 
  dplyr::group_by(site_id) %>%
  dplyr::count(site_id) %>%
  dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2))
```

## Count of environmental measurements by Site ID plot
```{r}
plotTitle = "Count of environmental measurements by site"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(survey_envmeas_join %>%
         filter(!if_any(c(envmeas_GlobalID, site_id), is.na)) %>%
         dplyr::select(envmeas_GlobalID, site_id) %>% 
         dplyr::group_by(site_id) %>%
         dplyr::count(site_id) %>%
         dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)),
       aes(site_id, n, fill=site_id)) +
  geom_bar(stat="identity") +
  xlab("Site ID") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Percentage of environmental measurements by Site ID plot
```{r}
plotTitle = "Percent of environmental measurements by site"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_all_sids_perc_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(survey_envmeas_join %>%
         filter(!if_any(c(envmeas_GlobalID, site_id), is.na)) %>%
         dplyr::select(envmeas_GlobalID, site_id) %>% 
         dplyr::group_by(site_id) %>%
         dplyr::count(site_id) %>%
         dplyr::mutate(perc=round((n/nrow(survey_envmeas_join))*100, 2)), 
       aes(site_id, perc, fill=site_id)) +
  geom_bar(stat="identity") +
  ggtitle(plotTitle) +
  xlab("Site ID") +
  ylab("Percentage") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```


# ENVIRONMENTAL MEASUREMENTS: MEASUREMENT DEPTH
Measurement depth is recorded in meters (M).

## Percentage of Site IDs with environmental depth measurements
```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  filter(!if_any(c(envmeas_depth, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with envmeas_depth measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have envmeas_depth: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental depth measurements
```{r}
# export table with site ids & names
survey_envmeas_join_sids <- survey_envmeas_join %>%
  filter(!if_any(c(envmeas_depth, site_id), is.na)) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- survey_envmeas_join %>% 
  filter(!if_any(c(envmeas_depth, site_id), is.na)) %>%
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
survey_envmeas_join_sids_all <- rbind(sid_other, survey_envmeas_join_sids, fill=TRUE) 

survey_envmeas_join_sids_all <- survey_envmeas_join_sids_all %>% 
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_depth_sids_table.png"))
png(outputPngFileName, height=25*nrow(survey_envmeas_join_sids_all), width=500*ncol(survey_envmeas_join_sids_all))
grid.table(survey_envmeas_join_sids_all, theme=tt3)
dev.off()

#knitr::include_graphics(outputPngFileName)
survey_envmeas_join_sids_all

```
## Map of unique Site IDs with water collection depths
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

survey_envmeas_join_sids_all_sfdf<-survey_envmeas_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Water Collection Depths"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_depth_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=survey_envmeas_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=survey_envmeas_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Environmental measurements where Measurement Depth is greater than 50
```{r}

survey_envmeas_join %>%
  dplyr::filter(!if_any(c(envmeas_depth, site_id), is.na) & envmeas_depth > 50)
```

## Environmental measurements where System Type is Stream
```{r}
survey_envmeas_join %>%
  dplyr::filter(!if_any(c(envmeas_depth, site_id), is.na) & system_type=="S")
```

## Environmental measurement Depth quantiles
```{r}
quantile(survey_envmeas_join$envmeas_depth, na.rm=TRUE)
min(survey_envmeas_join$envmeas_depth, na.rm=TRUE)
max(survey_envmeas_join$envmeas_depth, na.rm=TRUE)
```

## Environmental measurement Depth distribution
```{r}

# check distribution
ggplot(survey_envmeas_join,aes(x=as.numeric(envmeas_depth))) + 
  ylab("Density") +
  xlab("Measurement Depth (m)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

```

## Environmental measurement Depth by Site ID and Month
```{r, echo=FALSE, results="hide", messages=FALSE}

#plotTitle = "Depth by Site and Month"
#fileName="s123_envmeas_depth_site_month"

#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Depth, M
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(envmeas_depth, site_id), is.na)), aes(x=survey_year, y=envmeas_depth, fill=survey_year)) + 
#  geom_boxplot() +
#  xlab("Depth ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurement Depth by Site ID and Month
```{r}
plotTitle = "Depth by Site and Month"
fileName="s123_envmeas_depth_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
#  Depth, M
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(envmeas_depth, site_id), is.na)), aes(x=site_id, y=as.numeric(envmeas_depth), fill=site_id)) + 
  geom_boxplot() +
  xlab("Depth ()") +
  xlab("Site ID") +
  facet_grid(survey_month ~ .) +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurement Depth by System
```{r}

plotTitle = "Depth by System"
fileName="s123_envmeas_depth_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Depth, M
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(envmeas_depth, site_id), is.na)) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=system_type, y=as.numeric(envmeas_depth), fill=system_type)) + 
  geom_boxplot() +
  ylab("Depth (M)") +
  xlab("System") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurement Depth by Site ID
```{r}
plotTitle = "Depth by Site"
fileName="s123_envmeas_depth_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Depth, M
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(envmeas_depth, site_id), is.na)), aes(x=site_id, y=as.numeric(envmeas_depth), fill=site_id)) + 
  geom_boxplot() +
  ylab("Depth ()") +
  xlab("Site ID") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

# ENVIRONMENTAL MEASUREMENTS: WATER TEMPERATURE
Water temperature is typically recorded with a YSI instrument. Water temperature is recorded in °C and has a range of -5°C to 50°C.

## Percentage of Site IDs with environmental water temperature measurements
* add percentage of index site ids with environmental measurements that also have water_temp
```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!is.na(water_temp)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with water_temp measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have water_temp: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental water temperature measurements
```{r}
# export table with site ids & names
survey_envmeas_join_sids <- survey_envmeas_join %>%
  filter(!if_any(c(water_temp, site_id), is.na)) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- survey_envmeas_join %>% 
  filter(!if_any(c(water_temp, site_id), is.na)) %>%
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
survey_envmeas_join_sids_all <- rbind(sid_other, survey_envmeas_join_sids, fill=TRUE) 

survey_envmeas_join_sids_all <- survey_envmeas_join_sids_all %>% 
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_wtemp_sids_table.png"))
png(outputPngFileName, height=25*nrow(survey_envmeas_join_sids_all), width=500*ncol(survey_envmeas_join_sids_all))
grid.table(survey_envmeas_join_sids_all, theme=tt3)
dev.off()

#knitr::include_graphics(outputPngFileName)
survey_envmeas_join_sids_all

```
## Map of unique Site IDs with environmental water temperature measurements
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

survey_envmeas_join_sids_all_sfdf<-survey_envmeas_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Water Temperature Measurements"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_wtemp_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=survey_envmeas_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=survey_envmeas_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Environmental measurement of Temperature quantiles
```{r}
quantile(survey_envmeas_join$water_temp, na.rm=TRUE)
min(survey_envmeas_join$water_temp, na.rm=TRUE)
max(survey_envmeas_join$water_temp, na.rm=TRUE)

```
## Environmental measurement where water temperature is greater than 50
```{r}
survey_envmeas_join %>%
    dplyr::select(survey_date, site_id, general_location_name, water_temp, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
  dplyr::filter(!if_any(c(water_temp, site_id), is.na) & water_temp>50)
```

## Environmental measurement of Temperature distribution
```{r}
plotTitle = "Distribution of Water Temperature"
# check distribution
p1<-ggplot(survey_envmeas_join %>%
         filter(!if_any(c(water_temp, site_id), is.na)),aes(x=as.numeric(water_temp))) + 
  ggtitle(plotTitle) +
  ylab("Density") +
  xlab("Water Temperature (C)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme(plot.title = element_text(hjust = 0.5))

plotTitle = "Distribution of Water Temperature (truncated)"
# check distribution
p2<-ggplot(survey_envmeas_join %>%
         filter(!if_any(c(water_temp, site_id), is.na) & water_temp<50),aes(x=as.numeric(water_temp))) + 
  ggtitle(plotTitle) +
  ylab("Density") +
  xlab("Water Temperature (C)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme(plot.title = element_text(hjust = 0.5))


grid.arrange(p1, p2, nrow=2)
rm(p1,p2)
```


## Heatmap of water temperature by depth and month 
```{r}
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(water_temp, site_id, envmeas_depth), is.na)) %>%
#         mutate(depth_group = cut(envmeas_depth, breaks = seq(floor(min(na.omit(survey_envmeas_join$envmeas_depth))), #ceiling(max(na.omit(survey_envmeas_join$envmeas_depth))), by = 5),
#                         labels = seq(floor(min(na.omit(survey_envmeas_join$envmeas_depth))) + 5, #ceiling(max(na.omit(survey_envmeas_join$envmeas_depth))), by = 5)),
#         month_group = cut(survey_month, breaks = seq(floor(min(na.omit(survey_envmeas_join$survey_month))), #ceiling(max(na.omit(survey_envmeas_join$survey_month))), by = 1),
#                         labels = seq(floor(min(na.omit(survey_envmeas_join$survey_month))) + 1, #ceiling(max(na.omit(survey_envmeas_join$survey_month))), by = 1))) %>%
#         group_by(depth_group, month_group) %>%
#    summarise(value = mean(water_temp), .groups = "drop") %>%
#    mutate(across(where(is.factor), ~as.numeric(as.character(.x)))), aes(month_group, depth_group, fill= as.numeric(value))) +
#  scale_y_discrete(name ="Depth (M)", limits=seq(floor(min(na.omit(survey_envmeas_join$envmeas_depth))), #ceiling(max(na.omit(survey_envmeas_join$envmeas_depth))), by = 5)) +
#  scale_x_discrete(name ="Month", 
#                    limits=seq(1, 12, by=1)) +
#  geom_tile()
```

## Scatter plot of water temperature by depth, month, and system type
```{r}
plotTitle = "Water Temperature by System, Depth, and Month"
fileName="s123_envmeas_wtemp_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)

ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(water_temp, site_id, envmeas_depth), is.na) & water_temp<50) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=survey_month, y=envmeas_depth, color=water_temp)) +
  geom_point(size=2) +
  geom_jitter(width = 0.25, height = 2) +
  scale_x_discrete(name ="Month", limits=factor(seq(1, 12, by=1))) +
  scale_y_continuous(name ="Measurement Depth (M)") +
  labs(color='Water Temp (C)') +
  facet_grid(system_type ~ .)

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Water Temperature by site and month plot
* add grouping by system_type
```{r}


#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Temperature, C
#ggplot(survey_envmeas_join %>%
#         filter(water_temp<50), aes(x=survey_year, y=water_temp, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Temperature (C)") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurement of Water Temperature by Site and Month plot
```{r}
plotTitle = "Temperature by Site and Month"
fileName="s123_envmeas_wtemp_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
#  Temperature, C
ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(water_temp, site_id), is.na) & water_temp<50), 
       aes(x=site_id, y=as.numeric(water_temp), fill=site_id)) + 
  geom_boxplot() +
  ylab("Temperature (C)") +
  xlab("Site ID") +
  facet_grid(survey_month ~ .) +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Water Temperature by System plot
```{r}
plotTitle = "Temperature by System"
fileName="s123_envmeas_wtemp_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Temperature, C
ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(water_temp, site_id), is.na) & water_temp<50) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=system_type, y=as.numeric(water_temp), fill=system_type)) + 
  geom_boxplot() +
  ylab("Temperature (C)") +
  xlab("System") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Water Temperature by Site ID plot
* change fill to system rather than site_id (but keep in x)
```{r}
plotTitle = "Temperature by Site"
fileName="s123_envmeas_wtemp_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Temperature, C
ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(water_temp, site_id), is.na) & water_temp<50), 
       aes(x=site_id, y=as.numeric(water_temp), fill=site_id)) + 
  geom_boxplot() +
  ylab("Temperature (C)") +
  xlab("Site ID") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```


# ENVIRONMENTAL MEASUREMENTS: SALINITY
Salinity is recorded in PSU (Practical Salinity Unit).
For Maine ~30 PSU

## Percentage of Site IDs with environmental measurements of Salinity

* add percentage of index site ids with environmental measurements that also have salinity
```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(salinity, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with salinity measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have salinity: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental salinity measurements
```{r}
# export table with site ids & names
survey_envmeas_join_sids <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(salinity, site_id), is.na)) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- survey_envmeas_join %>% 
  dplyr::filter(!if_any(c(salinity, site_id), is.na)) %>%
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
survey_envmeas_join_sids_all <- rbind(sid_other, survey_envmeas_join_sids, fill=TRUE) 

survey_envmeas_join_sids_all <- survey_envmeas_join_sids_all %>% 
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_salinity_sids_table.png"))
png(outputPngFileName, height=25*nrow(survey_envmeas_join_sids_all), width=500*ncol(survey_envmeas_join_sids_all))
grid.table(survey_envmeas_join_sids_all, theme=tt3)
dev.off()

#knitr::include_graphics(outputPngFileName)
survey_envmeas_join_sids_all

```
## Map of unique Site IDs with environmental salinity measurements
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

survey_envmeas_join_sids_all_sfdf<-survey_envmeas_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Salinity Measurements"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_salinity_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=survey_envmeas_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=survey_envmeas_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Environmental measurement of Salinity quantiles
```{r}
quantile(survey_envmeas_join$salinity, na.rm=TRUE)
min(survey_envmeas_join$salinity, na.rm=TRUE)
max(survey_envmeas_join$salinity, na.rm=TRUE)
```

## Environmental measurements where turbidity is greater than 40
```{r}
survey_envmeas_join %>%
    dplyr::select(survey_date, site_id, general_location_name, salinity, conductivity, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
         dplyr::filter(!if_any(c(salinity, site_id), is.na) & salinity>40)
```

## Environmental measurement of Salinity distribution
```{r}
plotTitle = "Distribution of Salinity"
# check distribution
p1<-ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(salinity, site_id), is.na)),
         aes(x=as.numeric(salinity))) + 
  ggtitle(plotTitle) +
  ylab("Density") +
  xlab("Practical Salinity Unit (PSU)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme(plot.title = element_text(hjust = 0.5))

plotTitle = "Distribution of Salinity (truncated)"
# check distribution
p2<-ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(salinity, site_id), is.na) & salinity<50),
         aes(x=as.numeric(salinity))) + 
  ggtitle(plotTitle) +
  ylab("Density") +
  xlab("Practical Salinity Unit (PSU)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme(plot.title = element_text(hjust = 0.5))


grid.arrange(p1, p2, nrow=2)
rm(p1,p2)
```


## Scatter plot of salinity by depth, month, and system type
```{r}
plotTitle = "Salinity by System, Depth, and Month"
fileName="s123_envmeas_salinity_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)

ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(salinity, site_id, envmeas_depth), is.na) & salinity<50) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=survey_month, y=envmeas_depth, color=salinity)) +
  geom_point(size=2) +
  geom_jitter(width = 0.25, height = 2) +
  scale_x_discrete(name ="Month", limits=factor(seq(1, 12, by=1))) +
  scale_y_continuous(name ="Measurement Depth (M)") +
  labs(color='Practical Salinity Unit (PSU)') +
  facet_grid(system_type ~ .)

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Salinity by Site ID and Month
* add note about depth and sampling year/month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Salinity, ppm
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(salinity, site_id), is.na) & salinity<40), 
#       aes(x=survey_year, y=salinity, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Salinity ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurement of Salinity by Site ID and Month
```{r}
plotTitle = "Salinity by Site and Month"
fileName="s123_envmeas_salinity_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
#  Salinity, ppm
ggplot(survey_envmeas_join  %>%
         dplyr::filter(!if_any(c(salinity, site_id), is.na) & salinity<40), 
       aes(x=site_id, y=as.numeric(salinity), fill=site_id)) + 
  geom_boxplot() +
  ylab("Practical Salinity Unit (PSU)") +
  xlab("Site ID") +
  facet_grid(survey_month ~ .) +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Salinity by System
```{r}

plotTitle = "Salinity by System"
fileName="s123_envmeas_salinity_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Salinity, ppm
ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(salinity, site_id), is.na) & salinity<40) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=system_type, y=as.numeric(salinity), fill=system_type)) + 
  geom_boxplot() +
  ylab("Practical Salinity Unit (PSU)") +
  xlab("System") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurement of Salinity by Site ID
```{r}

plotTitle = "Salinity by Site"
fileName="s123_envmeas_salinity_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Salinity, ppm
ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(salinity, site_id), is.na) & salinity<40), 
       aes(x=site_id, y=as.numeric(salinity), fill=site_id)) + 
  geom_boxplot() +
  ylab("Practical Salinity Unit (PSU)") +
  xlab("Site ID") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

# ENVIRONMENTAL MEASUREMENTS: TURBIDITY
Turbidity is typically collected with a YSI instrument. Turbidity is recorded in FNU (Formazin Nephelometric Unit) and has a range of 0 to 4000 FNU. 
* add turbidity ranges (what is high turbidity?), range for Maine?

## Percentage of Site IDs with environmental measurements of Turbidity
* add percentage of index site ids with environmental measurements that also have turbidity
```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(turbidity, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with turbidity measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have turbidity: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental turbidity measurements
```{r}
# export table with site ids & names
survey_envmeas_join_sids <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(turbidity, site_id), is.na)) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- survey_envmeas_join %>% 
  dplyr::filter(!if_any(c(turbidity, site_id), is.na)) %>%
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
survey_envmeas_join_sids_all <- rbind(sid_other, survey_envmeas_join_sids, fill=TRUE) 

survey_envmeas_join_sids_all <- survey_envmeas_join_sids_all %>% 
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_turbidity_sids_table.png"))
png(outputPngFileName, height=25*nrow(survey_envmeas_join_sids_all), width=500*ncol(survey_envmeas_join_sids_all))
grid.table(survey_envmeas_join_sids_all, theme=tt3)
dev.off()

#knitr::include_graphics(outputPngFileName)
survey_envmeas_join_sids_all

```
## Map of unique Site IDs with environmental turbidity measurements
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

survey_envmeas_join_sids_all_sfdf<-survey_envmeas_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Turbidity Measurements"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_turbidity_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=survey_envmeas_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=survey_envmeas_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```


## Environmental measurements of Turbidity quantile
```{r}
quantile(survey_envmeas_join$turbidity, na.rm=TRUE)
min(survey_envmeas_join$turbidity, na.rm=TRUE)
max(survey_envmeas_join$turbidity, na.rm=TRUE)
```


## Environmental measurements where turbidity is greater than 40
```{r}
survey_envmeas_join %>%
    dplyr::select(survey_date, site_id, general_location_name, turbidity, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
         dplyr::filter(!if_any(c(turbidity, site_id), is.na) & turbidity>40)
```

## Environmental measurements of turbidity distribution
```{r}
plotTitle = "Distribution of Turbidity"
# check distribution
p1<-ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(turbidity, site_id), is.na)),
         aes(x=as.numeric(turbidity))) + 
  ggtitle(plotTitle) +
  ylab("Density") +
  xlab("Turbidity (Formazin Nephelometric Unit)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme(plot.title = element_text(hjust = 0.5))

plotTitle = "Distribution of Turbidity (truncated)"
# check distribution
p2<-ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(turbidity, site_id), is.na) & turbidity<40),
         aes(x=as.numeric(turbidity))) + 
  ggtitle(plotTitle) +
  ylab("Density") +
  xlab("Turbidity (Formazin Nephelometric Unit)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme(plot.title = element_text(hjust = 0.5))


grid.arrange(p1, p2, nrow=2)
rm(p1,p2)

```

## Scatter plot of turbidity by depth and month
```{r}
plotTitle = "Turbidity by System, Depth, and Month"
plotCaption = "Formazin Nephelometric Unit (FNU)"
fileName="s123_envmeas_turbidity_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)

ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(turbidity, site_id, envmeas_depth), is.na) & turbidity<40) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=survey_month, y=envmeas_depth, color=turbidity)) +
  geom_point(size=2) +
  geom_jitter(width = 0.25, height = 2) +
  scale_x_discrete(name ="Month", limits=factor(seq(1, 12, by=1))) +
  scale_y_continuous(name ="Measurement Depth (M)") +
  labs(color='Turbidity (FNU)',
       caption=plotCaption) +
  ggtitle(plotTitle) +
  facet_grid(system_type ~ .)

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Turbidity by Site ID and Month
* add note about depth and sampling year/month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Salinity, ppm
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(turbidity, site_id), is.na) & salinity<40), aes(x=survey_year, y=salinity, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Salinity ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurements of Turbidity by Site ID and Month
```{r}
plotTitle = "Turbidity by Site and Month"
fileName="s123_envmeas_turbidity_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
#  turbidity, Formazin Nephelometric Unit
ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(turbidity, site_id), is.na)), 
       aes(x=site_id, y=as.numeric(turbidity), fill=site_id)) + 
  geom_boxplot() +
  ylab("Turbidity (Formazin Nephelometric Unit)") +
  xlab("Site ID") +
  facet_grid(survey_month ~ .) +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Turbidity by System
```{r}

plotTitle = "Turbidity by System"
fileName="s123_envmeas_turbidity_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  turbidity, Formazin Nephelometric Unit
ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(turbidity, site_id), is.na)) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))) %>%
         dplyr::filter(turbidity<40), 
       aes(x=system_type, y=as.numeric(turbidity), fill=system_type)) + 
  geom_boxplot() +
  ylab("Turbidity (Formazin Nephelometric Unit)") +
  xlab("System") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

## Environmental measurements of Turbidity by Site ID
```{r}

plotTitle = "Turbidity by Site"
fileName="s123_envmeas_turbidity_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  turbidity, Formazin Nephelometric Unit
ggplot(survey_envmeas_join %>%
         dplyr::filter(!if_any(c(turbidity, site_id), is.na)) %>%
          dplyr::filter(turbidity<40), 
       aes(x=site_id, y=as.numeric(turbidity), fill=site_id)) + 
  geom_boxplot() +
  ylab("Turbidity (Formazin Nephelometric Unit)") +
  xlab("Site ID") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

# ENVIRONMENTAL MEASUREMENTS: CONDUCTIVITY
Conductivity is typically collected with a YSI instrument. Conductivity is recorded in μS/cm and has a range of 0 to 100,000 μS/cm. 

## Percentage of Site IDs with environmental measurements of Conductivity
* add percentage of index site ids with environmental measurements that also have conductivity

```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(conductivity, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with conductivity measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have conductivity: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental conductivity measurements
```{r}
# export table with site ids & names
survey_envmeas_join_sids <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(conductivity, site_id), is.na)) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- survey_envmeas_join %>% 
  dplyr::filter(!if_any(c(conductivity, site_id), is.na)) %>%
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
survey_envmeas_join_sids_all <- rbind(sid_other, survey_envmeas_join_sids, fill=TRUE) 

survey_envmeas_join_sids_all <- survey_envmeas_join_sids_all %>% 
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_conductivity_sids_table.png"))
png(outputPngFileName, height=25*nrow(survey_envmeas_join_sids_all), width=500*ncol(survey_envmeas_join_sids_all))
grid.table(survey_envmeas_join_sids_all, theme=tt3)
dev.off()

#knitr::include_graphics(outputPngFileName)
survey_envmeas_join_sids_all

```
## Map of unique Site IDs with environmental turbidity measurements
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

survey_envmeas_join_sids_all_sfdf<-survey_envmeas_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Conductivity Measurements"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_conductivity_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=survey_envmeas_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=survey_envmeas_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Environmental measurements of Conductivity quantile
```{r}
quantile(survey_envmeas_join$conductivity, na.rm=TRUE)
min(survey_envmeas_join$conductivity, na.rm=TRUE)
max(survey_envmeas_join$conductivity, na.rm=TRUE)
```


## Environmental measurements where conductivity is less than 100
```{r}
survey_envmeas_join %>%
  dplyr::select(survey_date, site_id, general_location_name, conductivity, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
  dplyr::filter(!if_any(c(conductivity, site_id), is.na) & conductivity<100)
```

## Environmental measurements of conductivity distribution
```{r}
plotTitle = "Distribution of Conductivity"
# check distribution
p1<- ggplot(survey_envmeas_join %>%
         filter(!if_any(c(conductivity, site_id), is.na)),
       aes(x=as.numeric(conductivity))) + 
  ylab("Density") +
  xlab("Conductivity (μS/cm)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

plotTitle = "Distribution of Conductivity (truncated)"
# check distribution
p2<- ggplot(survey_envmeas_join %>%
         filter(!if_any(c(conductivity, site_id), is.na) & conductivity<100),
       aes(x=as.numeric(conductivity))) + 
  ylab("Density") +
  xlab("Conductivity (μS/cm)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

grid.arrange(p1, p2, nrow=2)
rm(p1,p2)

```

## Scatter plot of conductivity by depth, month, and system type
```{r}
plotTitle = "Conductivity by System, Depth, and Month"
fileName="s123_envmeas_conductivity_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)

ggplot(survey_envmeas_join %>%
         filter(!if_any(c(conductivity, site_id, envmeas_depth), is.na)) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=survey_month, y=envmeas_depth, color=conductivity)) +
  geom_point(size=2) +
  geom_jitter(width = 0.25, height = 2) +
  scale_x_discrete(name ="Month", limits=factor(seq(1, 12, by=1))) +
  scale_y_continuous(name ="Measurement Depth (M)") +
  labs(color="Conductivity (μS/cm)") +
  ggtitle(plotTitle) +
  facet_grid(system_type ~ .)

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Conductivity by Site ID and Month
* add note about depth and sampling year/month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Salinity, ppm
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(conductivity, site_id), is.na) & salinity<40), aes(x=survey_year, y=salinity, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Salinity ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurements of Conductivity by Site ID and Month
```{r}
plotTitle = "Conductivity by Site and Month"
fileName="s123_envmeas_conductivity_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
#  conductivity, μS/cm
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(conductivity, site_id), is.na)), 
       aes(x=site_id, y=as.numeric(conductivity), fill=site_id)) + 
  geom_boxplot() +
  ylab("Conductivity (μS/cm)") +
  xlab("Site ID") +
  facet_grid(survey_month ~ .) +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Conductivity by System
```{r}

plotTitle = "Conductivity by System"
fileName="s123_envmeas_conductivity_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  conductivity, μS/cm
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(conductivity, site_id), is.na)) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=system_type, y=as.numeric(conductivity), fill=system_type)) + 
  geom_boxplot() +
  ylab("Conductivity (μS/cm)") +
  xlab("System") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

## Environmental measurements of Conductivity by Site ID
```{r}

plotTitle = "Conductivity by Site"
fileName="s123_envmeas_conductivity_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  conductivity, μS/cm
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(conductivity, site_id), is.na)), 
       aes(x=site_id, y=as.numeric(conductivity), fill=site_id)) + 
  geom_boxplot() +
  ylab("Conductivity (μS/cm)") +
  xlab("Site ID") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

# ENVIRONMENTAL MEASUREMENTS: DISSOLVED OXYGEN
Dissolved Oxygen is typically collected with a YSI instrument. Dissolved Oxygen is recorded in mg/L and has a range of 0 to 50 mg/L. 

## Percentage of Site IDs with environmental measurements of Dissolved Oxygen
* add percentage of index site ids with environmental measurements that also have dissolved oxygen

```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(do, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with dissolved oxygen measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have dissolved oxygen: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental dissolved oxygen measurements
```{r}
# export table with site ids & names
survey_envmeas_join_sids <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(do, site_id), is.na)) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- survey_envmeas_join %>% 
  dplyr::filter(!if_any(c(do, site_id), is.na)) %>%
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
survey_envmeas_join_sids_all <- rbind(sid_other, survey_envmeas_join_sids, fill=TRUE) 

survey_envmeas_join_sids_all <- survey_envmeas_join_sids_all %>% 
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_do_sids_table.png"))
png(outputPngFileName, height=25*nrow(survey_envmeas_join_sids_all), width=500*ncol(survey_envmeas_join_sids_all))
grid.table(survey_envmeas_join_sids_all, theme=tt3)
dev.off()

#knitr::include_graphics(outputPngFileName)
survey_envmeas_join_sids_all

```
## Map of unique Site IDs with environmental dissolved oxygen measurements
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

survey_envmeas_join_sids_all_sfdf<-survey_envmeas_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Dissolved Oxygen Measurements"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_do_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=survey_envmeas_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=survey_envmeas_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Environmental measurements of Dissolved Oxygen quantile
```{r}
quantile(survey_envmeas_join$do, na.rm=TRUE)
min(survey_envmeas_join$do, na.rm=TRUE)
max(survey_envmeas_join$do, na.rm=TRUE)
```


## Environmental measurements where dissolved oxygen is greater than 50
```{r}
survey_envmeas_join %>%
    dplyr::select(survey_date, site_id, general_location_name, do, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
         filter(!if_any(c(do, site_id), is.na) & do>50)
```

## Environmental measurements of dissolved oxygen distribution
```{r}
plotTitle = "Distribution of Dissolved Oxygen"
# check distribution
p1<- ggplot(survey_envmeas_join %>%
         filter(!if_any(c(do, site_id), is.na)),
       aes(x=as.numeric(do))) + 
  ylab("Density") +
  xlab("Dissolved Oxygen (mg/L)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

plotTitle = "Distribution of Dissolved Oxygen (truncated)"
# check distribution
p2<- ggplot(survey_envmeas_join %>%
         filter(!if_any(c(do, site_id), is.na) & do<50),
       aes(x=as.numeric(do))) + 
  ylab("Density") +
  xlab("Dissolved Oxygen (mg/L)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

grid.arrange(p1, p2, nrow=2)
rm(p1,p2)

```

## Scatter plot of dissolved oxygen by depth, month, and system type
```{r}
plotTitle = "Dissolved Oxygen by System, Depth, and Month"
fileName="s123_envmeas_do_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)

ggplot(survey_envmeas_join %>%
         filter(!if_any(c(do, site_id, envmeas_depth), is.na) & do<50) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=survey_month, y=envmeas_depth, color=do)) +
  geom_point(size=2) +
  geom_jitter(width = 0.25, height = 2) +
  scale_x_discrete(name ="Month", limits=factor(seq(1, 12, by=1))) +
  scale_y_continuous(name ="Measurement Depth (M)") +
  labs(color="Dissolved Oxygen (mg/L)") +
  facet_grid(system_type ~ .)

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Dissolved Oxygen by Site ID and Month
* add note about depth and sampling year/month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_envmeas_do_year"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Dissolved Oxygen, mg/L
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(do, site_id), is.na) & do<50), aes(x=survey_year, y=salinity, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Dissolved Oxygen (mg/L)") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurements of Dissolved Oxygen by Site ID and Month
```{r}
plotTitle = "Dissolved Oxygen by Site and Month"
fileName="s123_envmeas_do_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
#  Dissolved Oxygen (mg/L)
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(do, site_id), is.na) & do<50), aes(x=site_id, y=as.numeric(do), fill=site_id)) + 
  geom_boxplot() +
  ylab("Dissolved Oxygen (mg/L)") +
  xlab("Site ID") +
  facet_grid(survey_month ~ .) +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of Dissolved Oxygen by System
```{r}

plotTitle = "Dissolved Oxygen by System"
fileName="s123_envmeas_do_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Dissolved Oxygen (mg/L)
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(do, site_id), is.na) & do<50) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=system_type, y=as.numeric(do), fill=system_type)) + 
  geom_boxplot() +
  ylab("Dissolved Oxygen (mg/L)") +
  xlab("System") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

## Environmental measurements of Dissolved Oxygen by Site ID
```{r}

plotTitle = "Dissolved Oxygen by Site"
fileName="s123_envmeas_do_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  do, μS/cm
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(do, site_id), is.na) & do<50), aes(x=site_id, y=as.numeric(do), fill=site_id)) + 
  geom_boxplot() +
  ylab("Dissolved Oxygen (mg/L)") +
  xlab("Site ID") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```


# ENVIRONMENTAL MEASUREMENTS: PAR1
Photosynthetically Active Radiation (Channel 1: Up looking), or PAR1, is typically collected with a YSI instrument. PAR1 is recorded in μmoles/sec/m². 

## Percentage of Site IDs with environmental measurements of PAR1
* add percentage of index site ids with environmental measurements that also have PAR1

```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(par1, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with par1 measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have par1: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental par1 measurements
```{r}
# export table with site ids & names
survey_envmeas_join_sids <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(par1, site_id), is.na)) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- survey_envmeas_join %>% 
  dplyr::filter(!if_any(c(par1, site_id), is.na)) %>%
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
survey_envmeas_join_sids_all <- rbind(sid_other, survey_envmeas_join_sids, fill=TRUE) 

survey_envmeas_join_sids_all <- survey_envmeas_join_sids_all %>% 
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_par1_sids_table.png"))
png(outputPngFileName, height=25*nrow(survey_envmeas_join_sids_all), width=500*ncol(survey_envmeas_join_sids_all))
grid.table(survey_envmeas_join_sids_all, theme=tt3)
dev.off()

#knitr::include_graphics(outputPngFileName)
survey_envmeas_join_sids_all

```
## Map of unique Site IDs with environmental dissolved oxygen measurements
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

survey_envmeas_join_sids_all_sfdf<-survey_envmeas_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with PAR1 Measurements"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_par1_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=survey_envmeas_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=survey_envmeas_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Environmental measurements of par1 quantile
```{r}
quantile(survey_envmeas_join$par1, na.rm=TRUE)
min(survey_envmeas_join$par1, na.rm=TRUE)
max(survey_envmeas_join$par1, na.rm=TRUE)
```


## Environmental measurements where par1 is greater than 1000
```{r}
survey_envmeas_join %>%
    dplyr::select(survey_date, site_id, general_location_name, par1, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
         dplyr::filter(!if_any(c(par1, site_id), is.na) & par1>1000)
```

## Environmental measurements of par1 distribution
```{r}
# check distribution
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(par1, site_id), is.na)),
       aes(x=as.numeric(par1))) + 
  ylab("Density") +
  xlab("PAR1 (μmoles/sec/m²)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

```

## Scatter plot of par1 by depth, month, and system type
```{r}
plotTitle = "PAR1 by System, Depth, and Month"
fileName="s123_envmeas_par1_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)

ggplot(survey_envmeas_join %>%
         filter(!if_any(c(par1, site_id, envmeas_depth), is.na)) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=survey_month, y=envmeas_depth, color=par1)) +
  geom_point(size=2) +
  geom_jitter(width = 0.25, height = 2) +
  scale_x_discrete(name ="Month", limits=factor(seq(1, 12, by=1))) +
  scale_y_continuous(name ="Measurement Depth (M)") +
  labs(color="PAR1 (μmoles/sec/m²)") +
  facet_grid(system_type ~ .)

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of par1 by Site ID and Month
* add note about depth and sampling year/month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Salinity, ppm
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(par1, site_id), is.na) & salinity<40), aes(x=survey_year, y=salinity, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Salinity ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurements of par1 by Site ID and Month
```{r}
plotTitle = "PAR1 by Site and Month"
fileName="s123_envmeas_par1_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
#  par1, μS/cm
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(par1, site_id), is.na)), aes(x=site_id, y=as.numeric(par1), fill=site_id)) + 
  geom_boxplot() +
  ylab("PAR1 (μmoles/sec/m²)") +
  xlab("Site ID") +
  facet_grid(survey_month ~ .) +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of par1 by System
```{r}

plotTitle = "PAR1 by System"
fileName="s123_envmeas_par1_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  par1, μmoles/sec/m²
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(par1, site_id), is.na)) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=system_type, y=as.numeric(par1), fill=system_type)) + 
  geom_boxplot() +
  ylab("par1 (μmoles/sec/m²)") +
  xlab("System") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

## Environmental measurements of par1 by Site ID
```{r}

plotTitle = "PAR1 by Site"
fileName="s123_envmeas_par1_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  par1, μmoles/sec/m²
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(par1, site_id), is.na)), aes(x=site_id, y=as.numeric(par1), fill=site_id)) + 
  geom_boxplot() +
  ylab("PAR1 (μmoles/sec/m²)") +
  xlab("Site ID") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

# ENVIRONMENTAL MEASUREMENTS: PAR2
Photosynthetically Active Radiation (Channel 2: Down looking), or PAR2, is typically collected with a YSI instrument. PAR2 is recorded in μmoles/sec/m². 

## Percentage of Site IDs with environmental measurements of PAR2
* add percentage of index site ids with environmental measurements that also have PAR2

```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_envmeas_sids <- unique(survey_envmeas_join$site_id)
unique_envmeas_sids_envmeas <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(par2, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with par2 measurements: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_envmeas_sids_envmeas)/length(unique_envmeas_sids))*100
print(paste0("Percentage of site ids with environmental measurements that also have par2: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with environmental par2 measurements
```{r}
# export table with site ids & names
survey_envmeas_join_sids <- survey_envmeas_join %>%
  dplyr::filter(!if_any(c(par2, site_id), is.na)) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- survey_envmeas_join %>% 
  dplyr::filter(!if_any(c(par2, site_id), is.na)) %>%
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
survey_envmeas_join_sids_all <- rbind(sid_other, survey_envmeas_join_sids, fill=TRUE) 

survey_envmeas_join_sids_all <- survey_envmeas_join_sids_all %>% 
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_par2_sids_table.png"))
png(outputPngFileName, height=25*nrow(survey_envmeas_join_sids_all), width=500*ncol(survey_envmeas_join_sids_all))
grid.table(survey_envmeas_join_sids_all, theme=tt3)
dev.off()

#knitr::include_graphics(outputPngFileName)
survey_envmeas_join_sids_all
```

## Map of unique Site IDs with environmental dissolved oxygen measurements
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

survey_envmeas_join_sids_all_sfdf<-survey_envmeas_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with PAR2 Measurements"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_envmeas_par2_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=survey_envmeas_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=survey_envmeas_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Environmental measurements of par2 quantile
```{r}
quantile(survey_envmeas_join$par2, na.rm=TRUE)
min(survey_envmeas_join$par2, na.rm=TRUE)
max(survey_envmeas_join$par2, na.rm=TRUE)
```


## Environmental measurements where par2 is greater than 40
```{r}
survey_envmeas_join %>%
    dplyr::select(survey_date, site_id, general_location_name, par2, envmeas_depth, envmeas_instrument, system_type, ysi_notes, envmeas_notes, env_measurements) %>%
         filter(!if_any(c(par2, site_id), is.na) & par2>40)
```

## Environmental measurements of par2 distribution
```{r}
# check distribution
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(par2, site_id), is.na)),
       aes(x=as.numeric(par2))) + 
  ylab("Density") +
  xlab("PAR2 (μmoles/sec/m²)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

```

## Scatter plot of par2 by depth, month, and system type
```{r}
plotTitle = "PAR2 by System, Depth, and Month"
fileName="s123_envmeas_par2_system_month_depth_splot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=8,width=6, units='in', res=150)

ggplot(survey_envmeas_join %>%
         filter(!if_any(c(par2, site_id, envmeas_depth), is.na)) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=survey_month, y=envmeas_depth, color=par2)) +
  geom_point(size=2) +
  geom_jitter(width = 0.25, height = 2) +
  scale_x_discrete(name ="Month", limits=factor(seq(1, 12, by=1))) +
  scale_y_continuous(name ="Measurement Depth (M)") +
  labs(color="PAR2 (μmoles/sec/m²)") +
  facet_grid(system_type ~ .)

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of par2 by Site ID and Month
* add note about depth and sampling year/month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Salinity, ppm
#ggplot(survey_envmeas_join %>%
#         filter(!if_any(c(par2, site_id), is.na) & salinity<40), aes(x=survey_year, y=salinity, fill=survey_year)) + 
#  geom_boxplot() +
#  ylab("Salinity ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()
```

## Environmental measurements of par2 by Site ID and Month
```{r}
plotTitle = "PAR2 by Site and Month"
fileName="s123_envmeas_par2_sids_month_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=16,width=6, units='in', res=300)
#  par2, μS/cm
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(par2, site_id), is.na)), aes(x=site_id, y=as.numeric(par2), fill=site_id)) + 
  geom_boxplot() +
  ylab("PAR2 (μmoles/sec/m²)") +
  xlab("Site ID") +
  facet_grid(survey_month ~ .) +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Environmental measurements of par2 by System
```{r}

plotTitle = "PAR2 by System"
fileName="s123_envmeas_par2_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  par2, μmoles/sec/m²
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(par2, site_id), is.na)) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=system_type, y=as.numeric(par2), fill=system_type)) + 
  geom_boxplot() +
  ylab("PAR2 (μmoles/sec/m²)") +
  xlab("System") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

## Environmental measurements of par2 by Site ID
```{r}

plotTitle = "PAR2 by Site"
fileName="s123_envmeas_par2_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  par2, μmoles/sec/m²
ggplot(survey_envmeas_join %>%
         filter(!if_any(c(par2, site_id), is.na)), aes(x=site_id, y=as.numeric(par2), fill=site_id)) + 
  geom_boxplot() +
  ylab("PAR2 (μmoles/sec/m²)") +
  xlab("Site ID") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

# COLLECTION SUMMARY

## Count of empty or NA collection_types
```{r}
# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank or NA Site IDs

nrow(survey_collection_join[survey_collection_join$collection_type == "" | is.na(survey_collection_join$collection_type),])

```

## Summary of collections per year, month, and season
```{r}

# add seasons to clean_filter_join
survey_collection_join <- survey_collection_join %>% 
  mutate(season = case_when(survey_month==12 | survey_month==1 | survey_month==2 ~ "Winter", 
                            survey_month==3 | survey_month==4 | survey_month==5 ~ "Spring",
                            survey_month==6 | survey_month==7 | survey_month==8 ~ "Summer",
                            survey_month==9 | survey_month==10 | survey_month==11 ~ "Fall")) %>%
  mutate(season_year = paste0(season," ",survey_year))
  
nrow(survey_collection_join)

```

## Percentage of Site IDs with collections
```{r}

names(survey_collection_join)

unique_survey_sids <- unique(survey_sub$site_id)
unique_collect_sids <- unique(survey_collection_join$site_id)
unique_collect_sids_water <- survey_collection_join %>%
  dplyr::filter(!if_any(c(collection_type, site_id), is.na) & collection_type=="water_sample") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_collect_sids_water)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with water collections: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_collect_sids_water)/length(unique_collect_sids))*100
print(paste0("Percentage of site ids with collections that are water: ",round(perc_sids,2),"%"))


unique_survey_sids <- unique(survey_sub$site_id)
unique_collect_sids <- unique(survey_collection_join$site_id)
unique_collect_sids_sed <- survey_collection_join %>%
  dplyr::filter(!if_any(c(collection_type, site_id), is.na) & collection_type=="sed_sample") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_collect_sids_sed)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with sediment collections: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_collect_sids_sed)/length(unique_collect_sids))*100
print(paste0("Percentage of site ids with collections that are sediment: ",round(perc_sids,2),"%"))
```
## Table of collection types where collection type is "sed_sample" or "water_sample"
```{r}
names(survey_collection_join)
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::filter(collection_type=="sed_sample") %>%
  dplyr::select(collection_type, survey_date, projects, site_id, other_site_id, general_location_name, 
                supervisor, username, recorder_first_name, recorder_last_name, 
                core_datetime_start, core_datetime_end,core_label,core_control,
                core_method,depth_core_collected,core_length,core_diameter,
                core_notes,subcores_taken,purpose_other_cores) %>%
  dplyr::arrange(survey_date)

survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::filter(collection_type=="water_sample") %>%
  dplyr::select(collection_type, survey_date, projects, site_id, other_site_id, general_location_name, 
                supervisor, username, recorder_first_name, recorder_last_name,
                water_collect_date, water_control, water_control_type, water_depth,
                water_vessel_material, water_vessel_color, water_vessel_label, 
                water_collect_notes, was_filtered) %>%
  dplyr::arrange(survey_date)

```

## Table of collection types per year
```{r}
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::select(collection_GlobalID, collection_type, survey_year) %>% 
  dplyr::mutate(ct_year=paste0(collection_type, " ", survey_year)) %>%
  dplyr::group_by(ct_year) %>%
  dplyr::count(ct_year) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_year, into=c("collection_type","year"),sep=" ") %>%
  dplyr::arrange(collection_type, year)
```

## Barplot of collection types per year
```{r}
plotTitle = "Count of collection types by year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_type_year_count_barplot.png"))
png(outputPngFileName,height=5,width=6, units='in', res=150)

ggplot(survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::select(collection_GlobalID, collection_type, survey_year) %>% 
  dplyr::mutate(ct_year=paste0(collection_type, " ", survey_year)) %>%
  dplyr::group_by(ct_year) %>%
  dplyr::count(ct_year) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_year, into=c("collection_type","year"),sep=" ") %>%
  dplyr::arrange(collection_type, year),
       aes(collection_type, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Collection Type") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```


## table of collection types per system
```{r}
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::select(collection_GlobalID, collection_type, system_type) %>% 
  dplyr::mutate(ct_system=paste0(collection_type, " ", system_type)) %>%
  dplyr::group_by(ct_system) %>%
  dplyr::count(ct_system) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_system, into=c("collection_type","system_type"),sep=" ") %>%
  dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))) %>%
  dplyr::arrange(collection_type, system_type)
```

## Barplot of collections types per system
```{r}
plotTitle = "Count of collection types by system"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_type_system_year_count_barplot.png"))
png(outputPngFileName,height=6,width=12, units='in', res=150)

ggplot(survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::select(collection_GlobalID, collection_type, system_type) %>% 
  dplyr::mutate(ct_system=paste0(collection_type, " ", system_type)) %>%
  dplyr::group_by(ct_system) %>%
  dplyr::count(ct_system) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_system, into=c("collection_type","system_type"),sep=" ") %>%
  dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))) %>%
  dplyr::arrange(collection_type, system_type),
       aes(system_type, n)) +
  geom_bar(aes(fill=collection_type), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("System Type") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill="Collection Type")


print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## table of collection types per site
```{r}
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::select(collection_GlobalID, collection_type, site_id) %>% 
  dplyr::mutate(ct_sid=paste0(collection_type, " ", site_id)) %>%
  dplyr::group_by(ct_sid) %>%
  dplyr::count(ct_sid) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_sid, into=c("collection_type","site_id"),sep=" ") %>%
  dplyr::arrange(collection_type, site_id)
```

## Barplot of collection types per site
```{r}
plotTitle = "Count of collection types by site"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_type_sid_count_barplot.png"))
png(outputPngFileName,height=6,width=18, units='in', res=150)

ggplot(survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::select(collection_GlobalID, collection_type, site_id) %>% 
  dplyr::mutate(ct_sid=paste0(collection_type, " ", site_id)) %>%
  dplyr::group_by(ct_sid) %>%
  dplyr::count(ct_sid) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_sid, into=c("collection_type","site_id"),sep=" ") %>%
  dplyr::arrange(collection_type, site_id),
       aes(site_id, n)) +
  geom_bar(aes(fill=collection_type), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Site ID") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  labs(fill="Collection Type")


print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## table of collection per year and site
```{r}
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::select(collection_GlobalID, survey_year, site_id) %>% 
  dplyr::mutate(yr_sid=paste0(survey_year, " ", site_id)) %>%
  dplyr::group_by(yr_sid) %>%
  dplyr::count(yr_sid) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(yr_sid, into=c("survey_year","site_id"),sep=" ") %>%
  dplyr::arrange(survey_year, site_id)
```

## Barplot of collection per year and site
```{r}
plotTitle = "Count of collections by site and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_all_sids_year_count_barplot.png"))
png(outputPngFileName,height=6,width=18, units='in', res=150)

ggplot(survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::select(collection_GlobalID, survey_year, site_id) %>% 
  dplyr::mutate(yr_sid=paste0(survey_year, " ", site_id)) %>%
  dplyr::group_by(yr_sid) %>%
  dplyr::count(yr_sid) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(yr_sid, into=c("survey_year","site_id"),sep=" ") %>%
  dplyr::arrange(survey_year, site_id),
       aes(site_id, n)) +
  geom_bar(aes(fill=survey_year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Site ID") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  labs(fill="Year")


print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## table of collection per year and system
```{r}
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::select(collection_GlobalID, survey_year, system_type) %>% 
  dplyr::mutate(yr_system=paste0(survey_year, " ", system_type)) %>%
  dplyr::group_by(yr_system) %>%
  dplyr::count(yr_system) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(yr_system, into=c("survey_year","system_type"),sep=" ") %>%
  dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))) %>%
  dplyr::arrange(survey_year, system_type)
```

## Barplot of collection per year and system
```{r}
plotTitle = "Count of collections by system and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_all_system_year_count_barplot.png"))
png(outputPngFileName,height=6,width=12, units='in', res=150)

ggplot(survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::select(collection_GlobalID, survey_year, system_type) %>% 
  dplyr::mutate(yr_system=paste0(survey_year, " ", system_type)) %>%
  dplyr::group_by(yr_system) %>%
  dplyr::count(yr_system) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(yr_system, into=c("survey_year","system_type"),sep=" ") %>%
  dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))) %>%
  dplyr::arrange(survey_year, system_type),
       aes(system_type, n)) +
  geom_bar(aes(fill=survey_year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("System Type") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill="Year")


print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## table of collection types per site and year
```{r}
survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::select(collection_GlobalID, collection_type, site_id, survey_year) %>% 
  dplyr::mutate(ct_sid=paste0(collection_type, " ", site_id, " ", survey_year)) %>%
  dplyr::group_by(ct_sid) %>%
  dplyr::count(ct_sid) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_sid, into=c("collection_type","site_id","survey_year"),sep=" ") %>%
  dplyr::arrange(collection_type, site_id, survey_year)
```

## Barplot of collection types per site and year
```{r}
plotTitle = "Count of collection types by site and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_type_sid_count_barplot.png"))
png(outputPngFileName,height=6,width=90, units='in', res=300)

ggplot(survey_collection_join %>%
  dplyr::mutate(collection_type=na_if(collection_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season, collection_type), is.na)) %>%
  dplyr::select(collection_GlobalID, collection_type, site_id, survey_year) %>% 
  dplyr::mutate(ct_sid=paste0(collection_type, " ", site_id, " ", survey_year)) %>%
  dplyr::group_by(ct_sid) %>%
  dplyr::count(ct_sid) %>%
  dplyr::mutate(perc=round((n/nrow(survey_collection_join))*100, 2)) %>%
  tidyr::separate(ct_sid, into=c("collection_type","site_id","survey_year"),sep=" ") %>%
  dplyr::arrange(collection_type, site_id, survey_year),
       aes(collection_type, n)) +
  geom_bar(aes(fill=survey_year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Site ID") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  labs(fill="Year") +
  facet_grid(~ site_id)


print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```


# COLLECTIONS: WATER COLLECTION DEPTH

## Percentage of Site IDs with water collection depths
```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_collect_sids <- unique(survey_collection_join$site_id)
unique_collect_sids_depth <- survey_collection_join %>%
  dplyr::filter(!if_any(c(water_depth, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_collect_sids_depth)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with water collections: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_collect_sids_depth)/length(unique_collect_sids))*100
print(paste0("Percentage of site ids with collection depths: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with water collection depths
```{r}
# export table with site ids & names
survey_collection_join_sids <- survey_collection_join %>%
  dplyr::filter(!if_any(c(water_depth, site_id), is.na)) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- survey_collection_join %>% 
  dplyr::filter(!if_any(c(water_depth, site_id), is.na)) %>%
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
survey_collection_join_sids_all <- rbind(sid_other, survey_collection_join_sids, fill=TRUE) 

survey_collection_join_sids_all <- survey_collection_join_sids_all %>% 
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_wdepth_sids_table.png"))
png(outputPngFileName, height=25*nrow(survey_collection_join_sids_all), width=500*ncol(survey_collection_join_sids_all))
grid.table(survey_collection_join_sids_all, theme=tt3)
dev.off()

#knitr::include_graphics(outputPngFileName)
survey_collection_join_sids_all
```

## Map of unique Site IDs with water collection depths
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

survey_collection_join_sids_all_sfdf<-survey_collection_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Water Collection Depths"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_wdepth_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=survey_collection_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=survey_collection_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Water collection depth quantiles
```{r}
#names(survey_collection_join)
quantile(survey_collection_join$water_depth, na.rm=TRUE)
min(survey_collection_join$water_depth, na.rm=TRUE)
max(survey_collection_join$water_depth, na.rm=TRUE)
```

## Water collections where water_depth is greater than 200
```{r}
survey_collection_join %>%
    dplyr::select(survey_date, site_id, general_location_name, water_depth, system_type) %>%
           filter(!if_any(c(water_depth, site_id), is.na) & water_depth>200)
```

## Water collection depth distribution
```{r}
# check distribution
p1<-ggplot(survey_collection_join %>%
           filter(!if_any(c(water_depth, site_id), is.na)),aes(x=as.numeric(water_depth))) + 
  ylab("Density") +
  xlab("Water Collection Depth (M)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

# check distribution
p2<-ggplot(survey_collection_join %>%
           filter(!if_any(c(water_depth, site_id), is.na) & water_depth<200),aes(x=as.numeric(water_depth))) + 
  ylab("Density") +
  xlab("Water Collection Depth (M)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

grid.arrange(p1, p2, nrow=2)
rm(p1,p2)
```


## Water collection by site and month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"

#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Depth, M
#ggplot(survey_collection_join %>%
#         filter(!if_any(c(water_depth, site_id), is.na) & water_depth<200), aes(x=survey_year, y=water_depth, fill=survey_year)) + 
#  geom_boxplot() +
#  xlab("Depth ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()

#plotTitle = "Water collection depth by Site and Month"
#fileName="s123_water_collect_depth_site_month"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=16,width=6, units='in', res=300)
#  Depth, M
#ggplot(survey_collection_join %>%
#         filter(water_depth<200), aes(x=site_id, y=as.numeric(water_depth), fill=site_id)) + 
#  geom_boxplot() +
#  xlab("Depth ()") +
#  xlab("Site ID") +
#  facet_grid(survey_month ~ .) +
#  ggtitle(plotTitle) +
#  theme(plot.title = element_text(hjust = 0.5)) +
#  theme(axis.text.x = element_text(angle=50, hjust=1)) +
#  theme(legend.position = "none") 
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()

#knitr::include_graphics(outputPngFileName)
```

## Water Collection Depth by System
```{r}
plotTitle = "Water Collection Depth by System"
fileName="s123_collect_wdepth_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Depth, M
ggplot(survey_collection_join %>%
         filter(!if_any(c(water_depth, site_id), is.na) & water_depth<100) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=system_type, y=as.numeric(water_depth), fill=system_type)) + 
  geom_boxplot() +
  ylab("Depth (M)") +
  xlab("System") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## Water Collection Depth by Site ID
```{r}
plotTitle = "Water collection depth by Site"
fileName="s123_collect_wdepth_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Depth, M
ggplot(survey_collection_join %>%
         filter(!if_any(c(water_depth, site_id), is.na) & water_depth<100), aes(x=site_id, y=as.numeric(water_depth), fill=site_id)) + 
  geom_boxplot() +
  ylab("Depth ()") +
  xlab("Site ID") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```


# COLLECTIONS: CORE COLLECTION DEPTH

## Percentage of Site IDs with core collection depths
* total cores collected overall, by site id, and by system
```{r}
unique_survey_sids <- unique(survey_sub$site_id)
unique_collect_sids <- unique(survey_collection_join$site_id)
unique_collect_sids_depth <- survey_collection_join %>%
  dplyr::filter(!if_any(c(depth_core_collected, site_id), is.na)) %>%
  dplyr::select(site_id) %>%
  dplyr::distinct()

perc_sids<-(nrow(unique_collect_sids_depth)/length(unique_survey_sids))*100
print(paste0("Percentage of site ids with core collections: ",round(perc_sids,2),"%"))

perc_sids<-(nrow(unique_collect_sids_depth)/length(unique_collect_sids))*100
print(paste0("Percentage of site ids with collection depths: ",round(perc_sids,2),"%"))
```

## Table of unique Site IDs with core collection depths
```{r}
# export table with site ids & names
survey_collection_join_sids <- survey_collection_join %>%
  dplyr::filter(!if_any(c(depth_core_collected, site_id), is.na)) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::select(site_id) %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- survey_collection_join %>% 
  dplyr::filter(!if_any(c(depth_core_collected, site_id), is.na)) %>%
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
survey_collection_join_sids_all <- rbind(sid_other, survey_collection_join_sids, fill=TRUE) 

survey_collection_join_sids_all <- survey_collection_join_sids_all %>% 
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sdepth_sids_table.png"))
png(outputPngFileName, height=25*nrow(survey_collection_join_sids_all), width=500*ncol(survey_collection_join_sids_all))
grid.table(survey_collection_join_sids_all, theme=tt3)
dev.off()

#knitr::include_graphics(outputPngFileName)
survey_collection_join_sids_all
```

## Map of unique Site IDs with core collection depths
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

survey_collection_join_sids_all_sfdf<-survey_collection_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Sediment Collection Depths"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_collect_sdepth_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=survey_collection_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=survey_collection_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```


## Core collection depth distribution
```{r}
#names(survey_collection_join)

quantile(survey_collection_join$depth_core_collected, na.rm=TRUE)
min(survey_collection_join$depth_core_collected, na.rm=TRUE)
max(survey_collection_join$depth_core_collected, na.rm=TRUE)

# check distribution
ggplot(survey_collection_join %>%
           filter(!if_any(c(depth_core_collected, site_id), is.na)),aes(x=as.numeric(depth_core_collected))) + 
  ylab("Density") +
  xlab("Core Collection Depth (M)") +
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") 

```


## Core collection by site and month
```{r}

#plotTitle = "Count of Survey123 records in freezer by type"
#fileName="s123_in_freezer_count_pff"

#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=4,width=6, units='in', res=300)
#  Depth, M
#ggplot(survey_collection_join %>%
#         filter(!if_any(c(depth_core_collected, site_id), is.na)), aes(x=survey_year, y=depth_core_collected, fill=survey_year)) + 
#  geom_boxplot() +
#  xlab("Depth ()") +
#  xlab("Year") +
#  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
#  facet_grid(survey_month ~ .)
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()

#plotTitle = "Sediment collection depth by Site and Month"
#fileName="s123_sediment_collect_depth_site_month"
#outputPngFileName <- paste0(outputPngFolder,fileName,".png")
#png(outputPngFileName,height=16,width=6, units='in', res=300)
#  Depth, M
#ggplot(survey_collection_join %>%
#         filter(!if_any(c(depth_core_collected, site_id), is.na)), aes(x=site_id, y=as.numeric(depth_core_collected), fill=site_id)) + 
#  geom_boxplot() +
#  xlab("Depth ()") +
#  xlab("Site ID") +
#  facet_grid(survey_month ~ .) +
#  ggtitle(plotTitle) +
#  theme(plot.title = element_text(hjust = 0.5)) +
#  theme(axis.text.x = element_text(angle=50, hjust=1)) +
#  theme(legend.position = "none") 
#print(paste("Plot saved as:",outputPngFileName))
#dev.off()

#knitr::include_graphics(outputPngFileName)
```

## Sediment Collection Depth by System
```{r}
plotTitle = "Sediment Collection Depth by System"
fileName="s123_collect_sdepth_system_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Depth, M
ggplot(survey_collection_join %>%
         filter(!if_any(c(depth_core_collected, site_id), is.na)) %>%
         dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))), 
       aes(x=system_type, y=as.numeric(depth_core_collected), fill=system_type)) +
  geom_boxplot() +
  ylab("Depth (M)") +
  xlab("System") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

## Sediment Collection Depth by Site ID
```{r}

plotTitle = "Sediment collection depth by Site"
fileName="s123_collect_sdepth_sids_boxplot"
outputPngFileName <- paste0(outputPngFolder,fileName,".png")
png(outputPngFileName,height=4,width=12, units='in', res=150)
#  Depth, M
ggplot(survey_collection_join %>%
         filter(!if_any(c(depth_core_collected, site_id), is.na)), aes(x=site_id, y=as.numeric(depth_core_collected), fill=site_id)) + 
  geom_boxplot() +
  ylab("Depth ()") +
  xlab("Site ID") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) +
  theme(legend.position = "none") 
print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)

```

# FILTER SUMMARY

## unique site_ids with filters
* total filters per (siteid, system), average filters per (siteid, system) filter type by (siteid, system)
* total cores per (siteid, system), average cores per (siteid, system)
* total cores collected overall, by site id, and by system
* total counts of filter types
* percentage of filters that have been prefiltered

## Count of empty or NA filter_type or filter_labels
```{r}
# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank or NA Site IDs

nrow(clean_filter_join[clean_filter_join$filter_type == "" | is.na(clean_filter_join$filter_type),])
nrow(clean_filter_join[clean_filter_join$filter_label == "" | is.na(clean_filter_join$filter_label),])

```

## Summary of filters per year, month, and season
```{r}

# add seasons to clean_filter_join
clean_filter_join <- clean_filter_join %>% 
  mutate(season = case_when(survey_month==12 | survey_month==1 | survey_month==2 ~ "Winter", 
                            survey_month==3 | survey_month==4 | survey_month==5 ~ "Spring",
                            survey_month==6 | survey_month==7 | survey_month==8 ~ "Summer",
                            survey_month==9 | survey_month==10 | survey_month==11 ~ "Fall")) %>%
  mutate(season_year = paste0(season," ",survey_year))
  
nrow(clean_filter_join)

```


## Percentage of filters that have been prefiltered
```{r}
# total collection_globalid with nitex
# total collection_globalid not nitex
# if they share a collection_globalid, then the collection was prefiltered
names(clean_filter_join)

cids <-clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(collection_GlobalID) %>% 
  dplyr::distinct(collection_GlobalID)


cid_nitex<-clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(collection_GlobalID, filter_type) %>% 
  dplyr::filter(filter_type=="nitex") %>%
  dplyr::distinct(collection_GlobalID) %>%
  dplyr::mutate(filter_type="nitex")

cid_other<-clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(collection_GlobalID, filter_type) %>% 
  dplyr::filter(filter_type!="nitex") %>%
  #dplyr::mutate(filter_type=factor(filter_type, levels= c("nitex", "gff", "supor", "cn", "other"))) %>%
  #dplyr::arrange(filter_type) %>%
  dplyr::distinct(collection_GlobalID) %>%
  dplyr::mutate(filter_type="not_nitex")

nrow(cid_nitex) + nrow(cid_other)

## if there is a count of 2, then there was a prefilter and filter on the same water collection
perc_prefilter<-dplyr::full_join(cid_nitex,cid_other) %>%
  dplyr::group_by(collection_GlobalID) %>%
  dplyr::count(collection_GlobalID) %>%
  dplyr::group_by(n) %>%
  dplyr::count(n) %>%
  dplyr::mutate(perc_prefilter=(nn/nrow(cids))*100)

print(paste0("Percentage of water collections with prefilters & filters: ",round(perc_prefilter$perc_prefilter[perc_prefilter$n==2],2),"%"))
print(paste0("Percentage of water collections with only prefilters or filters (not both): ",round(perc_prefilter$perc_prefilter[perc_prefilter$n==1],2),"%"))


```

## Table of unique Site IDs with filters
```{r}
# export table with site ids & names
clean_filter_join_sids <- clean_filter_join %>%
  dplyr::select(site_id) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- clean_filter_join %>% 
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
clean_filter_join_sids_all <- rbind(sid_other, clean_filter_join_sids, fill=TRUE)

clean_filter_join_sids_all <- clean_filter_join_sids_all %>%
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_all_sids_table.png"))
png(outputPngFileName, height=25*nrow(clean_filter_join_sids_all), width=500*ncol(clean_filter_join_sids_all))
grid.table(clean_filter_join_sids_all, theme=tt3)
dev.off()
#knitr::include_graphics(outputPngFileName)
clean_filter_join_sids_all
```

## Map of unique Site IDs with filters
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

clean_filter_join_sids_all_sfdf<-clean_filter_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Filters"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_all_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=clean_filter_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=clean_filter_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Table of filters per season
```{r}
clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(filter_GlobalID, season) %>% 
  dplyr::group_by(season) %>%
  dplyr::count(season) %>%
  dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) 
```
## Barplot of filters per season
```{r}
plotTitle = "Count of filters by season"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_all_season_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(clean_filter_join %>%
         dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
         filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
         dplyr::select(filter_GlobalID, season) %>% 
         dplyr::group_by(season) %>%
         dplyr::count(season) %>%
         dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)),
       aes(season, n, fill=season)) +
  geom_bar(stat="identity") +
  xlab("Season") +
  ylab("Count") +
  ggtitle(plotTitle) +
  viridis::scale_fill_viridis(discrete = T) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```
## table of filters per season and year
```{r}
clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(filter_GlobalID, season_year) %>% 
  dplyr::group_by(season_year) %>%
  dplyr::count(season_year) %>%
  dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
  tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
  dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))) %>%
  dplyr::arrange(season, year)


clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(filter_GlobalID, season_year) %>% 
  dplyr::group_by(season_year) %>%
  dplyr::count(season_year) %>%
  dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
  tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
  dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))) %>%
  dplyr::arrange(season, year) %>%
  dplyr::group_by(season) %>%
  dplyr::summarize(
    avg_yr_season = mean(n, na.rm = TRUE),
    sd_yr_season = sd(n, na.rm = TRUE)
  )
  
```

## Barplot of filters per season and year
```{r}
plotTitle = "Count of filters by season and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_all_season_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(clean_filter_join %>%
         dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
         filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
         dplyr::select(filter_GlobalID, season_year) %>% 
         dplyr::group_by(season_year) %>%
         dplyr::count(season_year) %>%
         dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
         tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
         dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))),
       aes(season, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Season") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## table of filters per month and year
```{r}
clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(filter_GlobalID, survey_date) %>% 
  dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
  dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
  dplyr::group_by(survey_yrmo) %>%
  dplyr::count(survey_yrmo) %>%
  dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
  tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
  dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
  dplyr::arrange(month, year)

clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(filter_GlobalID, survey_date) %>% 
  dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
  dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
  dplyr::group_by(survey_yrmo) %>%
  dplyr::count(survey_yrmo) %>%
  dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
  tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
  dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
  dplyr::arrange(month, year) %>%
  dplyr::group_by(month) %>%
  dplyr::summarize(
    avg_yr_mo = mean(n, na.rm = TRUE),
    sd_yr_mo = sd(n, na.rm = TRUE)
  )

```
## Barplot of filters per month and year
```{r}
plotTitle = "Count of filters by month and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_all_month_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(clean_filter_join %>%
         dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
         filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
         dplyr::select(filter_GlobalID, survey_date) %>% 
         dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
         dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
         dplyr::group_by(survey_yrmo) %>%
         dplyr::count(survey_yrmo) %>%
         dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
         tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
         dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))),
       aes(month, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Month") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## table of filters per site and year
```{r}
clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(filter_GlobalID, site_id, survey_year) %>% 
  dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
  dplyr::group_by(sid_year) %>%
  dplyr::count(sid_year) %>%
  dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
  tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
  dplyr::arrange(site_id, year)

clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(filter_GlobalID, site_id, survey_year) %>% 
  dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
  dplyr::group_by(sid_year) %>%
  dplyr::count(sid_year) %>%
  dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
  tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
  dplyr::arrange(site_id, year) %>%
  dplyr::group_by(site_id) %>%
  dplyr::summarize(
    avg_yr_sid = mean(n, na.rm = TRUE),
    sd_yr_sid = sd(n, na.rm = TRUE)
  )

```

## Barplot of filters per site and year
```{r}
plotTitle = "Count of filters by site and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_all_sids_year_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)

ggplot(clean_filter_join %>%
         dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
         filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
         dplyr::select(filter_GlobalID, site_id, survey_year) %>% 
         dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
         dplyr::group_by(sid_year) %>%
         dplyr::count(sid_year) %>%
         dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
         tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
         dplyr::arrange(site_id, year),
       aes(site_id, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Site ID") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```
## table of filter types per year
```{r}
clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(filter_GlobalID, filter_type, survey_year) %>% 
  dplyr::mutate(ft_year=paste0(filter_type, " ", survey_year)) %>%
  dplyr::group_by(ft_year) %>%
  dplyr::count(ft_year) %>%
  dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
  tidyr::separate(ft_year, into=c("filter_type","year"),sep=" ") %>%
  dplyr::mutate(filter_type=factor(filter_type, levels= c("nitex", "gff", "supor", "cn", "other"))) %>%
  dplyr::arrange(filter_type, year)
```

## table of filter types where filter type is "other"
```{r}
clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::filter(filter_type=="other") %>%
  dplyr::select(filter_type, filter_type_other, survey_date, projects, site_id, other_site_id, general_location_name, 
                supervisor, username, recorder_first_name, recorder_last_name) %>%
  dplyr::arrange(filter_type_other)

```

## Barplot of filter types per year
```{r}
plotTitle = "Count of filter types by year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_type_year_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)

ggplot(clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(filter_GlobalID, filter_type, survey_year) %>% 
  dplyr::mutate(ft_year=paste0(filter_type, " ", survey_year)) %>%
  dplyr::group_by(ft_year) %>%
  dplyr::count(ft_year) %>%
  dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
  tidyr::separate(ft_year, into=c("filter_type","year"),sep=" ") %>%
  dplyr::mutate(filter_type=factor(filter_type, levels= c("nitex", "gff", "supor", "cn", "other"))) %>%
  dplyr::arrange(filter_type, year),
       aes(filter_type, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Filter Type") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```
## table of filter types per system
```{r}
clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(filter_GlobalID, filter_type, system_type) %>% 
  dplyr::mutate(ft_st=paste0(filter_type, " ", system_type)) %>%
  dplyr::group_by(ft_st) %>%
  dplyr::count(ft_st) %>%
  dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
  tidyr::separate(ft_st, into=c("filter_type","system_type"),sep=" ") %>%
  dplyr::mutate(filter_type=factor(filter_type, levels= c("nitex", "gff", "supor", "cn", "other"))) %>%
  dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))) %>%
  dplyr::arrange(filter_type, system_type)
```

## Barplot of filter types per system
```{r}
plotTitle = "Count of filter types by system"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_filters_type_system_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)

ggplot(clean_filter_join %>%
  dplyr::mutate(filter_type=na_if(filter_type, "")) %>%
  filter(!if_any(c(survey_GlobalID, filter_GlobalID, season, filter_type, filter_label), is.na)) %>%
  dplyr::select(filter_GlobalID, filter_type, system_type) %>% 
  dplyr::mutate(ft_st=paste0(filter_type, " ", system_type)) %>%
  dplyr::group_by(ft_st) %>%
  dplyr::count(ft_st) %>%
  dplyr::mutate(perc=round((n/nrow(clean_filter_join))*100, 2)) %>%
  tidyr::separate(ft_st, into=c("filter_type","system_type"),sep=" ") %>%
  dplyr::mutate(filter_type=factor(filter_type, levels= c("nitex", "gff", "supor", "cn", "other"))) %>%
  dplyr::mutate(system_type=factor(system_type, levels= c("C", "E", "S", "L", "A", "other"))) %>%
  dplyr::arrange(filter_type, system_type),
       aes(system_type, n)) +
  geom_bar(aes(fill=filter_type), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("System") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill="Filter Type")

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

# SUBCORE SUMMARY

* total cores per (siteid, system), average cores per (siteid, system)
* total cores collected overall, by site id, and by system

## Count of empty or NA min_subcore_barcode or max_subcore_barcode
```{r}
names(clean_subcore_join)
# How do you want to treat NA?
# subset the data by the NAs, explore them & their origin
# can we programmatically fix it, or do we have to do it manually?

# 0 rows blank or NA Site IDs

nrow(clean_subcore_join[clean_subcore_join$min_subcore_barcode == "" | is.na(clean_subcore_join$min_subcore_barcode),])
nrow(clean_subcore_join[clean_subcore_join$max_subcore_barcode == "" | is.na(clean_subcore_join$max_subcore_barcode),])

```
## Table of unique Site IDs with subcores
```{r}
clean_subcore_join %>%
  dplyr::filter(site_id=="eLP_L02" | site_id=="ePR_L01") %>%
  dplyr::select()

# export table with site ids & names
clean_subcore_join_sids <- clean_subcore_join %>%
  dplyr::select(site_id) %>%
  dplyr::filter(site_id!="other") %>%
  dplyr::distinct() %>%
  dplyr::left_join(site_ids_sfdf) %>%
  dplyr::select(site_id, general_location_name, projects, region_code, system_type, s123_filter_count, s123_core_count, lon, lat)

sid_other <- clean_subcore_join %>% 
  dplyr::filter(site_id=="other") %>%
  dplyr::filter(lat_manual>0 | long_manual>0) %>%
  dplyr::select(site_id, general_location_name, projects, lat_manual, long_manual) %>%
  dplyr::distinct() %>%
  dplyr::rename(lat=lat_manual) %>%
  dplyr::rename(lon=long_manual)
  
clean_subcore_join_sids_all <- rbind(sid_other, clean_subcore_join_sids, fill=TRUE)

clean_subcore_join_sids_all <- clean_subcore_join_sids_all %>%
  dplyr::arrange(site_id)

outputPngFileName <- file.path(outputPngFolder,paste0("s123_subcores_all_sids_table.png"))
png(outputPngFileName, height=25*nrow(clean_subcore_join_sids_all), width=500*ncol(clean_subcore_join_sids_all))
grid.table(clean_subcore_join_sids_all, theme=tt3)
dev.off()
#knitr::include_graphics(outputPngFileName)
clean_subcore_join_sids_all
```

## Map of unique Site IDs with subcores
```{r}
#WBD_sfdf_tidy <- broom::tidy(WBD_sfdf, region="region_lab")
#ME_coast_sfdf_tidy <- broom::tidy(ME_coast_sfdf)

clean_subcore_join_sids_all_sfdf<-clean_subcore_join_sids_all %>%
  sf::st_as_sf(.,coords=c('lon', 'lat'), crs=WGS84_SRID) %>% # st_as_sf combines fields into geometry field to create sf object
  dplyr::mutate(geom = gsub(geometry, pattern="(\\))|(\\()|c",replacement = "")) %>% # remove geometry characters
  tidyr::separate(geom, into=c("lon","lat"),sep=",") %>%
  dplyr::arrange(site_id)

#names(WBD_sfdf_tidy);names(ME_coast_sfdf_tidy)
plotTitle = "Maine-eDNA Sites with Subcores"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_subcores_all_sids_map.png"))
png(outputPngFileName,height=6,width=9, units='in', res=300)

ggplot() + 
  geom_sf(data=countries_sfdf, color="grey", fill="antiquewhite") +
  geom_sf(data=WBD_sfdf, aes(fill=region_cod), alpha=0.1) +
  geom_sf(data=lakes_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=rivers_sfdf, color="lightblue", fill="lightblue") +
  geom_sf(data=site_ids_sfdf, color="red", alpha=0.5) +
  geom_sf(data=clean_subcore_join_sids_all_sfdf, fill="green",pch=21, color="black", alpha=0.7) +
  geom_text(data=WBD_sfdf, aes(x=lon, y=lat, label=region_cod),
            color="black", fontface="bold", size=2, check_overlap=FALSE) +
  #geom_sf_text(data=clean_subcore_join_sids_all_sfdf, aes(x=lon, y=lat, label=site_id),
  #          color="black", fontface="bold", size=2, check_overlap=FALSE) +
  coord_sf(xlim = c(boundingbox_sids$xmin[[1]]*1.01, boundingbox_sids$xmax[[1]]*0.99), 
           ylim = c(boundingbox_sids$ymin[[1]]*0.99, boundingbox_sids$ymax[[1]]*1.01), expand = FALSE) + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none")

dev.off()
knitr::include_graphics(outputPngFileName)

#rm(WBD_sfdf,ME_coast_sfdf)
```

## Summary of subcores per year, month, and season
```{r}

# add seasons to clean_subcore_join
clean_subcore_join <- clean_subcore_join %>% 
  mutate(season = case_when(survey_month==12 | survey_month==1 | survey_month==2 ~ "Winter", 
                            survey_month==3 | survey_month==4 | survey_month==5 ~ "Spring",
                            survey_month==6 | survey_month==7 | survey_month==8 ~ "Summer",
                            survey_month==9 | survey_month==10 | survey_month==11 ~ "Fall")) %>%
  mutate(season_year = paste0(season," ",survey_year))
  
nrow(clean_subcore_join)

```

## Table of filters per season
```{r}
clean_subcore_join %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season), is.na)) %>%
  dplyr::select(collection_GlobalID, season) %>% 
  dplyr::group_by(season) %>%
  dplyr::count(season) %>%
  dplyr::mutate(perc=round((n/nrow(clean_subcore_join))*100, 2)) 
```
## Barplot of filters per season
```{r}
plotTitle = "Count of subcores by season"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_subcores_all_season_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(clean_subcore_join %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season), is.na)) %>%
  dplyr::select(collection_GlobalID, season) %>% 
  dplyr::group_by(season) %>%
  dplyr::count(season) %>%
  dplyr::mutate(perc=round((n/nrow(clean_subcore_join))*100, 2)) ,
       aes(season, n, fill=season)) +
  geom_bar(stat="identity") +
  xlab("Season") +
  ylab("Count") +
  ggtitle(plotTitle) +
  viridis::scale_fill_viridis(discrete = T) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```
## table of filters per season and year
```{r}
clean_subcore_join %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season), is.na)) %>%
  dplyr::select(collection_GlobalID, season_year) %>% 
  dplyr::group_by(season_year) %>%
  dplyr::count(season_year) %>%
  dplyr::mutate(perc=round((n/nrow(clean_subcore_join))*100, 2)) %>%
  tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
  dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))) %>%
  dplyr::arrange(season, year)


clean_subcore_join %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season), is.na)) %>%
  dplyr::select(collection_GlobalID, season_year) %>% 
  dplyr::group_by(season_year) %>%
  dplyr::count(season_year) %>%
  tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
  dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))) %>%
  dplyr::group_by(season) %>%
  dplyr::summarize(
    avg_yr_season = mean(n, na.rm = TRUE),
    sd_yr_season = sd(n, na.rm = TRUE)
  ) %>%
  dplyr::arrange(season)
  
```

## Barplot of subcores per season and year
```{r}
plotTitle = "Count of subcores by season and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_subcores_all_season_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(clean_subcore_join %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season), is.na)) %>%
  dplyr::select(collection_GlobalID, season_year) %>% 
  dplyr::group_by(season_year) %>%
  dplyr::count(season_year) %>%
  dplyr::mutate(perc=round((n/nrow(clean_subcore_join))*100, 2)) %>%
  tidyr::separate(season_year, into=c("season","year"),sep=" ") %>%
  dplyr::mutate(season=factor(season, levels= c("Winter", "Spring", "Summer", "Fall"))) %>%
  dplyr::arrange(season, year),
       aes(season, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Season") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## table of subcores per month and year
```{r}
clean_subcore_join %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season), is.na)) %>%
  dplyr::select(collection_GlobalID, survey_date) %>% 
  dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
  dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
  dplyr::group_by(survey_yrmo) %>%
  dplyr::count(survey_yrmo) %>%
  dplyr::mutate(perc=round((n/nrow(clean_subcore_join))*100, 2)) %>%
  tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
  dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
  dplyr::arrange(month, year)

clean_subcore_join %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season), is.na)) %>%
  dplyr::select(collection_GlobalID, survey_date) %>% 
  dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
  dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
  dplyr::group_by(survey_yrmo) %>%
  dplyr::count(survey_yrmo) %>%
  dplyr::mutate(perc=round((n/nrow(clean_subcore_join))*100, 2)) %>%
  tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
  dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
  dplyr::group_by(month) %>%
  dplyr::summarize(
    avg_yr_mo = mean(n, na.rm = TRUE),
    sd_yr_mo = sd(n, na.rm = TRUE)
  ) %>%
    dplyr::arrange(month)

```
## Barplot of subcores per month and year
```{r}
plotTitle = "Count of subcores by month and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_subcores_all_month_year_count_barplot.png"))
png(outputPngFileName,height=3,width=6, units='in', res=150)

ggplot(clean_subcore_join %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season), is.na)) %>%
  dplyr::select(collection_GlobalID, survey_date) %>% 
  dplyr::mutate(survey_date = as.Date(survey_date, "%Y-%m-%d")) %>%
  dplyr::mutate(survey_yrmo = format(survey_date, format="%b %Y")) %>%
  dplyr::group_by(survey_yrmo) %>%
  dplyr::count(survey_yrmo) %>%
  dplyr::mutate(perc=round((n/nrow(clean_subcore_join))*100, 2)) %>%
  tidyr::separate(survey_yrmo, into=c("month","year"),sep=" ") %>%
  dplyr::mutate(month=factor(month, levels= c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
  dplyr::arrange(month, year),
       aes(month, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Month") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5))

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```

## table of subcores per site and year
```{r}
clean_subcore_join %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season), is.na)) %>%
  dplyr::select(collection_GlobalID, site_id, survey_year) %>% 
  dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
  dplyr::group_by(sid_year) %>%
  dplyr::count(sid_year) %>%
  dplyr::mutate(perc=round((n/nrow(clean_subcore_join))*100, 2)) %>%
  tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
  dplyr::arrange(site_id, year)

clean_subcore_join %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season), is.na)) %>%
  dplyr::select(collection_GlobalID, site_id, survey_year) %>% 
  dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
  dplyr::group_by(sid_year) %>%
  dplyr::count(sid_year) %>%
  dplyr::mutate(perc=round((n/nrow(clean_subcore_join))*100, 2)) %>%
  tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
  dplyr::group_by(site_id) %>%
  dplyr::summarize(
    avg_yr_sid = mean(n, na.rm = TRUE),
    sd_yr_sid = sd(n, na.rm = TRUE)
  ) %>%
    dplyr::arrange(site_id)

```

## Barplot of subcores per site and year
```{r}
plotTitle = "Count of subcores by site and year"

# save plot in png format
outputPngFileName <- file.path(outputPngFolder,paste0("s123_subcores_all_sids_year_count_barplot.png"))
png(outputPngFileName,height=4,width=12, units='in', res=300)

ggplot(clean_subcore_join %>%
  filter(!if_any(c(survey_GlobalID, collection_GlobalID, season), is.na)) %>%
  dplyr::select(collection_GlobalID, site_id, survey_year) %>% 
  dplyr::mutate(sid_year=paste0(site_id, " ", survey_year)) %>%
  dplyr::group_by(sid_year) %>%
  dplyr::count(sid_year) %>%
  dplyr::mutate(perc=round((n/nrow(clean_subcore_join))*100, 2)) %>%
  tidyr::separate(sid_year, into=c("site_id","year"),sep=" ") %>%
  dplyr::arrange(site_id, year),
       aes(site_id, n)) +
  geom_bar(aes(fill=year), position="stack", stat="identity") +
  viridis::scale_fill_viridis(discrete = T) +
  xlab("Site ID") +
  ylab("Count") +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle=50, hjust=1)) 

print(paste("Plot saved as:",outputPngFileName))
dev.off()

knitr::include_graphics(outputPngFileName)
```


```{r}
# write full join (no clean) to file
#outputFileName = "preclean_prefilter_filter_join"
#outputFile = paste0(outputFolder,outputFileName,".csv")

#if (!file.exists(outputFile) | overwrite) {
#  write.csv(preclean_prefilter_filter_join, outputFile, row.names=FALSE)
#}
```
